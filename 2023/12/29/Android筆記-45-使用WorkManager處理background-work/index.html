<!DOCTYPE html>
<html lang="zh-tw">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 6.3.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16.png">
  <link rel="mask-icon" href="/images/logo2.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">

<link rel="stylesheet" href="https://fonts.loli.net/css?family=Shippori Mincho:300,300italic,400,400italic,700,700italic|Inconsolata:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">
<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">
  <link rel="stylesheet" href="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"linglingdr00.github.io","root":"/","scheme":"Pisces","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":true,"show_result":true,"style":"default"},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":true,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

<link rel="preconnect" href="https://fonts.loli.net">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.loli.net/css2?family=Noto+Serif+TC:wght@500;600;700&family=Shippori+Mincho:wght@500;600;700&display=swap" rel="stylesheet">
  <meta name="description" content="瞭解如何使用 WorkManager 編寫 simple work，然後執行設有限制條件(constraints)的複雜鏈結(chaining) work。  建構項目使用 Blur-O-Matic，該 app 可對照片進行模糊處理，並將處理後的照片保存在檔案中。                                           學習目標  將 WorkManager 添加到您">
<meta property="og:type" content="article">
<meta property="og:title" content="Android筆記(45)-使用WorkManager處理background work">
<meta property="og:url" content="https://linglingdr00.github.io/2023/12/29/Android%E7%AD%86%E8%A8%98-45-%E4%BD%BF%E7%94%A8WorkManager%E8%99%95%E7%90%86background-work/index.html">
<meta property="og:site_name" content="Tina Tang&#39;s Blog">
<meta property="og:description" content="瞭解如何使用 WorkManager 編寫 simple work，然後執行設有限制條件(constraints)的複雜鏈結(chaining) work。  建構項目使用 Blur-O-Matic，該 app 可對照片進行模糊處理，並將處理後的照片保存在檔案中。                                           學習目標  將 WorkManager 添加到您">
<meta property="og:locale" content="zh_TW">
<meta property="og:image" content="https://developer.android.com/static/codelabs/android-workmanager/img/9e4707e0fbdd93c7_1920.png">
<meta property="og:image" content="https://developer.android.com/static/codelabs/android-workmanager/img/f290bdf51724bfd7_1920.png">
<meta property="og:image" content="https://developer.android.com/static/codelabs/android-workmanager/img/9e4707e0fbdd93c7.png?hl=zh-cn">
<meta property="og:image" content="https://developer.android.com/static/codelabs/android-workmanager/img/ed497b57e1f527be.png?hl=zh-cn">
<meta property="og:image" content="https://developer.android.com/static/codelabs/android-workmanager/img/cf10a1af6e84f5ff.png?hl=zh-cn">
<meta property="og:image" content="https://developer.android.com/static/codelabs/android-workmanager/img/e1f61035d680ba03.png?hl=zh-cn">
<meta property="og:image" content="https://developer.android.com/static/codelabs/android-workmanager/img/7e717ffd6b3d9d52.png?hl=zh-cn">
<meta property="og:image" content="https://developer.android.com/static/codelabs/android-workmanager/img/54832b34e9c9884a.png?hl=zh-cn">
<meta property="og:image" content="https://developer.android.com/static/codelabs/android-workmanager/img/4fc29ac70fbecf85.png?hl=zh-cn">
<meta property="og:image" content="https://developer.android.com/static/codelabs/android-workmanager/img/bf3b82eb9fd22349.png?hl=zh-cn">
<meta property="og:image" content="https://developer.android.com/static/codelabs/android-workmanager/img/f0bbaf643c24488f.png">
<meta property="og:image" content="https://developer.android.com/static/codelabs/android-workmanager/img/42a036f4b24adddb.png">
<meta property="og:image" content="https://developer.android.com/static/codelabs/android-workmanager/img/a438421064c385d4.png">
<meta property="og:image" content="https://developer.android.com/static/codelabs/android-workmanager/img/7b70288f69050f0b.png?hl=zh-cn">
<meta property="og:image" content="https://developer.android.com/static/codelabs/android-workmanager/img/5366222d0b4fb705.png">
<meta property="og:image" content="https://developer.android.com/static/codelabs/android-workmanager/img/cd1ecc8b4ca86748.png">
<meta property="og:image" content="https://developer.android.com/static/codelabs/android-workmanager/img/632d75e145022d14_1920.png">
<meta property="og:image" content="https://developer.android.com/static/codelabs/android-workmanager/img/dcb4ccfd261957b1.png">
<meta property="og:image" content="https://developer.android.com/static/codelabs/android-workmanager/img/406ce044ca07169f.png">
<meta property="og:image" content="https://developer.android.com/static/codelabs/android-workmanager/img/302da5ec986ae769.png">
<meta property="article:published_time" content="2023-12-29T06:32:57.000Z">
<meta property="article:modified_time" content="2023-12-30T07:10:57.386Z">
<meta property="article:author" content="Tina Tang">
<meta property="article:tag" content="Android">
<meta property="article:tag" content="Kotlin">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://developer.android.com/static/codelabs/android-workmanager/img/9e4707e0fbdd93c7_1920.png">

<link rel="canonical" href="https://linglingdr00.github.io/2023/12/29/Android%E7%AD%86%E8%A8%98-45-%E4%BD%BF%E7%94%A8WorkManager%E8%99%95%E7%90%86background-work/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-tw'
  };
</script>

  <title>Android筆記(45)-使用WorkManager處理background work | Tina Tang's Blog</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">Tina Tang's Blog</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">在哪裡跌倒了，就在哪裡躺下來</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>About</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>Search
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="Searching..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-tw">
    <link itemprop="mainEntityOfPage" href="https://linglingdr00.github.io/2023/12/29/Android%E7%AD%86%E8%A8%98-45-%E4%BD%BF%E7%94%A8WorkManager%E8%99%95%E7%90%86background-work/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/blog_photo.png">
      <meta itemprop="name" content="Tina Tang">
      <meta itemprop="description" content="^(-o-)>">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Tina Tang's Blog">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          Android筆記(45)-使用WorkManager處理background work
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2023-12-29 14:32:57" itemprop="dateCreated datePublished" datetime="2023-12-29T14:32:57+08:00">2023-12-29</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2023-12-30 15:10:57" itemprop="dateModified" datetime="2023-12-30T15:10:57+08:00">2023-12-30</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Android/" itemprop="url" rel="index"><span itemprop="name">Android</span></a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Android/Android-Kotlin%E5%9F%BA%E6%9C%AC%E6%A6%82%E5%BF%B5%E8%AA%B2%E7%A8%8B/" itemprop="url" rel="index"><span itemprop="name">Android Kotlin基本概念課程</span></a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Android/Android-Kotlin%E5%9F%BA%E6%9C%AC%E6%A6%82%E5%BF%B5%E8%AA%B2%E7%A8%8B/WorkManager/" itemprop="url" rel="index"><span itemprop="name">WorkManager</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <blockquote>
<p>瞭解如何使用 <code>WorkManager</code> 編寫 simple work，然後執行設有<b>限制條件(constraints)</b>的複雜<b>鏈結(chaining)</b> work。</p>
</blockquote>
<p><strong>建構項目</strong><br>使用 Blur-O-Matic，該 app 可對照片進行模糊處理，並將處理後的照片保存在檔案中。</p>
<div style="display: flex;justify-content: center;">
    <div style="width:40%;float:left;margin-right:10px;">
        <img src="https://developer.android.com/static/codelabs/android-workmanager/img/9e4707e0fbdd93c7_1920.png">
    </div>
    <div style="width:40%;float:left;">
        <img src="https://developer.android.com/static/codelabs/android-workmanager/img/f290bdf51724bfd7_1920.png">
    </div>
<div style="clear:both;"></div><!--這是用來清除上方的浮動效果-->
</div>

<p><strong>學習目標</strong></p>
<ul>
<li>將 <code>WorkManager</code> 添加到您的 project 中</li>
<li>安排(scheduling) 一個 simple task</li>
<li>Input 和 output 參數</li>
<li>鏈結(chaining) work</li>
<li>唯一(unique) work</li>
<li>在 UI 中顯示 work status </li>
<li>取消(cancel) work</li>
<li>work 限制條件(constraints)</li>
</ul>
<span id="more"></span>

<h3 id="WorkManager-簡介"><a href="#WorkManager-簡介" class="headerlink" title="WorkManager 簡介"></a>WorkManager 簡介</h3><p>Android 有多個選項用於處理可延遲的後台工作。此 Codelab 中介紹的 <a target="_blank" rel="noopener" href="https://developer.android.com/develop/background-work/background-tasks/persistent?hl=zh-tw">WorkManager</a> 是一種具有<u>向後兼容性(backwards compatible)</u>且簡單靈活的 <strong>library</strong>，用於處理<u>可延遲的<b>後台工作(background work)</b></u>。<strong>WorkManager</strong> 是 Android 平台上推薦用於處理<u>可延遲工作(deferrable work)</u>的 <strong>task scheduler</strong>，能夠保證工作得到執行。</p>
<h4 id="什麽是-WorkManager"><a href="#什麽是-WorkManager" class="headerlink" title="什麽是 WorkManager"></a>什麽是 WorkManager</h4><p>WorkManager 屬於 <a target="_blank" rel="noopener" href="https://developer.android.com/jetpack?hl=zh-tw">Android Jetpack</a> 的一部分，是一種<a target="_blank" rel="noopener" href="https://developer.android.com/topic/architecture?hl=zh-tw">Architecture Component</a>，用於處理既需要機會性執行，又需要有保證的執行的後台工作。<b>機會性執行(Opportunistic execution)</b>意味著 WorkManager 會<u>盡快執行您的後台工作</u>。<b>有保證的執行(Guaranteed execution)</b>意味著 WorkManager 會<u>負責通過邏輯保障在各種情況下啟動您的工作</u>，即使使用者離開您的 app 也無妨。</p>
<p>WorkManager 是一個極其靈活的 library，具有許多其他優勢。這其中包括：</p>
<ul>
<li>支援<b>非同步(asynchronous)</b><u>一次性(one-off)任務</u>和<u>週期性(periodic)任務</u></li>
<li>支持 <u>network conditions</u>、<u>儲存空間</u>和<u>充電狀態</u>等<b>限制(constraints)條件</b></li>
<li>鏈接複雜的 <strong>work requests</strong>，包括<u>並行(parallel)</u> 運行 work</li>
<li>將來自一個 work requests 的 <strong>output</strong> 用作下一個 work requests 的 <strong>input</strong></li>
<li>處理到 API 等級的兼容性，可向後兼容至 API 等級 14</li>
<li>無論是否使用 <strong>Google Play services</strong> 都可以運行</li>
<li>遵循系統健康最佳做法</li>
<li>提供 <code>LiveData</code> 支持，可在 UI 中輕鬆顯示 <strong>work request state</strong></li>
</ul>
<div class="note success">
            <p><strong>注意：</strong>WorkManager 依賴於幾個 API，例如 <a target="_blank" rel="noopener" href="https://developer.android.com/reference/android/app/job/JobScheduler">JobScheduler</a> 和 <a target="_blank" rel="noopener" href="https://developer.android.com/reference/android/app/AlarmManager">AlarmManager</a>。WorkManager 會根據使用者裝置 API 級別等條件選擇使用適合的 API。如需了解詳情，請查看 <a target="_blank" rel="noopener" href="https://developer.android.com/topic/libraries/architecture/workmanager?hl=zh-tw">WorkManager 文件</a>。</p>
          </div>

<h4 id="何時使用-WorkManager"><a href="#何時使用-WorkManager" class="headerlink" title="何時使用 WorkManager"></a>何時使用 WorkManager</h4><p>有些任務，即便使用者離開特定螢幕或您的 app，也需要完成。對於這些任務(tasks)，<strong>WorkManager library</strong> 是不錯的選擇。</p>
<p>以下是一些適合使用 WorkManager 的任務(tasks)的典型範例：</p>
<ul>
<li>上傳(Uploading) logs</li>
<li>對 image 套用濾鏡(filters)並儲存 image</li>
<li>定期將 local data 與 network 同步</li>
</ul>
<p>WorkManager 提供有保證的執行，然而並非所有任務都需要這種保證。因此，它並非運行所有非 main thread 任務(task)的萬全之選。如需詳細了解何時使用 WorkManager，請參閱<a target="_blank" rel="noopener" href="https://developer.android.com/guide/background/?hl=zh-cn">Background 處理指南</a>。</p>
<hr>
<h3 id="準備工作"><a href="#準備工作" class="headerlink" title="準備工作"></a>準備工作</h3><h4 id="第-1-步-下載程式碼"><a href="#第-1-步-下載程式碼" class="headerlink" title="第 1 步 - 下載程式碼"></a>第 1 步 - 下載程式碼</h4><p>從 GitHub clone WorkManager Codelab：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git clone -b start_kotlin https://github.com/googlecodelabs/android-workmanager</span><br></pre></td></tr></table></figure>

<h4 id="第-2-步-執行-app"><a href="#第-2-步-執行-app" class="headerlink" title="第 2 步 - 執行 app"></a>第 2 步 - 執行 app</h4><p>執行 app，您應該會看到下方的畫面。</p>
<img src="https://developer.android.com/static/codelabs/android-workmanager/img/9e4707e0fbdd93c7.png?hl=zh-cn" width="40%">

<p>螢幕上應該會顯示一些 radio buttons，您可以通過這些 button 選擇要對圖片進行什麽程度的模糊處理。按 Go button 即可對圖片進行模糊處理並保存。</p>
<p>截至目前，此 app 不會應用任何模糊處理。</p>
<p>起始程式碼包含以下內容：</p>
<ul>
<li><code>WorkerUtils</code>：這個 class 包含<u>對圖片實際進行模糊處理</u>所需的程式碼，並包含之後您會用於顯示<code>Notifications</code>、<u>將 bitmap 保存到檔案</u>以及<u>減慢 app 運行速度</u>的一些便捷方法。</li>
<li><code>BlurActivity</code>：* 此 <code>activity</code> 用於<u>顯示圖片</u>以及添加用於<u>選擇模糊程度的 radio buttons</u>。</li>
<li><code>BlurViewModel</code>：*此 view model 用於<u>儲存顯示 <code>BlurActivity</code> 所需的所有資料</u>，也將是您<u>使用 <code>WorkManager</code> 啟動後台工作(background work)</u>的 class。</li>
<li><code>Constants</code>：一個靜態(static) class，其中包含您在學習此 Codelab 期間會用到的一些常數(constants)。</li>
<li><code>res/activity_blur.xml</code>：<code>BlurActivity</code> 的 layout 檔案。</li>
</ul>
<p>您將僅在這些檔案中編寫程式碼。</p>
<hr>
<h3 id="將-WorkManager-添加到-app"><a href="#將-WorkManager-添加到-app" class="headerlink" title="將 WorkManager 添加到 app"></a>將 WorkManager 添加到 app</h3><p><code>WorkManager</code> 需要使用以下 Gradle dependency，這些 dependency 已包含在 build 檔案中：</p>
<p><code>app/build.gradle</code></p>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">dependencies</span> &#123;</span><br><span class="line">    <span class="comment">// WorkManager dependency</span></span><br><span class="line">    implementation <span class="string">&quot;androidx.work:work-runtime-ktx:$versions.work&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>您應該在<a target="_blank" rel="noopener" href="https://developer.android.com/jetpack/androidx/releases/work?hl=zh-cn">此處</a>獲取最新穩定版 <code>work-runtime-ktx</code>，並部署正確的版本。</li>
</ul>
<p>目前，最新版本為：</p>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">versions.work = <span class="string">&quot;2.7.1&quot;</span></span><br></pre></td></tr></table></figure>

<hr>
<h3 id="創建-WorkRequest"><a href="#創建-WorkRequest" class="headerlink" title="創建 WorkRequest"></a>創建 WorkRequest</h3><p>在此步驟中，您將接受 <code>res/drawable</code> 資料夾中一張名為 <code>android_cupcake.png</code> 的圖片，並在<u>後台(background)</u>對這張圖片運行一些函數。這些函數會對圖片進行<u>模糊處理</u>，然後將圖片保存到暫存檔案中。</p>
<h4 id="WorkManager-基礎知識"><a href="#WorkManager-基礎知識" class="headerlink" title="WorkManager 基礎知識"></a>WorkManager 基礎知識</h4><p>您需要了解以下幾個 WorkManager class：</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://developer.android.com/reference/androidx/work/Worker"><code>Worker</code></a>：此位置用於放置您希望在<b>後台(background)</b>執行的實際工作的程式碼。您需要<u>繼承</u>此 class 並替換 <a target="_blank" rel="noopener" href="https://developer.android.com/reference/androidx/work/Worker#doWork()"><code>doWork()</code></a> 方法。</li>
<li><a target="_blank" rel="noopener" href="https://developer.android.com/reference/androidx/work/WorkRequest"><code>WorkRequest</code></a>：此 class 表示<u>請求(request)執行某些工作</u>。您將在創建 <code>WorkRequest</code> 的過程中傳入 <code>Worker</code>。在創建 <code>WorkRequest</code> 時，您還可以指定 <a target="_blank" rel="noopener" href="https://developer.android.com/reference/androidx/work/Constraints"><code>Constraints</code></a> 等內容，例如運行 <code>Worker</code> 的時間。</li>
<li><a target="_blank" rel="noopener" href="https://developer.android.com/reference/androidx/work/WorkManager"><code>WorkManager</code></a>：這個 class 實質上可以安排(schedules)您的 <code>WorkRequest</code> 並使其運行。它以<u>分散<b>系統資源(system resources)</b>負載(load)</u>的方式安排(schedules) <code>WorkRequest</code>，同時遵守您指定的<u>限制條件(constraints)</u>。</li>
</ul>
<p>在這種情況下，您將定義新的 <code>BlurWorker</code>，其中包含用於對圖片進行模糊處理的程式碼。點擊 Go button 時，系統會創建一個 <code>WorkRequest</code>，然後通過 <code>WorkManager</code> 將其加入<b>隊列(enqueued)</b>。</p>
<h4 id="第-1-步-創建-BlurWorker"><a href="#第-1-步-創建-BlurWorker" class="headerlink" title="第 1 步 - 創建 BlurWorker"></a>第 1 步 - 創建 BlurWorker</h4><p>在 <code>workers</code> package 中，新建一個名為 <code>BlurWorker</code> 的 Kotlin class。</p>
<h4 id="第-2-步-新增-constructor"><a href="#第-2-步-新增-constructor" class="headerlink" title="第 2 步 - 新增 constructor"></a>第 2 步 - 新增 constructor</h4><p>向 <code>BlurWorker</code> class 新增對 <code>Worker</code> 的 dependency：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">BlurWorker</span>(ctx: Context, params: WorkerParameters) : Worker(ctx, params) &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="第-3-步-覆寫並實作-doWork"><a href="#第-3-步-覆寫並實作-doWork" class="headerlink" title="第 3 步 - 覆寫並實作 doWork()"></a>第 3 步 - 覆寫並實作 doWork()</h4><p><code>Worker</code> 會對所顯示的 cupcake image 進行模糊處理。</p>
<p>為了更好地了解何時執行工作，您將使用 <code>WorkerUtil</code> 的 <code>makeStatusNotification()</code>。使用此方法，您可以輕松地在螢幕頂部顯示 <strong>notification banner</strong>。</p>
<p>替換 <code>doWork()</code> 方法，然後執行以下操作。您可以參考本部分末尾完成後的程式碼：</p>
<ol>
<li>通過呼叫 <code>applicationContext</code> 屬性獲取 <code>Context</code>。將其分配給名為 <code>appContext</code> 的新 <code>val</code>。您接下來要執行的各種 bitmap 處理需要用到此參數。</li>
<li>使用函數 <code>makeStatusNotification</code> 顯示<b>狀態通知(status notification)</b>，以向使用者發送有關對圖片進行模糊處理的<u>通知(notify)</u>。</li>
<li>利用 cupcake image 創建一個 <code>Bitmap</code>：</li>
</ol>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> picture = BitmapFactory.decodeResource(</span><br><span class="line">        appContext.resources,</span><br><span class="line">        R.drawable.android_cupcake)</span><br></pre></td></tr></table></figure>

<ol start="4">
<li>通過從 <code>WorkerUtils</code> 呼叫 <code>blurBitmap</code> 方法，獲取此 bitmap 模糊處理後的版本。</li>
<li>從 <code>WorkerUtils</code> 呼叫 <code>writeBitmapToFile</code> 方法，將該 bitmap 寫入暫存檔案。請務必將 return 的 <strong>URI</strong> 保存到 <strong>local variable</strong>。</li>
<li>從 <code>WorkerUtils</code> 呼叫 <code>makeStatusNotification</code> 方法，以創建顯示 URI 的通知(notification)。</li>
<li>Return <code>Result.success()</code>。</li>
<li>將步驟 3-6 中的程式碼包裝在 <code>try/catch</code> statement 中。Catch 一個通用的(generic) <code>Throwable</code>。</li>
<li>在 <code>catch</code> statement 中，使用 Log statement <code>Log.e(TAG, &quot;Error applying blur&quot;)</code> 輸出error message 。</li>
<li>然後在 <code>catch</code> statement 中 return <code>Result.failure()</code>。</li>
</ol>
<p>此步驟的完整程式碼如下所示。</p>
<p><code>BlurWorker.kt</code></p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.background.workers</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> android.content.Context</span><br><span class="line"><span class="keyword">import</span> android.graphics.BitmapFactory</span><br><span class="line"><span class="keyword">import</span> android.util.Log</span><br><span class="line"><span class="keyword">import</span> androidx.work.Worker</span><br><span class="line"><span class="keyword">import</span> androidx.work.WorkerParameters</span><br><span class="line"><span class="keyword">import</span> com.example.background.R</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">const</span> <span class="keyword">val</span> TAG = <span class="string">&quot;BlurWorker&quot;</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">BlurWorker</span>(ctx: Context, params: WorkerParameters) : Worker(ctx, params) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">doWork</span><span class="params">()</span></span>: Result &#123;</span><br><span class="line">        <span class="keyword">val</span> appContext = applicationContext</span><br><span class="line"></span><br><span class="line">        makeStatusNotification(<span class="string">&quot;Blurring image&quot;</span>, appContext)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">val</span> picture = BitmapFactory.decodeResource(</span><br><span class="line">                    appContext.resources,</span><br><span class="line">                    R.drawable.android_cupcake)</span><br><span class="line"></span><br><span class="line">            <span class="keyword">val</span> output = blurBitmap(picture, appContext)</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Write bitmap to a temp file</span></span><br><span class="line">            <span class="keyword">val</span> outputUri = writeBitmapToFile(appContext, output)</span><br><span class="line"></span><br><span class="line">            makeStatusNotification(<span class="string">&quot;Output is <span class="variable">$outputUri</span>&quot;</span>, appContext)</span><br><span class="line"></span><br><span class="line">            Result.success()</span><br><span class="line">        &#125; <span class="keyword">catch</span> (throwable: Throwable) &#123;</span><br><span class="line">            Log.e(TAG, <span class="string">&quot;Error applying blur&quot;</span>)</span><br><span class="line">            Result.failure()</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="第-4-步-在-ViewModel-中獲取-WorkManager"><a href="#第-4-步-在-ViewModel-中獲取-WorkManager" class="headerlink" title="第 4 步 - 在 ViewModel 中獲取 WorkManager"></a>第 4 步 - 在 ViewModel 中獲取 WorkManager</h4><p>在 <code>ViewModel</code> 中為 <code>WorkManager</code> instance 創建 class variable：</p>
<p><code>BlurViewModel.kt</code></p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">val</span> workManager = WorkManager.getInstance(application)</span><br></pre></td></tr></table></figure>

<h4 id="第-5-步-在-WorkManager-中將-WorkRequest-加入-enqueue"><a href="#第-5-步-在-WorkManager-中將-WorkRequest-加入-enqueue" class="headerlink" title="第 5 步 - 在 WorkManager 中將 WorkRequest 加入 enqueue"></a>第 5 步 - 在 WorkManager 中將 WorkRequest 加入 enqueue</h4><p>好吧，是時候發出 <code>WorkRequest</code> 並告訴 <code>WorkManager</code> 要運行它了。</p>
<p><code>WorkRequest</code> 有兩種類型(types)：</p>
<ul>
<li><code>OneTimeWorkRequest</code>：只會執行一次的 <code>WorkRequest</code>。</li>
<li><code>PeriodicWorkRequest</code>：按周期(循環)重覆執行的 <code>WorkRequest</code>。</li>
</ul>
<p>我們只希望在點擊 <strong>Go button</strong> 後對圖片進行<u>模糊處理(blurred)</u>。當使使用者點擊 Go button 時，系統會呼叫 <code>applyBlur</code> 方法，因此請通過 <code>BlurWorker</code> 創建 <code>OneTimeWorkRequest</code>。然後，使用 <code>WorkManager</code> instance 將您的 <code>WorkRequest</code> 加入<b>隊列(enqueue)</b>。</p>
<p>將以下程式碼行添加到 <code>BlurViewModel</code> 的 <code>applyBlur()</code> 方法中：</p>
<p><code>BlurViewModel.kt</code></p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">internal</span> <span class="function"><span class="keyword">fun</span> <span class="title">applyBlur</span><span class="params">(blurLevel: <span class="type">Int</span>)</span></span> &#123;</span><br><span class="line">   workManager.enqueue(OneTimeWorkRequest.from(BlurWorker::<span class="keyword">class</span>.java))</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="第-6-步-運行您的程式碼！"><a href="#第-6-步-運行您的程式碼！" class="headerlink" title="第 6 步 - 運行您的程式碼！"></a>第 6 步 - 運行您的程式碼！</h4><p>運行您的程式碼。此程式碼應進行編譯，並且在按下 Go button 時，您應該會看到<b>通知(Notification)</b>。請注意，如需查看更模糊的照片，您應該選擇 “More blurred”（更模糊）或 “The most blurred”（最模糊）選項。</p>
<img src="https://developer.android.com/static/codelabs/android-workmanager/img/ed497b57e1f527be.png?hl=zh-cn">

<p>如需確認圖片是否已成功模糊，您可以在 Android Studio 中打開 <a target="_blank" rel="noopener" href="https://developer.android.com/studio/debug/device-file-explorer?hl=zh-tw">Device File Explorer</a>：</p>
<img src="https://developer.android.com/static/codelabs/android-workmanager/img/cf10a1af6e84f5ff.png?hl=zh-cn" width="80%">

<p>然後依次轉到 data &gt; data &gt; <code>com.example.background</code> &gt; files &gt; <code>Blathfilterfilter_outputs</code> &gt; <code>&lt;URI&gt;</code>，並確認 cupcake 確實已經模糊：</p>
<img src="https://developer.android.com/static/codelabs/android-workmanager/img/e1f61035d680ba03.png?hl=zh-cn">

<hr>
<h3 id="新增-input-和-output"><a href="#新增-input-和-output" class="headerlink" title="新增 input 和 output"></a>新增 input 和 output</h3><p>對資源目錄中的圖片資源進行模糊處理固然不錯，但如果想讓 O-M-Matic 真正成為一款革命性的圖片編輯應用，您應該讓使用者模糊處理他們在螢幕上看到的圖片，然後向他們展示經過模糊處理的照片。</p>
<p>為實現此目標，我們將提供作為 input 顯示在 <code>WorkRequest</code> 中的紙杯蛋糕圖片的 <strong>URI</strong>，然後使用 <code>WorkRequest</code> 的 output 顯示最終的經過模糊處理的圖片。</p>
<h4 id="第-1-步-創建資料-input-object"><a href="#第-1-步-創建資料-input-object" class="headerlink" title="第 1 步 - 創建資料 input object"></a>第 1 步 - 創建資料 input object</h4><p>Input 和 output 通過 <a target="_blank" rel="noopener" href="https://developer.android.com/reference/androidx/work/Data">Data</a> object 傳入和傳出。<code>Data</code> object 是輕量化的 key-value 組合 containers。它們用於儲存少量可從 <code>WorkRequest</code> 傳入和傳出的資料。</p>
<p>您需要將使用者圖片的 URI 傳入捆綁包中。該 URI 儲存在名為 <code>imageUri</code> 的 variable 中。</p>
<p>在 <code>BlurViewModel</code> 中，創建一個名為 <code>createInputDataForUri</code> 的 private 方法。該方法應執行以下操作：</p>
<ol>
<li>創建一個 <code>Data.Builder</code> object。在收到 <strong>request</strong> 時，import <code>androidx.work.Data</code>。</li>
<li>如果 <code>imageUri</code> 是非 null <code>URI</code>，則使用 <code>putString</code> 方法將其添加到 <code>Data</code> object。該方法可獲取一個 <strong>key</strong> 和一個 <strong>value</strong>。您可以使用 <code>Constants</code> class 中的 <code>String</code> constant <code>KEY_IMAGE_URI</code>。</li>
<li>對 <code>Data.Builder</code> object 呼叫 <code>build()</code> 以創建 <code>Data</code> object 並 return。</li>
</ol>
<p>下面是完整的 <code>createInputDataForUri</code> 方法：</p>
<p><code>BlurViewModel.kt</code></p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Creates the input data bundle which includes the Uri to operate on</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> Data which contains the Image Uri as a String</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">fun</span> <span class="title">createInputDataForUri</span><span class="params">()</span></span>: Data &#123;</span><br><span class="line">    <span class="keyword">val</span> builder = Data.Builder()</span><br><span class="line">    imageUri?.let &#123;</span><br><span class="line">        builder.putString(KEY_IMAGE_URI, imageUri.toString())</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> builder.build()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="第-2-步-將-Data-object-傳遞到-WorkRequest"><a href="#第-2-步-將-Data-object-傳遞到-WorkRequest" class="headerlink" title="第 2 步 - 將 Data object 傳遞到 WorkRequest"></a>第 2 步 - 將 Data object 傳遞到 WorkRequest</h4><p>您將更改 <code>BlurViewModel</code> 中的 <code>applyBlur</code> 方法，以便：</p>
<ol>
<li>創建新的 <code>OneTimeWorkRequestBuilder</code>。</li>
<li>呼叫 <code>setInputData</code>，傳入 <code>createInputDataForUri</code> 的結果。</li>
<li>構建(Builds) <code>OneTimeWorkRequest</code>。</li>
<li>使用 <code>WorkManager</code> 將 <strong>work request</strong> 加入<b>隊列(enqueues)</b>，以便系統將可以按照預期運行工作(scheduled to run)。</li>
</ol>
<p>下面是完整的 <code>applyBlur</code> 方法：</p>
<p><code>BlurViewModel.kt</code></p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">internal</span> <span class="function"><span class="keyword">fun</span> <span class="title">applyBlur</span><span class="params">(blurLevel: <span class="type">Int</span>)</span></span> &#123;</span><br><span class="line">    <span class="keyword">val</span> blurRequest = OneTimeWorkRequestBuilder&lt;BlurWorker&gt;()</span><br><span class="line">            .setInputData(createInputDataForUri())</span><br><span class="line">            .build()</span><br><span class="line"></span><br><span class="line">    workManager.enqueue(blurRequest)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="第-3-步-更新-BlurWorker-的-doWork-以獲取-input"><a href="#第-3-步-更新-BlurWorker-的-doWork-以獲取-input" class="headerlink" title="第 3 步 - 更新 BlurWorker 的 doWork() 以獲取 input"></a>第 3 步 - 更新 BlurWorker 的 doWork() 以獲取 input</h4><p>現在，請更新 <code>BlurWorker</code> 的 <code>doWork()</code> 方法，以獲取從 <code>Data</code> object 傳入的 <strong>URI</strong>：</p>
<p><code>BlurWorker.kt</code></p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">doWork</span><span class="params">()</span></span>: Result &#123;</span><br><span class="line">    <span class="keyword">val</span> appContext = applicationContext</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ADD THIS LINE</span></span><br><span class="line">    <span class="keyword">val</span> resourceUri = inputData.getString(KEY_IMAGE_URI)</span><br><span class="line">    <span class="comment">// ... rest of doWork()</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="第-4-步-對給定的-URI-進行模糊處理"><a href="#第-4-步-對給定的-URI-進行模糊處理" class="headerlink" title="第 4 步 - 對給定的 URI 進行模糊處理"></a>第 4 步 - 對給定的 URI 進行模糊處理</h4><p>有了此 <strong>URI</strong>，我們現在對螢幕上的 cupcake image 進行模糊處理(blur)。</p>
<ol>
<li><p>移除之前用於獲取圖片資源的程式碼。</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> picture = BitmapFactory.decodeResource(appContext.resources, R.drawable.android_cupcake)</span><br></pre></td></tr></table></figure>
</li>
<li><p>檢查從傳入的 <code>Data</code> 中獲取的 <code>resourceUri</code> 不為空(empty)。</p>
</li>
<li><p>將 <code>picture</code> variable 指派(assign)給傳入的圖片，如下所示：</p>
</li>
</ol>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> resolver = appContext.contentResolver</span><br></pre></td></tr></table></figure>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> picture = BitmapFactory.decodeStream(</span><br><span class="line">        resolver.openInputStream(Uri.parse(resourceUri)))</span><br></pre></td></tr></table></figure>

<p><code>BlurWorker.kt</code></p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">doWork</span><span class="params">()</span></span>: Result &#123;</span><br><span class="line">    <span class="keyword">val</span> appContext = applicationContext</span><br><span class="line"></span><br><span class="line">    <span class="keyword">val</span> resourceUri = inputData.getString(KEY_IMAGE_URI)</span><br><span class="line"></span><br><span class="line">    makeStatusNotification(<span class="string">&quot;Blurring image&quot;</span>, appContext)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// REMOVE THIS</span></span><br><span class="line">        <span class="comment">//    val picture = BitmapFactory.decodeResource(</span></span><br><span class="line">        <span class="comment">//            appContext.resources,</span></span><br><span class="line">        <span class="comment">//            R.drawable.android_cupcake)</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (TextUtils.isEmpty(resourceUri)) &#123;</span><br><span class="line">            Log.e(TAG, <span class="string">&quot;Invalid input uri&quot;</span>)</span><br><span class="line">            <span class="keyword">throw</span> IllegalArgumentException(<span class="string">&quot;Invalid input uri&quot;</span>)</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">val</span> resolver = appContext.contentResolver</span><br><span class="line"></span><br><span class="line">        <span class="keyword">val</span> picture = BitmapFactory.decodeStream(</span><br><span class="line">                resolver.openInputStream(Uri.parse(resourceUri)))</span><br><span class="line"></span><br><span class="line">        <span class="keyword">val</span> output = blurBitmap(picture, appContext)</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Write bitmap to a temp file</span></span><br><span class="line">        <span class="keyword">val</span> outputUri = writeBitmapToFile(appContext, output)</span><br><span class="line"></span><br><span class="line">        Result.success()</span><br><span class="line">    &#125; <span class="keyword">catch</span> (throwable: Throwable) &#123;</span><br><span class="line">        Log.e(TAG, <span class="string">&quot;Error applying blur&quot;</span>)</span><br><span class="line">        throwable.printStackTrace()</span><br><span class="line">        Result.failure()</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="第-5-步-Output-temporary-URI"><a href="#第-5-步-Output-temporary-URI" class="headerlink" title="第 5 步 - Output temporary URI"></a>第 5 步 - Output temporary URI</h4><p>此 Worker 的工作已完成，您可以在 <code>Result.success()</code> 中 return <strong>output URI</strong>。提供 <strong>Output URI</strong> 作為 output Data，使其他 Worker 可以輕鬆存取這張臨時圖片，以執行進一步操作。<br>在下一章中，您將創建<b>工作鏈(Chain of workers)</b>，屆時此操作將非常有幫助。具體操作步驟如下：</p>
<ol>
<li>像對 input 進行的操作一樣，創建新的 <code>Data</code>，並將 <code>outputUri</code> 儲存為 <code>String</code>。使用相同的 <strong>key</strong>，即 <code>KEY_IMAGE_URI</code>。</li>
<li>使用 <code>Result.success(Data outputData)</code> 方法將它 return 給 <code>WorkManager</code>。</li>
</ol>
<p><code>BlurWorker.kt</code><br>將 <code>doWork()</code> 中的 <code>Result.success()</code> 行修改為：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> outputData = workDataOf(KEY_IMAGE_URI to outputUri.toString())</span><br><span class="line"></span><br><span class="line">Result.success(outputData)</span><br></pre></td></tr></table></figure>

<h4 id="第-6-步-執行您的-app"><a href="#第-6-步-執行您的-app" class="headerlink" title="第 6 步 - 執行您的 app"></a>第 6 步 - 執行您的 app</h4><p>此時，您應該執行 app。它應會編譯並具有相同的行為，您可以透過 <strong>Device File Explorer</strong> 看到模糊的圖片，但尚未在螢幕上看到。</p>
<p>如需檢查是否存在其他經過模糊處理的圖片，您可以在 Android Studio 中打開 <strong>Device File Explorer</strong>，然後轉到 <code>data/data/com.example.background/files/blur_filter_outputs/&lt;URI&gt;</code>，就像上一步的操作一樣。</p>
<p>請注意，您可能需要點擊 <strong>Synchronize</strong>（同步）才能查看圖片：</p>
<img src="https://developer.android.com/static/codelabs/android-workmanager/img/7e717ffd6b3d9d52.png?hl=zh-cn" width="50%">

<p>太棒了！您已使用 <code>WorkManager</code> 對 input image 進行模糊處理！</p>
<hr>
<h3 id="鏈結您的工作-Chain-your-work"><a href="#鏈結您的工作-Chain-your-work" class="headerlink" title="鏈結您的工作(Chain your work)"></a>鏈結您的工作(Chain your work)</h3><p>現在，您將執行一項 work task：對圖片進行模糊處理。這是非常不錯的第一步，但缺少一些核心功能：</p>
<ul>
<li>此操作不會清理<u>暫存檔案(temporary files)</u>。</li>
<li>實際上，它不會將圖片保存到<u>永久性檔案(permanent file)</u>中。</li>
<li>始終對圖片做相同程度的<u>模糊處理(blurs)</u>。<br>我們將使用 <code>WorkManager</code> 工作鏈添加此功能。</li>
</ul>
<p><code>WorkManager</code> 允許您創建<u>按順序(in order)</u>執行或<u>並行(parallel)</u>執行的單獨(separate) <code>WorkerRequest</code>。在此步驟中，您將創建一個如下所示的<b>工作鏈(chain of work)</b>：</p>
<img src="https://developer.android.com/static/codelabs/android-workmanager/img/54832b34e9c9884a.png?hl=zh-cn">

<p><code>WorkRequest</code> 表示為方框。</p>
<p>鏈接(chaining)的另一個簡潔功能是，一個 <code>WorkRequest</code> 的 output 會成為鏈(chain)中下一個 <code>WorkRequest</code> 的 input。在每個 <code>WorkRequest</code> 之間傳遞的 input 和 output 均顯示為 blue text。</p>
<h4 id="第-1-步-創建-Cleanup-和-Save-Workers"><a href="#第-1-步-創建-Cleanup-和-Save-Workers" class="headerlink" title="第 1 步 - 創建 Cleanup 和 Save Workers"></a>第 1 步 - 創建 Cleanup 和 Save Workers</h4><p>首先，您需要定義所需的所有 <code>Worker</code> class。您已經有了用於對圖片進行模糊處理的 <code>Worker</code>，但還需要用於清理<u>暫存檔案(temp files)</u>的 <code>Worker</code> 以及用於永久保存圖片的 <code>Worker</code>。</p>
<p>請在 <code>workers</code> package 中創建兩個繼承 <code>Worker</code> 的新 class。<br>第一個 class 的名稱應為 <code>CleanupWorker</code>，第二個 class 的名稱應為 <code>SaveImageToFileWorker</code>。</p>
<h4 id="第-2-步-繼承-Worker"><a href="#第-2-步-繼承-Worker" class="headerlink" title="第 2 步 - 繼承 Worker"></a>第 2 步 - 繼承 Worker</h4><p>從 <code>Worker</code> class 繼承 <code>CleanupWorker</code> class。添加所需的 constructor 參數。</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">CleanupWorker</span>(ctx: Context, params: WorkerParameters) : Worker(ctx, params) &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="第-3-步-覆寫和實作-doWork-以用於-CleanupWorker"><a href="#第-3-步-覆寫和實作-doWork-以用於-CleanupWorker" class="headerlink" title="第 3 步 - 覆寫和實作 doWork() 以用於 CleanupWorker"></a>第 3 步 - 覆寫和實作 doWork() 以用於 CleanupWorker</h4><p><code>CleanupWorker</code> 不需要獲取任何 input 或傳遞任何 ouput。它只是刪除暫存檔案(temporary files)（如果存在）。由於檔案操作不在本 Codelab 的範圍之內，因此您可以複製 <code>CleanupWorker</code> 的程式碼，如下所示：</p>
<p><code>CleanupWorker.kt</code></p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.background.workers</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> android.content.Context</span><br><span class="line"><span class="keyword">import</span> android.util.Log</span><br><span class="line"><span class="keyword">import</span> androidx.work.Worker</span><br><span class="line"><span class="keyword">import</span> androidx.work.WorkerParameters</span><br><span class="line"><span class="keyword">import</span> com.example.background.OUTPUT_PATH</span><br><span class="line"><span class="keyword">import</span> java.io.File</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Cleans up temporary files generated during blurring process</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">const</span> <span class="keyword">val</span> TAG = <span class="string">&quot;CleanupWorker&quot;</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">CleanupWorker</span>(ctx: Context, params: WorkerParameters) : Worker(ctx, params) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">doWork</span><span class="params">()</span></span>: Result &#123;</span><br><span class="line">        <span class="comment">// Makes a notification when the work starts and slows down the work so that</span></span><br><span class="line">        <span class="comment">// it&#x27;s easier to see each WorkRequest start, even on emulated devices</span></span><br><span class="line">        makeStatusNotification(<span class="string">&quot;Cleaning up old temporary files&quot;</span>, applicationContext)</span><br><span class="line">        sleep()</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">val</span> outputDirectory = File(applicationContext.filesDir, OUTPUT_PATH)</span><br><span class="line">            <span class="keyword">if</span> (outputDirectory.exists()) &#123;</span><br><span class="line">                <span class="keyword">val</span> entries = outputDirectory.listFiles()</span><br><span class="line">                <span class="keyword">if</span> (entries != <span class="literal">null</span>) &#123;</span><br><span class="line">                    <span class="keyword">for</span> (entry <span class="keyword">in</span> entries) &#123;</span><br><span class="line">                        <span class="keyword">val</span> name = entry.name</span><br><span class="line">                        <span class="keyword">if</span> (name.isNotEmpty() &amp;&amp; name.endsWith(<span class="string">&quot;.png&quot;</span>)) &#123;</span><br><span class="line">                            <span class="keyword">val</span> deleted = entry.delete()</span><br><span class="line">                            Log.i(TAG, <span class="string">&quot;Deleted <span class="variable">$name</span> - <span class="variable">$deleted</span>&quot;</span>)</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            Result.success()</span><br><span class="line">        &#125; <span class="keyword">catch</span> (exception: Exception) &#123;</span><br><span class="line">            exception.printStackTrace()</span><br><span class="line">            Result.failure()</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="第-4-步-覆寫和實作-doWork-以用於-SaveImageToFileWorker"><a href="#第-4-步-覆寫和實作-doWork-以用於-SaveImageToFileWorker" class="headerlink" title="第 4 步 - 覆寫和實作 doWork() 以用於 SaveImageToFileWorker"></a>第 4 步 - 覆寫和實作 doWork() 以用於 SaveImageToFileWorker</h4><p><code>SaveImageToFileWorker</code> 將獲取 input 和 output。Input 是使用 key <code>KEY_IMAGE_URI</code> 儲存的 <code>String</code>，即暫時模糊處理的圖片 URI(<b>temporarily blurred image URI</b>)，而 output 也將是使用 key <code>KEY_IMAGE_URI</code> 儲存的 <code>String</code>，即保存的模糊處理圖片的 URI(<b>saved blurred image stored URI</b>)。</p>
<img src="https://developer.android.com/static/codelabs/android-workmanager/img/4fc29ac70fbecf85.png?hl=zh-cn" width="50%">

<p>此 Codelab 不涉及檔案處理，因此我們在下面提供了程式碼。請注意，系統會使用 key <code>KEY_IMAGE_URI</code> 檢索 <code>resourceUri</code> 和 <code>output</code> 值。該程式碼與您在最後一步中為 input 和 output 編寫的程式碼非常相似（它使用了全部相同的 key）。</p>
<p><code>SaveImageToFileWorker.kt</code></p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.background.workers</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> android.content.Context</span><br><span class="line"><span class="keyword">import</span> android.graphics.BitmapFactory</span><br><span class="line"><span class="keyword">import</span> android.net.Uri</span><br><span class="line"><span class="keyword">import</span> android.provider.MediaStore</span><br><span class="line"><span class="keyword">import</span> android.util.Log</span><br><span class="line"><span class="keyword">import</span> androidx.work.workDataOf</span><br><span class="line"><span class="keyword">import</span> androidx.work.Worker</span><br><span class="line"><span class="keyword">import</span> androidx.work.WorkerParameters</span><br><span class="line"><span class="keyword">import</span> com.example.background.KEY_IMAGE_URI</span><br><span class="line"><span class="keyword">import</span> java.text.SimpleDateFormat</span><br><span class="line"><span class="keyword">import</span> java.util.Date</span><br><span class="line"><span class="keyword">import</span> java.util.Locale</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Saves the image to a permanent file</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">const</span> <span class="keyword">val</span> TAG = <span class="string">&quot;SaveImageToFileWorker&quot;</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">SaveImageToFileWorker</span>(ctx: Context, params: WorkerParameters) : Worker(ctx, params) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> title = <span class="string">&quot;Blurred Image&quot;</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> dateFormatter = SimpleDateFormat(</span><br><span class="line">            <span class="string">&quot;yyyy.MM.dd &#x27;at&#x27; HH:mm:ss z&quot;</span>,</span><br><span class="line">            Locale.getDefault()</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">doWork</span><span class="params">()</span></span>: Result &#123;</span><br><span class="line">        <span class="comment">// Makes a notification when the work starts and slows down the work so that</span></span><br><span class="line">        <span class="comment">// it&#x27;s easier to see each WorkRequest start, even on emulated devices</span></span><br><span class="line">        makeStatusNotification(<span class="string">&quot;Saving image&quot;</span>, applicationContext)</span><br><span class="line">        sleep()</span><br><span class="line"></span><br><span class="line">        <span class="keyword">val</span> resolver = applicationContext.contentResolver</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">val</span> resourceUri = inputData.getString(KEY_IMAGE_URI)</span><br><span class="line">            <span class="keyword">val</span> bitmap = BitmapFactory.decodeStream(</span><br><span class="line">                    resolver.openInputStream(Uri.parse(resourceUri)))</span><br><span class="line">            <span class="keyword">val</span> imageUrl = MediaStore.Images.Media.insertImage(</span><br><span class="line">                    resolver, bitmap, title, dateFormatter.format(Date()))</span><br><span class="line">            <span class="keyword">if</span> (!imageUrl.isNullOrEmpty()) &#123;</span><br><span class="line">                <span class="keyword">val</span> output = workDataOf(KEY_IMAGE_URI to imageUrl)</span><br><span class="line"></span><br><span class="line">                Result.success(output)</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                Log.e(TAG, <span class="string">&quot;Writing to MediaStore failed&quot;</span>)</span><br><span class="line">                Result.failure()</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (exception: Exception) &#123;</span><br><span class="line">            exception.printStackTrace()</span><br><span class="line">            Result.failure()</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="第-5-步-修改-BlurWorker-Notification"><a href="#第-5-步-修改-BlurWorker-Notification" class="headerlink" title="第 5 步 - 修改 BlurWorker Notification"></a>第 5 步 - 修改 BlurWorker Notification</h4><p>現在，我們有了用於將圖片保存到正確資料夾的 <code>Worker</code> 鏈(chain)，我們可以使用 <code>WorkerUtils</code> class 中定義的 <code>sleep()</code> 方法減慢工作(work)速度，以便更輕松地做到查看每個 <code>WorkRequest</code> 的啟動情況，即使在模擬器上也不例外。<code>BlurWorker</code> 的最終版本如下所示：</p>
<p><code>BlurWorker.kt</code></p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">BlurWorker</span>(ctx: Context, params: WorkerParameters) : Worker(ctx, params) &#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">doWork</span><span class="params">()</span></span>: Result &#123;</span><br><span class="line">    <span class="keyword">val</span> appContext = applicationContext</span><br><span class="line"></span><br><span class="line">    <span class="keyword">val</span> resourceUri = inputData.getString(KEY_IMAGE_URI)</span><br><span class="line"></span><br><span class="line">    makeStatusNotification(<span class="string">&quot;Blurring image&quot;</span>, appContext)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ADD THIS TO SLOW DOWN THE WORKER</span></span><br><span class="line">    sleep()</span><br><span class="line">    <span class="comment">// ^^^^</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (TextUtils.isEmpty(resourceUri)) &#123;</span><br><span class="line">            Timber.e(<span class="string">&quot;Invalid input uri&quot;</span>)</span><br><span class="line">            <span class="keyword">throw</span> IllegalArgumentException(<span class="string">&quot;Invalid input uri&quot;</span>)</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">val</span> resolver = appContext.contentResolver</span><br><span class="line"></span><br><span class="line">        <span class="keyword">val</span> picture = BitmapFactory.decodeStream(</span><br><span class="line">                resolver.openInputStream(Uri.parse(resourceUri)))</span><br><span class="line"></span><br><span class="line">        <span class="keyword">val</span> output = blurBitmap(picture, appContext)</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Write bitmap to a temp file</span></span><br><span class="line">        <span class="keyword">val</span> outputUri = writeBitmapToFile(appContext, output)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">val</span> outputData = workDataOf(KEY_IMAGE_URI to outputUri.toString())</span><br><span class="line"></span><br><span class="line">        Result.success(outputData)</span><br><span class="line">    &#125; <span class="keyword">catch</span> (throwable: Throwable) &#123;</span><br><span class="line">        throwable.printStackTrace()</span><br><span class="line">        Result.failure()</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="第-6-步-創建-WorkRequest-鏈-chain"><a href="#第-6-步-創建-WorkRequest-鏈-chain" class="headerlink" title="第 6 步 - 創建 WorkRequest 鏈(chain)"></a>第 6 步 - 創建 WorkRequest 鏈(chain)</h4><p>您需要修改 <code>BlurViewModel</code> 的 <code>applyBlur</code> 方法以執行 <code>WorkRequest</code> 鏈，而不是僅執行一個請求。目前，程式碼如下所示：</p>
<p><code>BlurViewModel.kt</code></p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> blurRequest = OneTimeWorkRequestBuilder&lt;BlurWorker&gt;()</span><br><span class="line">        .setInputData(createInputDataForUri())</span><br><span class="line">        .build()</span><br><span class="line"></span><br><span class="line">workManager.enqueue(blurRequest)</span><br></pre></td></tr></table></figure>

<p>呼叫 <code>workManager.beginWith()</code>，而不是呼叫 <code>workManager.enqueue()</code>。此呼叫會 return  <code>WorkContinuation</code>，其定義了 <code>WorkRequest</code> 鏈(chain)。您可以通過呼叫 <code>then()</code> 方法向此<u>工作請求鏈(chain of work requests)</u>中添加 <strong>request object</strong>。例如，如果您擁有三個 <code>WorkRequest</code> objects，即 <code>workA</code>、<code>workB</code> 和 <code>workC</code>，則可以編寫以下程式碼：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Example code, don&#x27;t copy to the project</span></span><br><span class="line"><span class="keyword">val</span> continuation = workManager.beginWith(workA)</span><br><span class="line"></span><br><span class="line">continuation.then(workB) <span class="comment">// FYI, then() returns a new WorkContinuation instance</span></span><br><span class="line">        .then(workC)</span><br><span class="line">        .enqueue() <span class="comment">// Enqueues the WorkContinuation which is a chain of work</span></span><br></pre></td></tr></table></figure>

<p>此程式碼將生成並運行以下 <code>WorkRequest</code> 鏈(chain)：</p>
<img src="https://developer.android.com/static/codelabs/android-workmanager/img/bf3b82eb9fd22349.png?hl=zh-cn" width="50%">

<p>在 <code>applyBlur</code> 中創建一個 <code>CleanupWorker</code> <code>WorkRequest</code>、<code>BlurImage</code> <code>WorkRequest</code> 和 <code>SaveImageToFile</code> <code>WorkRequest</code> 鏈(chain)。將 input 傳遞到 <code>BlurImage</code> <code>WorkRequest</code> 中。</p>
<p>此操作的程式碼如下：<br><code>BlurViewModel.kt</code></p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">internal</span> <span class="function"><span class="keyword">fun</span> <span class="title">applyBlur</span><span class="params">(blurLevel: <span class="type">Int</span>)</span></span> &#123;</span><br><span class="line">    <span class="comment">// Add WorkRequest to Cleanup temporary images</span></span><br><span class="line">    <span class="keyword">var</span> continuation = workManager</span><br><span class="line">            .beginWith(OneTimeWorkRequest</span><br><span class="line">            .from(CleanupWorker::<span class="keyword">class</span>.java))</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Add WorkRequest to blur the image</span></span><br><span class="line">    <span class="keyword">val</span> blurRequest = OneTimeWorkRequest.Builder(BlurWorker::<span class="keyword">class</span>.java)</span><br><span class="line">            .setInputData(createInputDataForUri())</span><br><span class="line">            .build()</span><br><span class="line"></span><br><span class="line">    continuation = continuation.then(blurRequest)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Add WorkRequest to save the image to the filesystem</span></span><br><span class="line">    <span class="keyword">val</span> save = OneTimeWorkRequest.Builder(SaveImageToFileWorker::<span class="keyword">class</span>.java).build()</span><br><span class="line"></span><br><span class="line">    continuation = continuation.then(save)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Actually start the work</span></span><br><span class="line">    continuation.enqueue()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>此程式碼應該編譯和執行。現在，您應該可以點擊 Go button，並可以在不同 <strong>workers</strong> 執行時看到<u>通知(notifications)</u>。您仍然可以在 Device File Explorer 中查看經過模糊處理的圖片，在下一步中，您將再添加一個 button，以便使用者可以在裝置上查看經過模糊處理的圖片。</p>
<p>在下面的屏幕截圖中，您會發現 <strong>notification messages</strong> 中顯示當前正在執行的 <strong>workers</strong>。</p>
<div style="display: flex;justify-content: center;">
    <div style="width:40%;float:left;margin-right:10px;">
        <img src="https://developer.android.com/static/codelabs/android-workmanager/img/f0bbaf643c24488f.png">
    </div>
    <div style="width:40%;float:left;">
        <img src="https://developer.android.com/static/codelabs/android-workmanager/img/42a036f4b24adddb.png">
    </div>
<div style="clear:both;"></div><!--這是用來清除上方的浮動效果-->
</div>

<img src="https://developer.android.com/static/codelabs/android-workmanager/img/a438421064c385d4.png" width="40%">

<h4 id="第-7-步-重覆使用-BlurWorker"><a href="#第-7-步-重覆使用-BlurWorker" class="headerlink" title="第 7 步 - 重覆使用 BlurWorker"></a>第 7 步 - 重覆使用 BlurWorker</h4><p>現在，我們需要添加對圖片進行不同程度的模糊處理的功能。請獲取傳遞到 <code>applyBlur</code> 中的 <code>blurLevel</code> 參數，並向鏈(chain)中添加多個模糊處理 <code>WorkRequest</code> 操作。只有第一個 <code>WorkRequest</code> 需要且應該獲取 <strong>URI input</strong>。</p>
<div class="note success">
            <p>請注意，這是為了學習目的而在一定程度上刻意進行的設置。相比之下，呼叫模糊處理程式碼三次效率不如通過 <b>BlurWorker</b> 來獲取控制模糊處理 <strong>level</strong> 的 input。不過使用該方法時，我們可以展示 <b>WorkManager 鏈接(chaining)</b>的靈活性。</p>
          </div>

<p>您可以親自嘗試，然後與以下程式碼進行比較：<br><code>BlurViewModel.kt</code></p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">internal</span> <span class="function"><span class="keyword">fun</span> <span class="title">applyBlur</span><span class="params">(blurLevel: <span class="type">Int</span>)</span></span> &#123;</span><br><span class="line">    <span class="comment">// Add WorkRequest to Cleanup temporary images</span></span><br><span class="line">    <span class="keyword">var</span> continuation = workManager</span><br><span class="line">            .beginWith(OneTimeWorkRequest</span><br><span class="line">            .from(CleanupWorker::<span class="keyword">class</span>.java))</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Add WorkRequests to blur the image the number of times requested</span></span><br><span class="line">    <span class="keyword">for</span> (i <span class="keyword">in</span> <span class="number">0</span> until blurLevel) &#123;</span><br><span class="line">        <span class="keyword">val</span> blurBuilder = OneTimeWorkRequestBuilder&lt;BlurWorker&gt;()</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Input the Uri if this is the first blur operation</span></span><br><span class="line">        <span class="comment">// After the first blur operation the input will be the output of previous</span></span><br><span class="line">        <span class="comment">// blur operations.</span></span><br><span class="line">        <span class="keyword">if</span> (i == <span class="number">0</span>) &#123;</span><br><span class="line">            blurBuilder.setInputData(createInputDataForUri())</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        continuation = continuation.then(blurBuilder.build())</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Add WorkRequest to save the image to the filesystem</span></span><br><span class="line">    <span class="keyword">val</span> save = OneTimeWorkRequestBuilder&lt;SaveImageToFileWorker&gt;()</span><br><span class="line">            .build()</span><br><span class="line"></span><br><span class="line">    continuation = continuation.then(save)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Actually start the work</span></span><br><span class="line">    continuation.enqueue()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>打開裝置 Device File Explorer，查看經過模糊處理的圖片。請注意，output 資料夾中包含多張<u>模糊處理過的圖片(blurred images)</u>、<u>處於模糊處理中間階段的圖片</u>，以及<u>根據您選擇的模糊處理程度顯示經過模糊處理的最終圖片</u>。</p>
<p>您的 <strong>“Work”</strong> 非常不錯！現在，您可以對圖片進行模糊處理，模糊程度多少完全由您掌控。處理後的圖片非常有神秘感。</p>
<hr>
<h3 id="確保-Work-不重複"><a href="#確保-Work-不重複" class="headerlink" title="確保 Work 不重複"></a>確保 Work 不重複</h3><p>現在，您已學會使用鏈(chains)，接下來應該掌握的是 <code>WorkManager</code> 的另一項強大功能 - <b>唯一工作鏈( unique work chains)</b>。</p>
<p>有時，您一次只希望運行一個<b>工作鏈(chain of work)</b>。例如，您可能有一個可將 local data 與 server 同步(syncs)的工作鏈 - 您可能希望先讓第一批 data 結束同步，然後再開始新的同步。為此，請使用 <code>beginUniqueWork</code> 而非 <code>beginWith</code>；並且要提供唯一的 <code>String</code> 名稱。這會命名<u><b>整個(entire)</b>工作請求鏈(chain of work requests)</u>，以便您一起引用(refer)和查詢(query)這些請求。</p>
<p>請使用 <code>beginUniqueWork</code> 確保對檔案(file)進行模糊處理的工作鏈是唯一的。傳入 <code>IMAGE_MANIPULATION_WORK_NAME</code> 作為 key。您還需要傳入 <code>ExistingWorkPolicy</code>。選項包括 <code>REPLACE</code>、<code>KEEP</code> 或 <code>APPEND</code>。</p>
<p>您將使用 <code>REPLACE</code>，因為如果使用者在當前圖片完成之前決定對另一張圖片進行模糊處理，我們需要停止當前圖片並開始對新圖片進行模糊處理。</p>
<p>用於啟動<b>唯一工作(unique work)</b>延續的程式碼如下：<br><code>BlurViewModel.kt</code></p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// REPLACE THIS CODE:</span></span><br><span class="line"><span class="comment">// var continuation = workManager</span></span><br><span class="line"><span class="comment">//            .beginWith(OneTimeWorkRequest</span></span><br><span class="line"><span class="comment">//            .from(CleanupWorker::class.java))</span></span><br><span class="line"><span class="comment">// WITH</span></span><br><span class="line"><span class="keyword">var</span> continuation = workManager</span><br><span class="line">        .beginUniqueWork(</span><br><span class="line">                IMAGE_MANIPULATION_WORK_NAME,</span><br><span class="line">                ExistingWorkPolicy.REPLACE,</span><br><span class="line">                OneTimeWorkRequest.from(CleanupWorker::<span class="keyword">class</span>.java)</span><br><span class="line">        )</span><br></pre></td></tr></table></figure>

<p>現在，Blur-O-Matic 一次只會對一張圖片進行模糊處理。</p>
<hr>
<h3 id="Tag-和顯示-Work-status"><a href="#Tag-和顯示-Work-status" class="headerlink" title="Tag 和顯示 Work status"></a>Tag 和顯示 Work status</h3><p>本部分大量使用了 <code>LiveData</code>，因此，如果要充分了解您自己的情況，您應該熟悉如何使用 <code>LiveData</code>。<code>LiveData</code> 是一種具有<u>生命周期感知(lifecycle-aware)</u>能力的 <strong>data holder</strong>。</p>
<p>如果這是您首次使用 <code>LiveData</code> 或 <code>Observable</code>，您可以查看 <a target="_blank" rel="noopener" href="https://developer.android.com/codelabs/android-lifecycles#0">Android Lifecycle-aware components Codelab </a>。</p>
<p>您要做的下一項重大更改是在執行 Work 時實際更改 app 中顯示的內容。</p>
<p>您可以通過獲取保留 <code>WorkInfo</code> object 的 <code>LiveData</code> 來獲取任何 <code>WorkRequest</code> 的狀態(status)。<code>WorkInfo</code> 是一個包含 <code>WorkRequest</code> <u>當前狀態(current state)詳細資料(details)</u>的 object，其中包括：</p>
<ul>
<li>Work 是否為 <code>BLOCKED</code>、<code>CANCELLED</code>、<code>ENQUEUED</code>、<code>FAILED</code>、<code>RUNNING</code> 或 <code>SUCCEEDED</code>。</li>
<li>如果 <code>WorkRequest</code> 完成，則為 Work 的任何 output data。</li>
</ul>
<p>下表顯示了獲取 <code>LiveData&lt;WorkInfo&gt;</code> 或 <code>LiveData&lt;List&lt;WorkInfo&gt;&gt;</code> object 的三種不同方法，以及每種方法相應的用途。</p>
<table>
<thead>
<tr>
<th align="left">Type</th>
<th align="left">WorkManager Method</th>
<th align="left">Description</th>
</tr>
</thead>
<tbody><tr>
<td align="left">使用 <strong>id</strong> get work</td>
<td align="left">getWorkInfoByIdLiveData</td>
<td align="left">每個 <strong>WorkRequest</strong> 都有一個由 <strong>WorkManager</strong> 生成的 unique ID；您可以用此 ID 獲取適用於該實際 <strong>WorkRequest</strong> 的單個(single) <strong>LiveData</strong>。</td>
</tr>
<tr>
<td align="left">使用 <strong>unique chain name</strong> get work</td>
<td align="left">getWorkInfosForUniqueWorkLiveData</td>
<td align="left">如您所見，<strong>WorkRequest</strong> 可能是<u>唯一鏈(unique chain)</u>的一部分。這會在 <strong>WorkRequests</strong> 的 s<strong>ingle, unique chain</strong> 中為所有 work return <strong>LiveData</strong>。</td>
</tr>
<tr>
<td align="left">使用 <strong>tag</strong> get work</td>
<td align="left">getWorkInfosByTagLiveData</td>
<td align="left">最後，您可以選擇使用 String tag 任何 <strong>WorkRequest</strong>。您可以使用同一 tag 標記多個 <strong>WorkRequest</strong>，並將它們關聯起來。這樣會 return 用於任何 single tag 的 <strong>LiveData</strong>。</td>
</tr>
</tbody></table>
<p>您將 tagging <code>SaveImageToFileWorker</code> <code>WorkRequest</code>，以便您可以使用 <code>getWorkInfosByTag</code> 獲取該 tag。您將使用一個 <strong>tag</strong> 為您的 work 加上 <strong>label</strong>，而不是使用 WorkManager ID。因為如果您的使用者對多張圖片進行模糊處理，則所有保存的圖片 <code>WorkRequest</code> 將具有相同的 tag，而不是相同的 ID。此外，您也可以挑選 tag。</p>
<p>請不要使用 <code>getWorkInfosForUniqueWork</code>，因為它將為所有模糊處理 <code>WorkRequest</code> 和清理(cleanup) <code>WorkRequest</code> return <code>WorkInfo</code>，還需要額外的邏輯來查找保存的圖片 <code>WorkRequest</code>。</p>
<h4 id="第-1-步-Tag-your-work"><a href="#第-1-步-Tag-your-work" class="headerlink" title="第 1 步 - Tag your work"></a>第 1 步 - Tag your work</h4><p>在 <code>applyBlur</code> 中，在創建 <code>SaveImageToFileWorker</code> 時，請使用 <code>String</code> 常量 <code>TAG_OUTPUT</code> tag 您的 work：</p>
<p><code>BlurViewModel.kt</code></p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> save = OneTimeWorkRequestBuilder&lt;SaveImageToFileWorker&gt;()</span><br><span class="line">        .addTag(TAG_OUTPUT) <span class="comment">// &lt;-- ADD THIS</span></span><br><span class="line">        .build()</span><br></pre></td></tr></table></figure>

<h4 id="第-2-步-Get-the-WorkInfo"><a href="#第-2-步-Get-the-WorkInfo" class="headerlink" title="第 2 步 - Get the WorkInfo"></a>第 2 步 - Get the WorkInfo</h4><p>現在您已經 tag 了 work，可以獲取(get) <code>WorkInfo</code>：</p>
<ol>
<li>在 <code>BlurViewModel</code> 中，宣告一個名為 <code>outputWorkInfos</code> 的新 class variable，該 variable 是 <code>LiveData&lt;List&lt;WorkInfo&gt;&gt;</code></li>
<li>在 <code>BlurViewModel</code> 中添加 <code>init</code> block 以使用 <code>WorkManager.getWorkInfosByTagLiveData</code> 獲取(get) <code>WorkInfo</code></li>
</ol>
<p>您需要的程式碼如下：<br><code>BlurViewModel.kt</code></p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// New instance variable for the WorkInfo</span></span><br><span class="line"><span class="keyword">internal</span> <span class="keyword">val</span> outputWorkInfos: LiveData&lt;List&lt;WorkInfo&gt;&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Modify the existing init block in the BlurViewModel class to this:</span></span><br><span class="line"><span class="keyword">init</span> &#123;</span><br><span class="line">    imageUri = getImageUri(application.applicationContext)</span><br><span class="line">    <span class="comment">// This transformation makes sure that whenever the current work Id changes the WorkInfo</span></span><br><span class="line">    <span class="comment">// the UI is listening to changes</span></span><br><span class="line">    outputWorkInfos = workManager.getWorkInfosByTagLiveData(TAG_OUTPUT)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="第-3-步-顯示-WorkInfo"><a href="#第-3-步-顯示-WorkInfo" class="headerlink" title="第 3 步 - 顯示 WorkInfo"></a>第 3 步 - 顯示 WorkInfo</h4><p>現在您已擁有適用於 <code>WorkInfo</code> 的 <code>LiveData</code>，可以在 <code>BlurActivity</code> 中進行<b>觀察(observe)</b>。在 <strong>observer</strong> 中：</p>
<ol>
<li>檢查 <code>WorkInfo</code> list 是否不為 <code>null</code> 並且其中是否包含任何 <code>WorkInfo</code> object。如果尚未點擊 Go button，則 return。</li>
<li>獲取(get) list 中的第一個 <code>WorkInfo</code>；只有一個 tag 為 <code>TAG_OUTPUT</code> 的 <code>WorkInfo</code>，因為我們的<b>工作鏈(chain of work)</b>是<b>唯一的(unique)</b>。</li>
<li>使用 <code>workInfo.state.isFinished</code> 檢查 <strong>work status</strong> 是否為<u>已完成(finished)</u>。</li>
<li>如果未完成，請呼叫 <code>showWorkInProgress()</code> 以隱藏 Go button 並顯示 Cancel Work button 和進度條(progress bar)。</li>
<li>如果已完成，請調用 <code>showWorkFinished()</code> 以隱藏 Cancel Work button 和進度條(progress bar)，並顯示 Go button。</li>
</ol>
<p>程式碼如下：<br><code>BlurActivity.kt</code></p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onCreate</span><span class="params">(savedInstanceState: <span class="type">Bundle</span>?)</span></span> &#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="comment">// Observe work status, added in onCreate()</span></span><br><span class="line">    viewModel.outputWorkInfos.observe(<span class="keyword">this</span>, workInfosObserver())</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Define the observer function</span></span><br><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">fun</span> <span class="title">workInfosObserver</span><span class="params">()</span></span>: Observer&lt;List&lt;WorkInfo&gt;&gt; &#123;</span><br><span class="line">    <span class="keyword">return</span> Observer &#123; listOfWorkInfo -&gt;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Note that these next few lines grab a single WorkInfo if it exists</span></span><br><span class="line">        <span class="comment">// This code could be in a Transformation in the ViewModel; they are included here</span></span><br><span class="line">        <span class="comment">// so that the entire process of displaying a WorkInfo is in one location.</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// If there are no matching work info, do nothing</span></span><br><span class="line">        <span class="keyword">if</span> (listOfWorkInfo.isNullOrEmpty()) &#123;</span><br><span class="line">            <span class="keyword">return</span><span class="symbol">@Observer</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// We only care about the one output status.</span></span><br><span class="line">        <span class="comment">// Every continuation has only one worker tagged TAG_OUTPUT</span></span><br><span class="line">        <span class="keyword">val</span> workInfo = listOfWorkInfo[<span class="number">0</span>]</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (workInfo.state.isFinished) &#123;</span><br><span class="line">            showWorkFinished()</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            showWorkInProgress()</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onCreate</span><span class="params">(savedInstanceState: <span class="type">Bundle</span>?)</span></span> &#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="comment">// Observe work status, added in onCreate()</span></span><br><span class="line">    viewModel.outputWorkInfos.observe(<span class="keyword">this</span>, workInfosObserver())</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Define the observer function</span></span><br><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">fun</span> <span class="title">workInfosObserver</span><span class="params">()</span></span>: Observer&lt;List&lt;WorkInfo&gt;&gt; &#123;</span><br><span class="line">    <span class="keyword">return</span> Observer &#123; listOfWorkInfo -&gt;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Note that these next few lines grab a single WorkInfo if it exists</span></span><br><span class="line">        <span class="comment">// This code could be in a Transformation in the ViewModel; they are included here</span></span><br><span class="line">        <span class="comment">// so that the entire process of displaying a WorkInfo is in one location.</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// If there are no matching work info, do nothing</span></span><br><span class="line">        <span class="keyword">if</span> (listOfWorkInfo.isNullOrEmpty()) &#123;</span><br><span class="line">            <span class="keyword">return</span><span class="symbol">@Observer</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// We only care about the one output status.</span></span><br><span class="line">        <span class="comment">// Every continuation has only one worker tagged TAG_OUTPUT</span></span><br><span class="line">        <span class="keyword">val</span> workInfo = listOfWorkInfo[<span class="number">0</span>]</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (workInfo.state.isFinished) &#123;</span><br><span class="line">            showWorkFinished()</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            showWorkInProgress()</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>import <code>androidx.lifecycle.Observer</code>。</li>
</ul>
<h4 id="第-4-步-執行您的-app"><a href="#第-4-步-執行您的-app" class="headerlink" title="第 4 步 - 執行您的 app"></a>第 4 步 - 執行您的 app</h4><p>執行您的 app - 它應該編譯並運行，且現在可以在工作時顯示<b>進度條(progress bar)</b>以及 <b>cancel button</b>：</p>
<img src="https://developer.android.com/static/codelabs/android-workmanager/img/7b70288f69050f0b.png?hl=zh-cn" width="40%">

<hr>
<h3 id="顯示-final-output"><a href="#顯示-final-output" class="headerlink" title="顯示 final output"></a>顯示 final output</h3><p>每個 <code>WorkInfo</code> 還有一個 <code>getOutputData</code> 方法，該方法可讓您獲取(get)包含<u>最終保存的圖片(final saved image)</u>的 <strong>output</strong> <code>Data</code> object。在 Kotlin 中，您可以使用該語言為您生成的 variable <code>outputData</code> 存取此方法。每當有經過模糊處理的圖片準備就緒可供顯示時，便在螢幕上顯示 <strong>See File button</strong>。</p>
<h4 id="第-1-步-創建-See-File-button"><a href="#第-1-步-創建-See-File-button" class="headerlink" title="第 1 步 - 創建 See File button"></a>第 1 步 - 創建 See File button</h4><p><code>activity_blur.xml</code> layout 中有一個隱藏的 button。它位於 <code>BlurActivity</code> 中，名為 <code>outputButton</code>。</p>
<p>在 <code>BlurActivity</code> 的 <code>onCreate()</code> 中，為該 button 設置 <strong>click listener</strong>。此操作應獲取(get) <strong>URI</strong>，然後打開一個 activity 以查看該 URI。您可以使用以下程式碼：</p>
<p><code>BlurActivity.kt</code></p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onCreate</span><span class="params">(savedInstanceState: <span class="type">Bundle</span>?)</span></span> &#123;</span><br><span class="line">   <span class="comment">// Setup view output image file button</span></span><br><span class="line">   binding.seeFileButton.setOnClickListener &#123;</span><br><span class="line">       viewModel.outputUri?.let &#123; currentUri -&gt;</span><br><span class="line">           <span class="keyword">val</span> actionView = Intent(Intent.ACTION_VIEW, currentUri)</span><br><span class="line">           actionView.resolveActivity(packageManager)?.run &#123;</span><br><span class="line">               startActivity(actionView)</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="第-2-步-設置-URI-並顯示-button"><a href="#第-2-步-設置-URI-並顯示-button" class="headerlink" title="第 2 步 - 設置 URI 並顯示 button"></a>第 2 步 - 設置 URI 並顯示 button</h4><p>您需要對 <code>WorkInfo</code> observer 應用一些最後的調整，才能達到預期效果：</p>
<ol>
<li>如果 <code>WorkInfo</code> 完成，請使用 <code>workInfo.outputData</code> 獲取(get) <strong>output data</strong>。</li>
<li>然後獲取(get) <strong>output URI</strong>，請記住，它是使用 <code>Constants.KEY_IMAGE_URI</code> key 儲存的。</li>
<li>如果 URI 不為空(empty)，則會正確儲存(saved)；系統會顯示 <code>outputButton</code> 並使用該 URI 對 view model 呼叫 <code>setOutputUri</code>。</li>
</ol>
<p><code>BlurActivity.kt</code></p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">fun</span> <span class="title">workInfosObserver</span><span class="params">()</span></span>: Observer&lt;List&lt;WorkInfo&gt;&gt; &#123;</span><br><span class="line">    <span class="keyword">return</span> Observer &#123; listOfWorkInfo -&gt;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Note that these next few lines grab a single WorkInfo if it exists</span></span><br><span class="line">        <span class="comment">// This code could be in a Transformation in the ViewModel; they are included here</span></span><br><span class="line">        <span class="comment">// so that the entire process of displaying a WorkInfo is in one location.</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// If there are no matching work info, do nothing</span></span><br><span class="line">        <span class="keyword">if</span> (listOfWorkInfo.isNullOrEmpty()) &#123;</span><br><span class="line">            <span class="keyword">return</span><span class="symbol">@Observer</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// We only care about the one output status.</span></span><br><span class="line">        <span class="comment">// Every continuation has only one worker tagged TAG_OUTPUT</span></span><br><span class="line">        <span class="keyword">val</span> workInfo = listOfWorkInfo[<span class="number">0</span>]</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (workInfo.state.isFinished) &#123;</span><br><span class="line">            showWorkFinished()</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Normally this processing, which is not directly related to drawing views on</span></span><br><span class="line">            <span class="comment">// screen would be in the ViewModel. For simplicity we are keeping it here.</span></span><br><span class="line">            <span class="keyword">val</span> outputImageUri = workInfo.outputData.getString(KEY_IMAGE_URI)</span><br><span class="line"></span><br><span class="line">            <span class="comment">// If there is an output file show &quot;See File&quot; button</span></span><br><span class="line">            <span class="keyword">if</span> (!outputImageUri.isNullOrEmpty()) &#123;</span><br><span class="line">                viewModel.setOutputUri(outputImageUri)</span><br><span class="line">                binding.seeFileButton.visibility = View.VISIBLE</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            showWorkInProgress()</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="第-3-步-執行您的程式碼"><a href="#第-3-步-執行您的程式碼" class="headerlink" title="第 3 步 - 執行您的程式碼"></a>第 3 步 - 執行您的程式碼</h4><p>執行您的程式碼。您應該會看到新的可點擊(clickable)的 <strong>See File button</strong>，該 button 會將您轉到 <strong>outputted file</strong>：</p>
<img src="https://developer.android.com/static/codelabs/android-workmanager/img/5366222d0b4fb705.png" width="40%">

<img src="https://developer.android.com/static/codelabs/android-workmanager/img/cd1ecc8b4ca86748.png" width="40%">

<hr>
<h3 id="取消-work"><a href="#取消-work" class="headerlink" title="取消 work"></a>取消 work</h3><img src="https://developer.android.com/static/codelabs/android-workmanager/img/632d75e145022d14_1920.png" width="30%">

<p>您已新增此 <strong>cancel work button</strong>，所以我們要新增一些程式碼來執行操作。借助 <code>WorkManager</code>，您可以<u>使用 <b>ID</b>、依照 <b>tag</b> 和 <b>unique chain name</b> 取消 work</u>。</p>
<p>在這種情況下，您需要依照 <strong>unique chain name</strong> 取消 work，因為您想要取消 <b>chain</b> 中的所有 work，而不僅僅是某個特定步驟。</p>
<h4 id="第-1-步-依照-name-取消-work"><a href="#第-1-步-依照-name-取消-work" class="headerlink" title="第 1 步 - 依照 name 取消 work"></a>第 1 步 - 依照 name 取消 work</h4><p>在 <code>BlurViewModel</code> 中，新增一個名為 <code>cancelWork()</code> 的新方法以取消<b>唯一工作(unique work)</b>。在函數內，對 <code>workManager</code> 呼叫 <code>cancelUniqueWork</code>，並傳入 <code>IMAGE_MANIPULATION_WORK_NAME</code> tag。</p>
<p><code>BlurViewModel.kt</code></p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">internal</span> <span class="function"><span class="keyword">fun</span> <span class="title">cancelWork</span><span class="params">()</span></span> &#123;</span><br><span class="line">    workManager.cancelUniqueWork(IMAGE_MANIPULATION_WORK_NAME)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="第-2-步-呼叫-cancel-方法"><a href="#第-2-步-呼叫-cancel-方法" class="headerlink" title="第 2 步 - 呼叫 cancel 方法"></a>第 2 步 - 呼叫 cancel 方法</h4><p>然後，使用 <code>cancelButton</code> button 呼叫 <code>cancelWork</code>：</p>
<p><code>BlurActivity.kt</code></p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// In onCreate()</span></span><br><span class="line"><span class="comment">// Hookup the Cancel button</span></span><br><span class="line">binding.cancelButton.setOnClickListener &#123; viewModel.cancelWork() &#125;</span><br></pre></td></tr></table></figure>

<h4 id="第-3-步-執行和取消-work"><a href="#第-3-步-執行和取消-work" class="headerlink" title="第 3 步 - 執行和取消 work"></a>第 3 步 - 執行和取消 work</h4><p>運行您的 app。它應該可以正常編譯。先對圖片進行模糊處理，然後點擊 <strong>cancel button</strong>。整個<b>鏈(chain)</b>都會被取消！</p>
<img src="https://developer.android.com/static/codelabs/android-workmanager/img/dcb4ccfd261957b1.png" width="40%">

<p>請注意，由於 <code>WorkState</code> 不再處於 <code>FINISHED</code>(已完成) 狀態，因此 <strong>work</strong> 取消後，只有 <strong>GO button</strong>。</p>
<hr>
<h3 id="Work-constraints"><a href="#Work-constraints" class="headerlink" title="Work constraints"></a>Work constraints</h3><p>最後，很重要的一點是，<code>WorkManager</code> 支持 <a target="_blank" rel="noopener" href="https://developer.android.com/reference/androidx/work/Constraints"><code>Constraints</code></a>。對於 Blur-O-Matic，您將使用<u>裝置必須充電(charging)</u>的<b>限制條件(constraints)</b>。也就是說，您的 <strong>work request</strong> 只會在裝置充電(charging)的情況下運行。</p>
<h4 id="第-1-步-創建並添加充電限制條件"><a href="#第-1-步-創建並添加充電限制條件" class="headerlink" title="第 1 步 - 創建並添加充電限制條件"></a>第 1 步 - 創建並添加充電限制條件</h4><p>如需創建 <code>Constraints</code> object，請使用 <code>Constraints.Builder</code>。然後，您可以設置所需的，<u>限制條件(constraints)</u>，並使用方法 <code>setRequiresCharging()</code> 將其添加到 <code>WorkRequest</code>：</p>
<p><code>BlurViewModel.kt</code></p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Put this inside the applyBlur() function, above the save work request.</span></span><br><span class="line"><span class="comment">// Create charging constraint</span></span><br><span class="line"><span class="keyword">val</span> constraints = Constraints.Builder()</span><br><span class="line">        .setRequiresCharging(<span class="literal">true</span>)</span><br><span class="line">        .build()</span><br><span class="line"></span><br><span class="line"><span class="comment">// Add WorkRequest to save the image to the filesystem</span></span><br><span class="line"><span class="keyword">val</span> save = OneTimeWorkRequestBuilder&lt;SaveImageToFileWorker&gt;()</span><br><span class="line">        .setConstraints(constraints)</span><br><span class="line">        .addTag(TAG_OUTPUT)</span><br><span class="line">        .build()</span><br><span class="line">continuation = continuation.then(save)</span><br><span class="line"></span><br><span class="line"><span class="comment">// Actually start the work</span></span><br><span class="line">continuation.enqueue()</span><br></pre></td></tr></table></figure>
<ul>
<li>import <code>androidx.work.Constraints</code></li>
</ul>
<h4 id="第-2-步-使用模擬器或裝置進行測試"><a href="#第-2-步-使用模擬器或裝置進行測試" class="headerlink" title="第 2 步 - 使用模擬器或裝置進行測試"></a>第 2 步 - 使用模擬器或裝置進行測試</h4><p>現在您就可以執行 Blur-O-Matic 了。如果您使用的是一台裝置，則可以移除或插入您的裝置。在模擬器上，您可以在 <b>Extended controls window</b> 中更改充電狀態：</p>
<img src="https://developer.android.com/static/codelabs/android-workmanager/img/406ce044ca07169f.png">

<p>當裝置不充電時，應會暫停執行 <code>SaveImageToFileWorker</code>，直到您將裝置插入充電。</p>
<img src="https://developer.android.com/static/codelabs/android-workmanager/img/302da5ec986ae769.png" width="40%">

<div class="note success">
            <p><strong>重要：</strong>添加到 Blur-O-Matic 的另一個良好<b>限制條件(constraint)</b>是保存時的(saving) <b><a target="_blank" rel="noopener" href="https://developer.android.com/reference/androidx/work/Constraints.html#setRequiresStorageNotLow(boolean)">setRequiresStorageNotLow</a></b> constraint。如需查看 <strong>constraint options</strong> 的完整列表，請參閱 <b><a target="_blank" rel="noopener" href="https://developer.android.com/reference/androidx/work/Constraints.Builder.html">Constraints.Builder</a></b> reference。</p>
          </div>

<hr>
<h3 id="最終程式碼"><a href="#最終程式碼" class="headerlink" title="最終程式碼"></a>最終程式碼</h3><p>可以從 GitHub clone 已完成的 WorkManager 的 Codelab：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git clone https://github.com/googlecodelabs/android-workmanager</span><br></pre></td></tr></table></figure>

    </div>

    
    
    

      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/Android/" rel="tag"># Android</a>
              <a href="/tags/Kotlin/" rel="tag"># Kotlin</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2023/12/28/Android%E7%AD%86%E8%A8%98-44-%E5%B0%88%E6%A1%88%EF%BC%9AForage%E6%87%89%E7%94%A8%E7%A8%8B%E5%BC%8F/" rel="prev" title="Android筆記(44)-專案：Forage應用程式">
      <i class="fa fa-chevron-left"></i> Android筆記(44)-專案：Forage應用程式
    </a></div>
      <div class="post-nav-item"></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-3"><a class="nav-link" href="#WorkManager-%E7%B0%A1%E4%BB%8B"><span class="nav-number">1.</span> <span class="nav-text">WorkManager 簡介</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%BB%80%E9%BA%BD%E6%98%AF-WorkManager"><span class="nav-number">1.1.</span> <span class="nav-text">什麽是 WorkManager</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%BD%95%E6%99%82%E4%BD%BF%E7%94%A8-WorkManager"><span class="nav-number">1.2.</span> <span class="nav-text">何時使用 WorkManager</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%BA%96%E5%82%99%E5%B7%A5%E4%BD%9C"><span class="nav-number">2.</span> <span class="nav-text">準備工作</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%AC%AC-1-%E6%AD%A5-%E4%B8%8B%E8%BC%89%E7%A8%8B%E5%BC%8F%E7%A2%BC"><span class="nav-number">2.1.</span> <span class="nav-text">第 1 步 - 下載程式碼</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%AC%AC-2-%E6%AD%A5-%E5%9F%B7%E8%A1%8C-app"><span class="nav-number">2.2.</span> <span class="nav-text">第 2 步 - 執行 app</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%B0%87-WorkManager-%E6%B7%BB%E5%8A%A0%E5%88%B0-app"><span class="nav-number">3.</span> <span class="nav-text">將 WorkManager 添加到 app</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%89%B5%E5%BB%BA-WorkRequest"><span class="nav-number">4.</span> <span class="nav-text">創建 WorkRequest</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#WorkManager-%E5%9F%BA%E7%A4%8E%E7%9F%A5%E8%AD%98"><span class="nav-number">4.1.</span> <span class="nav-text">WorkManager 基礎知識</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%AC%AC-1-%E6%AD%A5-%E5%89%B5%E5%BB%BA-BlurWorker"><span class="nav-number">4.2.</span> <span class="nav-text">第 1 步 - 創建 BlurWorker</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%AC%AC-2-%E6%AD%A5-%E6%96%B0%E5%A2%9E-constructor"><span class="nav-number">4.3.</span> <span class="nav-text">第 2 步 - 新增 constructor</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%AC%AC-3-%E6%AD%A5-%E8%A6%86%E5%AF%AB%E4%B8%A6%E5%AF%A6%E4%BD%9C-doWork"><span class="nav-number">4.4.</span> <span class="nav-text">第 3 步 - 覆寫並實作 doWork()</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%AC%AC-4-%E6%AD%A5-%E5%9C%A8-ViewModel-%E4%B8%AD%E7%8D%B2%E5%8F%96-WorkManager"><span class="nav-number">4.5.</span> <span class="nav-text">第 4 步 - 在 ViewModel 中獲取 WorkManager</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%AC%AC-5-%E6%AD%A5-%E5%9C%A8-WorkManager-%E4%B8%AD%E5%B0%87-WorkRequest-%E5%8A%A0%E5%85%A5-enqueue"><span class="nav-number">4.6.</span> <span class="nav-text">第 5 步 - 在 WorkManager 中將 WorkRequest 加入 enqueue</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%AC%AC-6-%E6%AD%A5-%E9%81%8B%E8%A1%8C%E6%82%A8%E7%9A%84%E7%A8%8B%E5%BC%8F%E7%A2%BC%EF%BC%81"><span class="nav-number">4.7.</span> <span class="nav-text">第 6 步 - 運行您的程式碼！</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%96%B0%E5%A2%9E-input-%E5%92%8C-output"><span class="nav-number">5.</span> <span class="nav-text">新增 input 和 output</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%AC%AC-1-%E6%AD%A5-%E5%89%B5%E5%BB%BA%E8%B3%87%E6%96%99-input-object"><span class="nav-number">5.1.</span> <span class="nav-text">第 1 步 - 創建資料 input object</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%AC%AC-2-%E6%AD%A5-%E5%B0%87-Data-object-%E5%82%B3%E9%81%9E%E5%88%B0-WorkRequest"><span class="nav-number">5.2.</span> <span class="nav-text">第 2 步 - 將 Data object 傳遞到 WorkRequest</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%AC%AC-3-%E6%AD%A5-%E6%9B%B4%E6%96%B0-BlurWorker-%E7%9A%84-doWork-%E4%BB%A5%E7%8D%B2%E5%8F%96-input"><span class="nav-number">5.3.</span> <span class="nav-text">第 3 步 - 更新 BlurWorker 的 doWork() 以獲取 input</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%AC%AC-4-%E6%AD%A5-%E5%B0%8D%E7%B5%A6%E5%AE%9A%E7%9A%84-URI-%E9%80%B2%E8%A1%8C%E6%A8%A1%E7%B3%8A%E8%99%95%E7%90%86"><span class="nav-number">5.4.</span> <span class="nav-text">第 4 步 - 對給定的 URI 進行模糊處理</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%AC%AC-5-%E6%AD%A5-Output-temporary-URI"><span class="nav-number">5.5.</span> <span class="nav-text">第 5 步 - Output temporary URI</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%AC%AC-6-%E6%AD%A5-%E5%9F%B7%E8%A1%8C%E6%82%A8%E7%9A%84-app"><span class="nav-number">5.6.</span> <span class="nav-text">第 6 步 - 執行您的 app</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%8F%88%E7%B5%90%E6%82%A8%E7%9A%84%E5%B7%A5%E4%BD%9C-Chain-your-work"><span class="nav-number">6.</span> <span class="nav-text">鏈結您的工作(Chain your work)</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%AC%AC-1-%E6%AD%A5-%E5%89%B5%E5%BB%BA-Cleanup-%E5%92%8C-Save-Workers"><span class="nav-number">6.1.</span> <span class="nav-text">第 1 步 - 創建 Cleanup 和 Save Workers</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%AC%AC-2-%E6%AD%A5-%E7%B9%BC%E6%89%BF-Worker"><span class="nav-number">6.2.</span> <span class="nav-text">第 2 步 - 繼承 Worker</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%AC%AC-3-%E6%AD%A5-%E8%A6%86%E5%AF%AB%E5%92%8C%E5%AF%A6%E4%BD%9C-doWork-%E4%BB%A5%E7%94%A8%E6%96%BC-CleanupWorker"><span class="nav-number">6.3.</span> <span class="nav-text">第 3 步 - 覆寫和實作 doWork() 以用於 CleanupWorker</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%AC%AC-4-%E6%AD%A5-%E8%A6%86%E5%AF%AB%E5%92%8C%E5%AF%A6%E4%BD%9C-doWork-%E4%BB%A5%E7%94%A8%E6%96%BC-SaveImageToFileWorker"><span class="nav-number">6.4.</span> <span class="nav-text">第 4 步 - 覆寫和實作 doWork() 以用於 SaveImageToFileWorker</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%AC%AC-5-%E6%AD%A5-%E4%BF%AE%E6%94%B9-BlurWorker-Notification"><span class="nav-number">6.5.</span> <span class="nav-text">第 5 步 - 修改 BlurWorker Notification</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%AC%AC-6-%E6%AD%A5-%E5%89%B5%E5%BB%BA-WorkRequest-%E9%8F%88-chain"><span class="nav-number">6.6.</span> <span class="nav-text">第 6 步 - 創建 WorkRequest 鏈(chain)</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%AC%AC-7-%E6%AD%A5-%E9%87%8D%E8%A6%86%E4%BD%BF%E7%94%A8-BlurWorker"><span class="nav-number">6.7.</span> <span class="nav-text">第 7 步 - 重覆使用 BlurWorker</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%A2%BA%E4%BF%9D-Work-%E4%B8%8D%E9%87%8D%E8%A4%87"><span class="nav-number">7.</span> <span class="nav-text">確保 Work 不重複</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Tag-%E5%92%8C%E9%A1%AF%E7%A4%BA-Work-status"><span class="nav-number">8.</span> <span class="nav-text">Tag 和顯示 Work status</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%AC%AC-1-%E6%AD%A5-Tag-your-work"><span class="nav-number">8.1.</span> <span class="nav-text">第 1 步 - Tag your work</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%AC%AC-2-%E6%AD%A5-Get-the-WorkInfo"><span class="nav-number">8.2.</span> <span class="nav-text">第 2 步 - Get the WorkInfo</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%AC%AC-3-%E6%AD%A5-%E9%A1%AF%E7%A4%BA-WorkInfo"><span class="nav-number">8.3.</span> <span class="nav-text">第 3 步 - 顯示 WorkInfo</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%AC%AC-4-%E6%AD%A5-%E5%9F%B7%E8%A1%8C%E6%82%A8%E7%9A%84-app"><span class="nav-number">8.4.</span> <span class="nav-text">第 4 步 - 執行您的 app</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%A1%AF%E7%A4%BA-final-output"><span class="nav-number">9.</span> <span class="nav-text">顯示 final output</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%AC%AC-1-%E6%AD%A5-%E5%89%B5%E5%BB%BA-See-File-button"><span class="nav-number">9.1.</span> <span class="nav-text">第 1 步 - 創建 See File button</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%AC%AC-2-%E6%AD%A5-%E8%A8%AD%E7%BD%AE-URI-%E4%B8%A6%E9%A1%AF%E7%A4%BA-button"><span class="nav-number">9.2.</span> <span class="nav-text">第 2 步 - 設置 URI 並顯示 button</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%AC%AC-3-%E6%AD%A5-%E5%9F%B7%E8%A1%8C%E6%82%A8%E7%9A%84%E7%A8%8B%E5%BC%8F%E7%A2%BC"><span class="nav-number">9.3.</span> <span class="nav-text">第 3 步 - 執行您的程式碼</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%8F%96%E6%B6%88-work"><span class="nav-number">10.</span> <span class="nav-text">取消 work</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%AC%AC-1-%E6%AD%A5-%E4%BE%9D%E7%85%A7-name-%E5%8F%96%E6%B6%88-work"><span class="nav-number">10.1.</span> <span class="nav-text">第 1 步 - 依照 name 取消 work</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%AC%AC-2-%E6%AD%A5-%E5%91%BC%E5%8F%AB-cancel-%E6%96%B9%E6%B3%95"><span class="nav-number">10.2.</span> <span class="nav-text">第 2 步 - 呼叫 cancel 方法</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%AC%AC-3-%E6%AD%A5-%E5%9F%B7%E8%A1%8C%E5%92%8C%E5%8F%96%E6%B6%88-work"><span class="nav-number">10.3.</span> <span class="nav-text">第 3 步 - 執行和取消 work</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Work-constraints"><span class="nav-number">11.</span> <span class="nav-text">Work constraints</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%AC%AC-1-%E6%AD%A5-%E5%89%B5%E5%BB%BA%E4%B8%A6%E6%B7%BB%E5%8A%A0%E5%85%85%E9%9B%BB%E9%99%90%E5%88%B6%E6%A2%9D%E4%BB%B6"><span class="nav-number">11.1.</span> <span class="nav-text">第 1 步 - 創建並添加充電限制條件</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%AC%AC-2-%E6%AD%A5-%E4%BD%BF%E7%94%A8%E6%A8%A1%E6%93%AC%E5%99%A8%E6%88%96%E8%A3%9D%E7%BD%AE%E9%80%B2%E8%A1%8C%E6%B8%AC%E8%A9%A6"><span class="nav-number">11.2.</span> <span class="nav-text">第 2 步 - 使用模擬器或裝置進行測試</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%9C%80%E7%B5%82%E7%A8%8B%E5%BC%8F%E7%A2%BC"><span class="nav-number">12.</span> <span class="nav-text">最終程式碼</span></a></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Tina Tang"
      src="/images/blog_photo.png">
  <p class="site-author-name" itemprop="name">Tina Tang</p>
  <div class="site-description" itemprop="description">^(-o-)></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">46</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">9</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">111</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/linglingdr00" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;linglingdr00" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:tinatang0424@gmail.com" title="E-Mail → mailto:tinatang0424@gmail.com" rel="noopener" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2023</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Tina Tang</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://pisces.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Pisces</a>
  </div><script color="0,0,255" opacity="0.5" zIndex="-1" count="99" src="https://cdn.jsdelivr.net/npm/canvas-nest.js@1/dist/canvas-nest.js"></script>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="//cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script>
  <script src="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  




  
<script src="/js/local-search.js"></script>













  

  

</body>
</html>
