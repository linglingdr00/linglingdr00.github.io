<!DOCTYPE html>
<html lang="zh-tw">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 6.3.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16.png">
  <link rel="mask-icon" href="/images/logo2.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">

<link rel="stylesheet" href="https://fonts.loli.net/css?family=Shippori Mincho:300,300italic,400,400italic,700,700italic|Inconsolata:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">
<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">
  <link rel="stylesheet" href="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"linglingdr00.github.io","root":"/","scheme":"Pisces","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":true,"show_result":true,"style":"default"},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":true,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

<link rel="preconnect" href="https://fonts.loli.net">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.loli.net/css2?family=Noto+Serif+TC:wght@500;600;700&family=Shippori+Mincho:wght@500;600;700&display=swap" rel="stylesheet">
  <meta name="description" content="瞭解如何使用共用 ViewModel 在相同 activity 的 fragment 之間共用資料，還有 LiveData 轉換等新概念。  學習目標  如何在更進階用途中導入建議的應用程式架構做法 如何在 activity 的各個 fragment 中使用共用的 ViewModel 如何套用 LiveData 轉換  建構項目此杯子蛋糕應用程式會顯示杯子蛋糕的訂單流程，讓使用者選擇杯子蛋糕口味">
<meta property="og:type" content="article">
<meta property="og:title" content="Android筆記(28)-在各Fragment之間共用ViewModel">
<meta property="og:url" content="https://linglingdr00.github.io/2023/11/11/Android%E7%AD%86%E8%A8%98-28-%E5%9C%A8%E5%90%84Fragment%E4%B9%8B%E9%96%93%E5%85%B1%E7%94%A8ViewModel/index.html">
<meta property="og:site_name" content="Tina Tang&#39;s Blog">
<meta property="og:description" content="瞭解如何使用共用 ViewModel 在相同 activity 的 fragment 之間共用資料，還有 LiveData 轉換等新概念。  學習目標  如何在更進階用途中導入建議的應用程式架構做法 如何在 activity 的各個 fragment 中使用共用的 ViewModel 如何套用 LiveData 轉換  建構項目此杯子蛋糕應用程式會顯示杯子蛋糕的訂單流程，讓使用者選擇杯子蛋糕口味">
<meta property="og:locale" content="zh_TW">
<meta property="og:image" content="https://developer.android.com/static/codelabs/basic-android-kotlin-training-shared-viewmodel/img/732881cfc463695d_1920.png?hl=zh-tw">
<meta property="og:image" content="https://developer.android.com/static/codelabs/basic-android-kotlin-training-shared-viewmodel/img/fdce89b318218ea6_1920.png?hl=zh-tw">
<meta property="og:image" content="https://developer.android.com/static/codelabs/basic-android-kotlin-training-shared-viewmodel/img/d014c1b710c1088d_1920.png?hl=zh-tw">
<meta property="og:image" content="https://developer.android.com/static/codelabs/basic-android-kotlin-training-shared-viewmodel/img/65c7d993b98c9dea_1920.png?hl=zh-tw">
<meta property="og:image" content="https://developer.android.com/static/codelabs/basic-android-kotlin-training-shared-viewmodel/img/724eb8992a1a9381_1920.png?hl=zh-tw">
<meta property="og:image" content="https://developer.android.com/static/codelabs/basic-android-kotlin-training-shared-viewmodel/img/e4ee54469f5ff1a4_1920.png?hl=zh-tw">
<meta property="og:image" content="https://developer.android.com/static/codelabs/basic-android-kotlin-training-shared-viewmodel/img/739d4ddac561c478_1920.png?hl=zh-tw">
<meta property="og:image" content="https://developer.android.com/static/codelabs/basic-android-kotlin-training-shared-viewmodel/img/bf3cfa7841476892_1920.png?hl=zh-tw">
<meta property="og:image" content="https://developer.android.com/static/codelabs/basic-android-kotlin-training-shared-viewmodel/img/867d8e4c72078f76_1920.png?hl=zh-tw">
<meta property="og:image" content="https://developer.android.com/static/codelabs/basic-android-kotlin-training-shared-viewmodel/img/2a087f53a77765a6_1920.png?hl=zh-tw">
<meta property="og:image" content="https://developer.android.com/static/codelabs/basic-android-kotlin-training-shared-viewmodel/img/3b351067bf4926b7_1920.png?hl=zh-tw">
<meta property="og:image" content="https://developer.android.com/static/codelabs/basic-android-kotlin-training-shared-viewmodel/img/96b33bf7a5bd8050_1920.png">
<meta property="og:image" content="https://developer.android.com/static/codelabs/basic-android-kotlin-training-shared-viewmodel/img/b7657cdc50cfeab0_1920.png?hl=zh-tw">
<meta property="og:image" content="https://developer.android.com/static/codelabs/basic-android-kotlin-training-shared-viewmodel/img/3b6a68cab0b9ee2_1920.png?hl=zh-tw">
<meta property="og:image" content="https://developer.android.com/static/codelabs/basic-android-kotlin-training-shared-viewmodel/img/3095e824b4817b98_1920.png?hl=zh-tw">
<meta property="og:image" content="https://developer.android.com/static/codelabs/basic-android-kotlin-training-shared-viewmodel/img/b55b3a36e2aa7be6_1920.png?hl=zh-tw">
<meta property="og:image" content="https://developer.android.com/static/codelabs/basic-android-kotlin-training-shared-viewmodel/img/bfe4f1b82977b4bc_1920.png?hl=zh-tw">
<meta property="og:image" content="https://developer.android.com/static/codelabs/basic-android-kotlin-training-shared-viewmodel/img/78f510e10d848dd2_1920.png?hl=zh-tw">
<meta property="og:image" content="https://developer.android.com/static/codelabs/basic-android-kotlin-training-shared-viewmodel/img/7091453fa817b55_1920.png?hl=zh-tw">
<meta property="og:image" content="https://developer.android.com/static/codelabs/basic-android-kotlin-training-shared-viewmodel/img/3b6a68cab0b9ee2_1920.png?hl=zh-tw">
<meta property="og:image" content="https://developer.android.com/static/codelabs/basic-android-kotlin-training-shared-viewmodel/img/13e316e13779d3c2_1920.png?hl=zh-tw">
<meta property="og:image" content="https://developer.android.com/static/codelabs/basic-android-kotlin-training-shared-viewmodel/img/adb9342d3a0da64e_1920.png?hl=zh-tw">
<meta property="og:image" content="https://developer.android.com/static/codelabs/basic-android-kotlin-training-shared-viewmodel/img/f53d06e5a3c12e96_1920.png?hl=zh-tw">
<meta property="og:image" content="https://developer.android.com/static/codelabs/basic-android-kotlin-training-shared-viewmodel/img/f6eda1308338db23_1920.png?hl=zh-tw">
<meta property="og:image" content="https://developer.android.com/static/codelabs/basic-android-kotlin-training-shared-viewmodel/img/2ea8e000fb4e6ec8_1920.png?hl=zh-tw">
<meta property="og:image" content="https://developer.android.com/static/codelabs/basic-android-kotlin-training-shared-viewmodel/img/905d8c8df1bfd5f2_1920.png?hl=zh-tw">
<meta property="og:image" content="https://developer.android.com/static/codelabs/basic-android-kotlin-training-shared-viewmodel/img/7629d8a884304866_1920.png?hl=zh-tw">
<meta property="og:image" content="https://developer.android.com/static/codelabs/basic-android-kotlin-training-shared-viewmodel/img/f4c0a3c5ea916d03_1920.png?hl=zh-tw">
<meta property="og:image" content="https://developer.android.com/static/codelabs/basic-android-kotlin-training-shared-viewmodel/img/1853bd13a07f1bc7_1920.png?hl=zh-tw">
<meta property="article:published_time" content="2023-11-11T15:04:33.000Z">
<meta property="article:modified_time" content="2023-12-02T05:34:52.915Z">
<meta property="article:author" content="Tina Tang">
<meta property="article:tag" content="Android">
<meta property="article:tag" content="Kotlin">
<meta property="article:tag" content="View Binding">
<meta property="article:tag" content="UI Controller">
<meta property="article:tag" content="ViewModel">
<meta property="article:tag" content="LiveData">
<meta property="article:tag" content="Observer">
<meta property="article:tag" content="Data Binding">
<meta property="article:tag" content="MutableLiveData">
<meta property="article:tag" content="Shared ViewModel">
<meta property="article:tag" content="LifecycleOwner">
<meta property="article:tag" content="SimpleDateFormat">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://developer.android.com/static/codelabs/basic-android-kotlin-training-shared-viewmodel/img/732881cfc463695d_1920.png?hl=zh-tw">

<link rel="canonical" href="https://linglingdr00.github.io/2023/11/11/Android%E7%AD%86%E8%A8%98-28-%E5%9C%A8%E5%90%84Fragment%E4%B9%8B%E9%96%93%E5%85%B1%E7%94%A8ViewModel/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-tw'
  };
</script>

  <title>Android筆記(28)-在各Fragment之間共用ViewModel | Tina Tang's Blog</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">Tina Tang's Blog</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">在哪裡跌倒了，就在哪裡躺下來</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>About</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>Search
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="Searching..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-tw">
    <link itemprop="mainEntityOfPage" href="https://linglingdr00.github.io/2023/11/11/Android%E7%AD%86%E8%A8%98-28-%E5%9C%A8%E5%90%84Fragment%E4%B9%8B%E9%96%93%E5%85%B1%E7%94%A8ViewModel/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/blog_photo.png">
      <meta itemprop="name" content="Tina Tang">
      <meta itemprop="description" content="^(-o-)>">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Tina Tang's Blog">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          Android筆記(28)-在各Fragment之間共用ViewModel
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2023-11-11 23:04:33" itemprop="dateCreated datePublished" datetime="2023-11-11T23:04:33+08:00">2023-11-11</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2023-12-02 13:34:52" itemprop="dateModified" datetime="2023-12-02T13:34:52+08:00">2023-12-02</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Android/" itemprop="url" rel="index"><span itemprop="name">Android</span></a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Android/Android-Kotlin%E5%9F%BA%E6%9C%AC%E6%A6%82%E5%BF%B5%E8%AA%B2%E7%A8%8B/" itemprop="url" rel="index"><span itemprop="name">Android Kotlin基本概念課程</span></a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Android/Android-Kotlin%E5%9F%BA%E6%9C%AC%E6%A6%82%E5%BF%B5%E8%AA%B2%E7%A8%8B/Navigation/" itemprop="url" rel="index"><span itemprop="name">Navigation</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <blockquote>
<p>瞭解如何使用共用 <code>ViewModel</code> 在相同 activity 的 fragment 之間共用資料，還有 <code>LiveData</code> 轉換等新概念。</p>
</blockquote>
<p><strong>學習目標</strong></p>
<ul>
<li>如何在更進階用途中導入建議的應用程式架構做法</li>
<li>如何在 activity 的各個 fragment 中使用共用的 <code>ViewModel</code></li>
<li>如何套用 <code>LiveData</code> 轉換</li>
</ul>
<p><strong>建構項目</strong><br>此杯子蛋糕應用程式會顯示杯子蛋糕的訂單流程，讓使用者選擇杯子蛋糕口味、數量和取貨日期。</p>
<span id="more"></span>

<hr>
<h3 id="範例應用程式總覽"><a href="#範例應用程式總覽" class="headerlink" title="範例應用程式總覽"></a>範例應用程式總覽</h3><h4 id="杯子蛋糕應用程式總覽"><a href="#杯子蛋糕應用程式總覽" class="headerlink" title="杯子蛋糕應用程式總覽"></a>杯子蛋糕應用程式總覽</h4><p>杯子蛋糕應用程式示範如何設計及導入線上訂購應用程式。本課程結束時，您將完成有下列畫面的杯子蛋糕應用程式。使用者可以選擇杯子蛋糕訂單的數量、口味和其他選項。</p>
<img src="https://developer.android.com/static/codelabs/basic-android-kotlin-training-shared-viewmodel/img/732881cfc463695d_1920.png?hl=zh-tw">

<h4 id="下載本程式碼研究室的範例程式碼"><a href="#下載本程式碼研究室的範例程式碼" class="headerlink" title="下載本程式碼研究室的範例程式碼"></a>下載本程式碼研究室的範例程式碼</h4><p>本程式碼研究室提供範例程式碼，讓您以本程式碼研究室所教授的功能擴充應用程式。範例程式碼含有您先前在程式碼研究室中熟悉的程式碼。</p>
<p>請注意，如果您從 GitHub 下載範例程式碼，專案的資料夾名稱會是 <code>android-basics-kotlin-cupcake-app-starter</code>。在 Android Studio 中開啟專案時，請選取此資料夾。</p>
<div class="note no-icon success">
            <p><strong>範例程式碼網址：</strong><a target="_blank" rel="noopener" href="https://github.com/google-developer-training/android-basics-kotlin-cupcake-app/tree/starter">https://github.com/google-developer-training/android-basics-kotlin-cupcake-app/tree/starter</a></p>
          </div>

<h4 id="範例程式碼逐步操作說明"><a href="#範例程式碼逐步操作說明" class="headerlink" title="範例程式碼逐步操作說明"></a>範例程式碼逐步操作說明</h4><ol>
<li>在 Android Studio 中開啟已下載的專案。專案的資料夾名稱為 <code>android-basics-kotlin-cupcake-app-starter</code>。然後執行應用程式。</li>
<li>瀏覽檔案以瞭解範例程式碼。針對 layout 檔案，您可以使用右上角的「Split」選項，同時查看 layout 和 XML 的預覽畫面。</li>
<li>編譯並執行應用程式時，您會發現應用程式並不完整。除了顯示 Toast 訊息外，這些按鈕的作用不大，而且無法導覽至其他 fragment。</li>
</ol>
<p>以下說明專案裡的重要檔案。</p>
<p><strong>MainActivity：</strong><br><code>MainActivity</code> 和預設產生的程式碼相似，用於將 activity 的內容檢視設定為 <code>activity_main.xml</code>。此程式碼使用參數化建構函式 <code>AppCompatActivity(@LayoutRes int contentLayoutId)</code>，其 layout 會加載為 <code>super.onCreate(savedInstanceState)</code> 的一部分。</p>
<p><code>MainActivity</code> 類別的程式碼</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">MainActivity</span> : <span class="type">AppCompatActivity</span>(R.layout.activity_main)</span><br></pre></td></tr></table></figure>

<p>與使用預設 <code>AppCompatActivity</code> 建構函式的下列程式碼相同：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">MainActivity</span> : <span class="type">AppCompatActivity</span>() &#123;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onCreate</span><span class="params">(savedInstanceState: <span class="type">Bundle</span>?)</span></span> &#123;</span><br><span class="line">       <span class="keyword">super</span>.onCreate(savedInstanceState)</span><br><span class="line">       setContentView(R.layout.activity_main)</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>Layout (res&#x2F;layout 資料夾)：</strong><br><code>layout</code> 資源資料夾含有 activity 和 fragment layout 檔案。這些是較簡單的 layout 檔案，而在先前的程式碼研究室中已熟悉 XML。</p>
<ul>
<li><code>fragment_start.xml</code> 是應用程式中顯示的第一個畫面。這項產品提供杯子蛋糕圖片和三個按鈕，可供選擇想要訂購的杯子數量：一個杯子蛋糕、六個杯子蛋糕和十二個杯子蛋糕。</li>
<li><code>fragment_flavor.xml</code> 會顯示以圓形按鈕選項呈現的杯子蛋糕口味清單，以及「Next」按鈕。</li>
<li><code>fragment_pickup.xml</code> 提供選擇取貨日的選項，按一下「Next」按鈕即可前往摘要畫面。</li>
<li><code>fragment_summary.xml</code> 會顯示訂單詳細資料摘要，例如數量、口味，以及可將訂單傳送至其他應用程式的按鈕。</li>
</ul>
<p><strong>Fragment 類別：</strong></p>
<ul>
<li><code>StartFragment.kt</code> 是應用程式中顯示的第一個畫面。此類別含有三個按鈕的 view binding 程式碼和 click handler。</li>
<li><code>FlavorFragment.kt</code>、<code>PickupFragment.kt</code> 和 <code>SummaryFragment.kt</code> 類別主要包含樣板程式碼，以及「Next」或「Send Order to Another App」按鈕的 click handler，且會顯示 toast 訊息。</li>
</ul>
<hr>
<h3 id="完成導覽圖-Navigation-Graph"><a href="#完成導覽圖-Navigation-Graph" class="headerlink" title="完成導覽圖(Navigation Graph)"></a>完成導覽圖(Navigation Graph)</h3><p>在這項工作中，我們將連結杯子蛋糕應用程式的畫面，並在應用程式中導入適當的 navigation 功能。<br>您記得必須使用 Navigation component 嗎？請按照<a target="_blank" rel="noopener" href="https://developer.android.com/guide/navigation/navigation-getting-started?hl=zh-tw">這份指南</a>中的複習，瞭解如何設定專案和應用程式，目標是：</p>
<ul>
<li>加入 <a target="_blank" rel="noopener" href="https://developer.android.com/jetpack/androidx/releases/navigation?hl=zh-tw">Jetpack Navigation library</a></li>
<li>在 activity 中新增 <code>NavHost</code></li>
<li>建立 navigation graph</li>
<li>在 navigation graph 中新增 fragment 目的地</li>
</ul>
<h4 id="在-navigation-graph-中連接目的地-destinations"><a href="#在-navigation-graph-中連接目的地-destinations" class="headerlink" title="在 navigation graph 中連接目的地(destinations)"></a>在 navigation graph 中連接目的地(destinations)</h4><ol>
<li><p>在 Android Studio 的「Project」視窗中，開啟 <strong>res &gt; navigation &gt; nav_graph.xml</strong> 檔案。如果尚未選取「Design」分頁標籤，請予以選取。</p>
</li>
<li><p>選取後即可開啟「Navigation Editor」，以視覺化方式呈現應用程式中的 navigation graph。您應該會看到應用程式中已有四個 fragments。</p>
</li>
</ol>
<img src="https://developer.android.com/static/codelabs/basic-android-kotlin-training-shared-viewmodel/img/fdce89b318218ea6_1920.png?hl=zh-tw">

<div class="note no-icon success">
            <p><strong>注意：</strong>如果<b>目的(destination) fragments</b> 在 Android Studio 中以不同方式排列，請點擊並拖曳<b>目的地(destinations)</b>，以類似上述螢幕截圖的方式重新排列，您在程式碼研究室中則能更輕鬆設定 <b>navigation 動作(actions)</b>。</p>
          </div>

<ol start="3">
<li><p>連結導覽圖中的 fragment 目的地。建立從 <code>startFragment</code> 到 <code>flavorFragment</code> 的動作、從 <code>flavorFragment</code> 到 <code>pickupFragment</code> 的連接，以及從 <code>pickupFragment</code> 到 <code>summaryFragment</code> 的連接。如需更詳細的操作說明，請按照下列後續步驟操作。</p>
</li>
<li><p>將滑鼠游標懸停在 <code>startFragment</code> 上，直到 fragment 周圍顯示灰色框線，且 fragment 右側邊緣的中心顯示灰色圓圈圖示。按一下圓圈並拖曳至 <code>flavorFragment</code>，然後放開滑鼠。</p>
</li>
</ol>
<img src="https://developer.android.com/static/codelabs/basic-android-kotlin-training-shared-viewmodel/img/d014c1b710c1088d_1920.png?hl=zh-tw" width="60%">

<ol start="5">
<li>兩個 fragment 之間的箭頭表示已成功連接，因此您將可以從 <code>startFragment</code> 前往 <code>flavorFragment</code>。這就是「Navigation」動作，您可以在先前的程式碼研究室中學到。</li>
</ol>
<img src="https://developer.android.com/static/codelabs/basic-android-kotlin-training-shared-viewmodel/img/65c7d993b98c9dea_1920.png?hl=zh-tw" width="60%">

<ol start="6">
<li>同樣地，將新增從 <code>flavorFragment</code> 到 <code>pickupFragment</code>，以及從 <code>pickupFragment</code> 到 <code>summaryFragment</code> 的導覽動作(navigation actions)。建立 navigation actions 後，完成的 navigation graph 看起來會如下所示。</li>
</ol>
<img src="https://developer.android.com/static/codelabs/basic-android-kotlin-training-shared-viewmodel/img/724eb8992a1a9381_1920.png?hl=zh-tw">

<ol start="7">
<li>您建立的三個新動作(actions)應該也會顯示在「Component Tree」窗格中。</li>
</ol>
<img src="https://developer.android.com/static/codelabs/basic-android-kotlin-training-shared-viewmodel/img/e4ee54469f5ff1a4_1920.png?hl=zh-tw" width="60%">

<ol start="8">
<li>定義 navigation graph 時，建議您也指定開始目的地(start destination)。目前您可以看到 startFragment 旁有一個小型房屋圖示。</li>
</ol>
<img src="https://developer.android.com/static/codelabs/basic-android-kotlin-training-shared-viewmodel/img/739d4ddac561c478_1920.png?hl=zh-tw" width="30%">

<ul>
<li>這表示 <code>startFragment</code> 將是第一個顯示在 <code>NavHost</code> 中的 fragment。設定為應用程式所需的預期行為。日後只要在任一 fragment 上按一下滑鼠右鍵，然後選取「Set as Start Destination」選單選項，即可隨時變更起點的位置。</li>
</ul>
<img src="https://developer.android.com/static/codelabs/basic-android-kotlin-training-shared-viewmodel/img/bf3cfa7841476892_1920.png?hl=zh-tw" width="70%">

<h4 id="從-start-fragment-前往-flavor-fragment"><a href="#從-start-fragment-前往-flavor-fragment" class="headerlink" title="從 start fragment 前往 flavor fragment"></a>從 start fragment 前往 flavor fragment</h4><p>接下來，您必須新增程式碼，目的是在第一個 fragment 中輕觸按鈕時從 <code>startFragment</code> 前往 <code>flavorFragment</code>，而非顯示 <code>Toast</code> 訊息。以下是 start fragment layout 的參考資料。您在之後的任務中，必須將杯子蛋糕的數量(quantity)傳遞至 flavor fragment。</p>
<img src="https://developer.android.com/static/codelabs/basic-android-kotlin-training-shared-viewmodel/img/867d8e4c72078f76_1920.png?hl=zh-tw" width="30%">

<ol>
<li><p>在「Project」視窗中，依序開啟 <strong>app &gt; java &gt; com.example.cupcake &gt; StartFragment.kt</strong> 檔案。</p>
</li>
<li><p>在 <code>onViewCreated()</code> 方法中，請留意， click listeners 設定在三個按鈕上。輕觸各個按鈕時，系統會呼叫 <code>orderCupcake()</code> 方法，並以杯子蛋糕數量 (1、6 或 12 個杯子蛋糕) 做為參數。</p>
</li>
</ol>
<p>參考 code：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">orderOneCupcake.setOnClickListener &#123; orderCupcake(<span class="number">1</span>) &#125;</span><br><span class="line">orderSixCupcakes.setOnClickListener &#123; orderCupcake(<span class="number">6</span>) &#125;</span><br><span class="line">orderTwelveCupcakes.setOnClickListener &#123; orderCupcake(<span class="number">12</span>) &#125;</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>在 <code>orderCupcake()</code> 方法中，將顯示 toast 訊息的程式碼替換成前往  flavor fragment 的程式碼。使用 <code>findNavController()</code> 方法取得 <code>NavController</code>，並呼叫此方法的 <code>navigate()</code>，並在傳入動作 ID <code>R.id.action_startFragment_to_flavorFragment</code>。請確認這項動作 ID 與您在 <code>nav_graph.xml</code> 中宣告的動作相符。</li>
</ol>
<p>將</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">orderCupcake</span><span class="params">(quantity: <span class="type">Int</span>)</span></span> &#123;</span><br><span class="line">    Toast.makeText(activity, <span class="string">&quot;Ordered <span class="variable">$quantity</span> cupcake(s)&quot;</span>, Toast.LENGTH_SHORT).show()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>取代為</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">orderCupcake</span><span class="params">(quantity: <span class="type">Int</span>)</span></span> &#123;</span><br><span class="line">   findNavController().navigate(R.id.action_startFragment_to_flavorFragment)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="4">
<li>新增「Import」<code>import</code> <code>androidx.navigation.fragment.findNavController</code>，或從 Android Studio 提供的選項中選擇。</li>
</ol>
<img src="https://developer.android.com/static/codelabs/basic-android-kotlin-training-shared-viewmodel/img/2a087f53a77765a6_1920.png?hl=zh-tw">

<h4 id="在-flavor-和-pickup-fragments-中新增-Navigation"><a href="#在-flavor-和-pickup-fragments-中新增-Navigation" class="headerlink" title="在 flavor 和 pickup fragments 中新增 Navigation"></a>在 flavor 和 pickup fragments 中新增 Navigation</h4><p>這項工作與上一個工作類似，您要在其他 fragment (<strong>flavor</strong> 和 <strong>pickup fragment</strong>) 中新增 <strong>navigation</strong>。</p>
<img src="https://developer.android.com/static/codelabs/basic-android-kotlin-training-shared-viewmodel/img/3b351067bf4926b7_1920.png?hl=zh-tw">

<ol>
<li><p>開啟 <strong>app &gt; java &gt; com.example.cupcake &gt; FlavorFragment.kt</strong>。請注意，「Next」按鈕 click listener 內呼叫的方法為 <code>goToNextScreen()</code> 方法。</p>
</li>
<li><p>在 <strong>FlavorFragment.kt</strong> 的 <code>goToNextScreen()</code> 方法中，取代顯示 Toast 訊息的程式碼，前往 pickup fragment。使用 action ID <code>R.id.action_flavorFragment_to_pickupFragment</code> 並確認此 ID 與 <code>nav_graph.xml</code> 中宣告的 action 相符。</p>
</li>
</ol>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">goToNextScreen</span><span class="params">()</span></span> &#123;</span><br><span class="line">    findNavController().navigate(R.id.action_flavorFragment_to_pickupFragment)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>記得 import <code>androidx.navigation.fragment.findNavController</code>。</li>
</ul>
<ol start="3">
<li>同樣地，在 <strong>PickupFragment.kt</strong> 的 <code>goToNextScreen()</code> 方法中，取代現有的程式碼以前往 summary fragment。</li>
</ol>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">goToNextScreen</span><span class="params">()</span></span> &#123;</span><br><span class="line">    findNavController().navigate(R.id.action_pickupFragment_to_summaryFragment)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>Import <code>androidx.navigation.fragment.findNavController</code>。</li>
</ul>
<ol start="4">
<li>執行應用程式。確認按鈕可供切換畫面瀏覽。每個 fragment 顯示的資訊可能不完整，但請放心，您會在後續步驟中填入正確的 fragment。</li>
</ol>
<img src="https://developer.android.com/static/codelabs/basic-android-kotlin-training-shared-viewmodel/img/96b33bf7a5bd8050_1920.png">

<h4 id="更新-app-bar-中的標題"><a href="#更新-app-bar-中的標題" class="headerlink" title="更新 app bar 中的標題"></a>更新 app bar 中的標題</h4><p>瀏覽應用程式時，app bar 中的標題永遠顯示為杯子蛋糕。<br>根據目前 fragment 的功能提供更相關的標題，有助於改善使用者體驗。<br>使用 <code>NavController</code> 變更 app bar (也稱為 action bar) 中各 fragment 的標題，並使用「Up」 (←) 按鈕。</p>
<img src="https://developer.android.com/static/codelabs/basic-android-kotlin-training-shared-viewmodel/img/b7657cdc50cfeab0_1920.png?hl=zh-tw">

<ol>
<li><p>在 <strong>MainActivity.kt</strong> 中覆寫 <code>onCreate()</code> 方法來設定 navigation controller。從 <code>NavHostFragment</code> 取得 <code>NavController</code> 的 instance。</p>
</li>
<li><p>呼叫 <code>setupActionBarWithNavController(navController)</code> 以傳入 <code>NavController</code> 的 instance。操作方式如下：在 app bar 中，根據目的地(destination)的 label 顯示標題；即使沒有頂層(top-level)目的地，也會顯示「Up」 按鈕。</p>
</li>
</ol>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">MainActivity</span> : <span class="type">AppCompatActivity</span>(R.layout.activity_main) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onCreate</span><span class="params">(savedInstanceState: <span class="type">Bundle</span>?)</span></span> &#123;</span><br><span class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">val</span> navHostFragment = supportFragmentManager</span><br><span class="line">                .findFragmentById(R.id.nav_host_fragment) <span class="keyword">as</span> NavHostFragment</span><br><span class="line">        <span class="keyword">val</span> navController = navHostFragment.navController</span><br><span class="line"></span><br><span class="line">        setupActionBarWithNavController(navController)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>在 Android Studio 顯示提示時新增必要的 import 項目。</li>
</ol>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> android.os.Bundle</span><br><span class="line"><span class="keyword">import</span> androidx.navigation.fragment.NavHostFragment</span><br><span class="line"><span class="keyword">import</span> androidx.navigation.ui.setupActionBarWithNavController</span><br></pre></td></tr></table></figure>

<ol start="4">
<li><p>設定每個 fragment 的 app bar 標題。開啟 <code>navigation/nav_graph.xml</code> 並切換至「Code」分頁標籤。</p>
</li>
<li><p>在 <code>nav_graph.xml</code> 中，修改每個 fragment 目的地的 <code>android:label</code> 屬性。使用已在範例應用程式中宣告的下列字串資源。</p>
</li>
</ol>
<ul>
<li>如果是 <strong>start fragment</strong>，請使用 <code>@string/app_name</code>，其 value 為 <code>Cupcake</code>。</li>
<li>如果是 <strong>flavor fragment</strong>，請使用 <code>@string/choose_flavor</code>，其 value 為 <code>Choose Flavor</code>。</li>
<li>如果是 <strong>pickup fragment</strong>，請使用 <code>@string/choose_pickup_date</code>，其 value 為 <code>Choose Pickup Date</code>。</li>
<li>如果是 <strong>summary fragment</strong>，請使用 <code>@string/order_summary</code>，其 value 為 <code>Order Summary</code>。</li>
</ul>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">navigation</span> <span class="attr">...</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">fragment</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:id</span>=<span class="string">&quot;@+id/startFragment&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">...</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:label</span>=<span class="string">&quot;@string/app_name&quot;</span> <span class="attr">...</span> &gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">action</span> <span class="attr">...</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">fragment</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">fragment</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:id</span>=<span class="string">&quot;@+id/flavorFragment&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">...</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:label</span>=<span class="string">&quot;@string/choose_flavor&quot;</span> <span class="attr">...</span> &gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">action</span> <span class="attr">...</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">fragment</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">fragment</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:id</span>=<span class="string">&quot;@+id/pickupFragment&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">...</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:label</span>=<span class="string">&quot;@string/choose_pickup_date&quot;</span> <span class="attr">...</span> &gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">action</span> <span class="attr">...</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">fragment</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">fragment</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:id</span>=<span class="string">&quot;@+id/summaryFragment&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">...</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:label</span>=<span class="string">&quot;@string/order_summary&quot;</span> <span class="attr">...</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">navigation</span>&gt;</span></span><br></pre></td></tr></table></figure>

<ol start="6">
<li>執行應用程式。請注意，在您前往各個 fragment 目的地時，app bar 中的標題會隨之變更。另請注意，app bar 上會顯示「Up」按鈕 (箭頭 ←)。如果輕觸按鈕，則不會採取任何行動。在下一個程式碼研究室中，您會實作「Up」按鈕行為。</li>
</ol>
<hr>
<h3 id="建立共用-ViewModel"><a href="#建立共用-ViewModel" class="headerlink" title="建立共用 ViewModel"></a>建立共用 ViewModel</h3><p>現在要開始在各個 fragments 中填入正確 data。您將使用共用 <code>ViewModel</code> 將 app data 儲存在單一 <code>ViewModel</code> 中。app 中的多個 fragments 會使用其 activity 範圍(scope)來存取共用的(shared) <code>ViewModel</code>。</p>
<p>在大部分 production app 中，不同 fragments 間共用 data 是常見的用途。舉例來說，在 <strong>Cupcake</strong> app 的(本程式碼實驗室)最終版本中(請注意下方螢幕截圖)，使用者在第一個畫面選取杯子蛋糕數量，系統在第二個畫面依杯子蛋糕的數量計算並顯示價格。同樣地，summary 畫面也使用口味和取貨日期等其他 app data。</p>
<img src="https://developer.android.com/static/codelabs/basic-android-kotlin-training-shared-viewmodel/img/3b6a68cab0b9ee2_1920.png?hl=zh-tw">

<p>從 app 功能的角度來看，您可以選擇將這筆訂單資訊儲存在單一 <code>ViewModel</code> 中，即可在此 activity 中的各 fragments 之間共用。請記得 <code>ViewModel</code> 是 Android 架構元件的一部分。在設定變更期間，會保留儲存在 <code>ViewModel</code> 中的 app data。若要在 app 中新增 <code>ViewModel</code>，您必須建立可從 <code>ViewModel</code> class 擴充的新 class。</p>
<h4 id="建立-OrderViewModel"><a href="#建立-OrderViewModel" class="headerlink" title="建立 OrderViewModel"></a>建立 OrderViewModel</h4><p>在這項工作中，您會為稱為 <code>OrderViewModel</code> 的 Cupcake app 建立共用的 <code>ViewModel</code>。您也會將 app data 新增為 <code>ViewModel</code> 及方法中的屬性，用於更新及修改資料。以下是類別的屬性：</p>
<ul>
<li>Order quantity(訂單數量)：<code>Integer</code></li>
<li>Cupcake flavor(杯子蛋糕口味)：<code>String</code></li>
<li>Pickup date(取貨日期)：<code>String</code></li>
<li>Price(價格)：<code>Double</code></li>
</ul>
<h5 id="採用-ViewModel-最佳做法"><a href="#採用-ViewModel-最佳做法" class="headerlink" title="採用 ViewModel 最佳做法"></a>採用 ViewModel 最佳做法</h5><p>在 <code>ViewModel</code>，建議您勿將 view model data 設為 <code>public</code> 變數。否則，app data 可能會被外部 class 以意想不到的方式修改，並造成 app 無法預料的情況。應將這些可變動(mutable)的屬性設為 <code>private</code>，並導入 backing property，並視需要公開每個屬性的 <code>public</code> 不可變動(immutable)版本。慣例是在 <code>private</code> 可變動屬性名稱前面加上 (<code>_</code>) 作為前綴。</p>
<p>請根據使用者的選擇，採用下列方式更新上述屬性：</p>
<ul>
<li><code>setQuantity(numberCupcakes: Int)</code></li>
<li><code>setFlavor(desiredFlavor: String)</code></li>
<li><code>setDate(pickupDate: String)</code></li>
</ul>
<p><code>Price</code> 不需要 <code>setter</code> 方法，因為您將使用其他屬性在 <code>OrderViewModel</code> 內計算價格。下列步驟將說明如何導入共用 <code>ViewModel</code>。</p>
<p>您將在專案中建立名為 <code>model</code> 的新 package，並新增 <code>OrderViewModel</code> class。如此一來，系統會分隔 view model 程式碼與 UI 程式碼(fragment 和 activity)。根據功能，將程式碼分隔為不同 package 是程式設計的最佳做法。</p>
<ol>
<li><p>在 Android Studio 的「Project」視窗中，以滑鼠右鍵按一下「com.example.cupcake」 &gt;「New」 &gt;「Package」。</p>
</li>
<li><p>系統會開啟「New Package」對話方塊，將套件命名為 <code>com.example.cupcake.model</code>。</p>
</li>
<li><p>在 <code>model</code> package 之下建立 <code>OrderViewModel</code> Kotlin class。在「Project」視窗中，以滑鼠右鍵按一下 <code>model</code> package，然後選取「New」&gt;「Kotlin File&#x2F;Class」。在新 dialog 中，給予檔案名稱 <code>OrderViewModel</code>。</p>
</li>
<li><p>在 <code>OrderViewModel.kt</code> 中，變更 class signature 以從 <code>ViewModel</code> 擴展&#x2F;延伸。</p>
</li>
</ol>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> androidx.lifecycle.ViewModel</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">OrderViewModel</span> : <span class="type">ViewModel</span>() &#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="5">
<li><p>在 <code>OrderViewModel</code> class 中，將上述討論的屬性新增為 <code>private</code> <code>val</code>。</p>
</li>
<li><p>請將屬性 type 變更為 <code>LiveData</code>，然後在屬性中加入 backing fields，這樣這些屬性就可觀察(observable)，當 view model 中的 source data 發生變化時，UI 就會更新。</p>
</li>
</ol>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* 杯子蛋糕數量 */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">val</span> _quantity = MutableLiveData&lt;<span class="built_in">Int</span>&gt;(<span class="number">0</span>) <span class="comment">// 內部可變動(mutable)</span></span><br><span class="line"><span class="keyword">val</span> quantity: LiveData&lt;<span class="built_in">Int</span>&gt; = _quantity <span class="comment">// 外部不可變動(immutable)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* 杯子蛋糕口味 */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">val</span> _flavor = MutableLiveData&lt;String&gt;(<span class="string">&quot;&quot;</span>) <span class="comment">// 內部可變動(mutable)</span></span><br><span class="line"><span class="keyword">val</span> flavor: LiveData&lt;String&gt; = _flavor <span class="comment">// 外部不可變動(immutable)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* 取貨日期 */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">val</span> _date = MutableLiveData&lt;String&gt;(<span class="string">&quot;&quot;</span>) <span class="comment">// 內部可變動(mutable)</span></span><br><span class="line"><span class="keyword">val</span> date: LiveData&lt;String&gt; = _date <span class="comment">// 外部不可變動(immutable)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* 價格 */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">val</span> _price = MutableLiveData&lt;<span class="built_in">Double</span>&gt;(<span class="number">0.0</span>) <span class="comment">// 內部可變動(mutable)</span></span><br><span class="line"><span class="keyword">val</span> price: LiveData&lt;<span class="built_in">Double</span>&gt; = _price <span class="comment">// 外部不可變動(immutable)</span></span><br></pre></td></tr></table></figure>

<p>您必須 import 以下 class：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> androidx.lifecycle.LiveData</span><br><span class="line"><span class="keyword">import</span> androidx.lifecycle.MutableLiveData</span><br></pre></td></tr></table></figure>

<ol start="7">
<li><p>在 <code>OrderViewModel</code> class 中，新增上述方法。在方法中，傳入可變動屬性(mutable)的參數。</p>
</li>
<li><p>由於這些 <code>setter</code> 方法需要從 view model 外呼叫，因此請將其保留為 <code>public</code> 方法，也就是不需要在 <code>fun</code> 關鍵字之前使用 <code>private</code> 或其他瀏覽權限修飾符。Kotlin 中的預設瀏覽權限修飾符設定為 <code>public</code>。</p>
</li>
</ol>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">setQuantity</span><span class="params">(numberCupcakes: <span class="type">Int</span>)</span></span> &#123;</span><br><span class="line">    _quantity.value = numberCupcakes</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">setFlavor</span><span class="params">(desiredFlavor: <span class="type">String</span>)</span></span> &#123;</span><br><span class="line">    _flavor.value = desiredFlavor</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">setDate</span><span class="params">(pickupDate: <span class="type">String</span>)</span></span> &#123;</span><br><span class="line">    _date.value = pickupDate</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="9">
<li>建構並執行應用程式，確保不會發生編譯錯誤。UI 不應出現任何可見的變更。</li>
</ol>
<p>做得好！現在，您已經開始使用 view model。隨著您在 app 中建構更多功能，您會逐漸向此 class 添加更多程式碼。</p>
<p>如果您在 Android Studio 中看到以灰色字型顯示的類別名稱、屬性名稱或方法名稱，這是正常現象。這表示類別、屬性或方法或是目前未使用，但一定會存在！</p>
<hr>
<h3 id="使用-ViewModel-更新-UI"><a href="#使用-ViewModel-更新-UI" class="headerlink" title="使用 ViewModel 更新 UI"></a>使用 ViewModel 更新 UI</h3><p>在這項工作中，您將使用所建立的共用 view model 來更 app 的 UI。導入共用 view model 的主要差異，就是<u>從 <b>UI Controller</b> 存取該 model 的方式</u>。您將使用 <strong>activity instance</strong> 而非 <strong>fragment instance</strong>，後續章節將示範如何執行這項作業。</p>
<p>意指<u>可在各 <b>fragment</b> 之間共用 <b>view model</b></u>。<u>每個 <b>fragment</b> 都可以存取 <b>view model</b></u>，藉此查看訂單的部分詳細資訊，或是在 view model 中更新部分 <strong>data</strong>。</p>
<h4 id="★更新-StartFragment-即可使用-view-model"><a href="#★更新-StartFragment-即可使用-view-model" class="headerlink" title="★更新 StartFragment 即可使用 view model"></a>★更新 StartFragment 即可使用 view model</h4><p>如要在 <code>StartFragment</code> 中使用共用 view model，您必須使用 <code>activityViewModels()</code> 而非 <code>viewModels()</code> 委派類別來初始化 <code>OrderViewModel</code>。</p>
<ul>
<li><code>viewModels()</code> <b>範圍(scope)</b>：限定於<u>目前 <b>fragment</b> 的 <code>ViewModel</code> instance</u>。不同 fragment 各有所不同。</li>
<li><code>activityViewModels()</code> <b>範圍(scope)</b>：限定於<u>目前 <b>activity</b> 的 <code>ViewModel</code> instance</u>。因此，<span class="label primary">在相同 <b>activity</b> 中的多個 <b>fragment</b> 中，<b>instance</b> 會保持不變</span>。</li>
</ul>
<h5 id="使用-Kotlin-property-delegate"><a href="#使用-Kotlin-property-delegate" class="headerlink" title="使用 Kotlin property delegate"></a>使用 Kotlin property delegate</h5><p>在 Kotlin 中，每個可變動 (<code>var</code>) 屬性都會自動產生屬性的 <code>getter</code> 和 <code>setter</code> 函式。當您設定屬性的 value 或讀取屬性的 value 時，會呼叫 <code>setter</code> 和 <code>getter</code> 函式。(針對唯讀屬性 (<code>val</code>)，根據預設只會產生 <code>getter</code> 函式。在讀取唯讀屬性的 value 時，會呼叫 <code>getter</code> 函式。)</p>
<ul>
<li>Kotlin 中的 <strong>property delegate</strong> 功能可協助您將 <code>getter-setter</code> 責任移交給其他 class。</li>
<li>此 class (稱為「<strong>delegate class</strong>」) 可提供屬性的 <code>getter</code> 和 <code>setter</code> 函式，並處理其變更。</li>
</ul>
<p>delegate property 是使用 <code>by</code> 子句和 delegate class instance 來定義：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Syntax for property delegation</span></span><br><span class="line"><span class="keyword">var</span> &lt;property-name&gt; : &lt;property-type&gt; <span class="keyword">by</span> &lt;delegate-<span class="keyword">class</span>&gt;()</span><br></pre></td></tr></table></figure>

<ol>
<li>在 <code>StartFragment</code> class 中，取得共用 view model 的引用做為 class 變數。使用 <code>fragment-ktx</code> library 中的 <code>by activityViewModels()</code> Kotlin property delegate。</li>
</ol>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">val</span> sharedViewModel: OrderViewModel <span class="keyword">by</span> activityViewModels()</span><br></pre></td></tr></table></figure>

<p>您可能需要 import 以下新資料：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> androidx.fragment.app.activityViewModels</span><br><span class="line"><span class="keyword">import</span> com.example.cupcake.model.OrderViewModel</span><br></pre></td></tr></table></figure>

<ol start="2">
<li><p>針對 <code>FlavorFragment</code>、<code>PickupFragment</code>、<code>SummaryFragment</code> class 重複上述步驟，您將在程式碼研究室的後續章節中使用此 <code>sharedViewModel</code> instance。</p>
</li>
<li><p>返回 <code>StartFragment</code> class 後，即可使用 view model。在 <code>orderCupcake()</code> 方法的開頭，先在共用 view model 中呼叫 <code>setQuantity()</code> 方法來更新數量，之後再前往 flavor fragment。</p>
</li>
</ol>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">orderCupcake</span><span class="params">(quantity: <span class="type">Int</span>)</span></span> &#123;</span><br><span class="line">    sharedViewModel.setQuantity(quantity)</span><br><span class="line">    findNavController().navigate(R.id.action_startFragment_to_flavorFragment)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="4">
<li>在 <code>OrderViewModel</code> class 中新增下列方法以檢查是否已設定訂單的口味。您將在後續步驟中在 <code>StartFragment</code> class 中使用此方法。</li>
</ol>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">hasNoFlavorSet</span><span class="params">()</span></span>: <span class="built_in">Boolean</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> _flavor.value.isNullOrEmpty()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="5">
<li>在 <code>StartFragment</code> class 中的 <code>orderCupcake()</code> 方法中，在設定數量後，若未設定口味，則先將預設口味設定為「Vanilla」(香草)，之後再前往 flavor fragment。完整的方法看起來會像這樣：</li>
</ol>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">orderCupcake</span><span class="params">(quantity: <span class="type">Int</span>)</span></span> &#123;</span><br><span class="line">    sharedViewModel.setQuantity(quantity)</span><br><span class="line">    <span class="keyword">if</span> (sharedViewModel.hasNoFlavorSet()) &#123;</span><br><span class="line">        sharedViewModel.setFlavor(getString(R.string.vanilla))</span><br><span class="line">    &#125;</span><br><span class="line">    findNavController().navigate(R.id.action_startFragment_to_flavorFragment)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="6">
<li>建構 app 以確保不會發生編譯錯誤。但 UI 並不會出現任何可見的變更。</li>
</ol>
<hr>
<h3 id="搭配使用-ViewModel-與-data-binding"><a href="#搭配使用-ViewModel-與-data-binding" class="headerlink" title="搭配使用 ViewModel 與 data binding"></a>搭配使用 ViewModel 與 data binding</h3><p>接下來，您需要使用 <strong>data binding</strong> 將 <strong>view model data</strong> 綁定(bind)至 <strong>UI</strong>。系統也會根據使用者在 UI 中的選擇，更新共用 view model。</p>
<p><strong>複習 data binding</strong><br>請注意，<strong>data binding library</strong> 是 <strong>Android Jetpack</strong> 的一部分。data binding 使用宣告式格式，<u>將 layout 中的 ，<b>UI 元件</b> bind 至 app 中的 <b>resource data</b></u>。簡單來說，<strong>data binding</strong> 將 <strong>data</strong> (從程式碼)  bind 至 <strong>views + view binding</strong> (binding views to code)。設定這些 bindings，並啟用自動進行更新後，即使您忘記從程式碼手動更新 UI，也能降低錯誤發生的機率。</p>
<h4 id="用使用者的選擇來更新-flavor"><a href="#用使用者的選擇來更新-flavor" class="headerlink" title="用使用者的選擇來更新 flavor"></a>用使用者的選擇來更新 flavor</h4><ol>
<li>在 <code>layout/fragment_flavor.xml</code> 中，在根 <code>&lt;layout&gt;</code> 標記內新增　<code>&lt;data&gt;</code> 標記。新增 <code>name</code> 為 <code>viewModel</code> 且 <code>type</code> 為 <code>com.example.cupcake.model.OrderViewModel</code> 的 layout 變數。請確認 <code>type</code> 屬性中的 package name 與 app 內共用 view model class <code>OrderViewModel</code> 的 package name 相同。</li>
</ol>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">layout</span> <span class="attr">...</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">data</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">variable</span></span></span><br><span class="line"><span class="tag">            <span class="attr">name</span>=<span class="string">&quot;viewModel&quot;</span></span></span><br><span class="line"><span class="tag">            <span class="attr">type</span>=<span class="string">&quot;com.example.cupcake.model.OrderViewModel&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">data</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">ScrollView</span> <span class="attr">...</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    ...</span><br></pre></td></tr></table></figure>

<ol start="2">
<li><p>同樣地，請針對 <code>fragment_pickup.xml</code> 及 <code>fragment_summary.xml</code> 重複上率步驟以新增 <code>viewModel</code> layout 變數。您將在接下來幾節中使用此變數。<code>fragment_start.xml</code> 未使用共用 view model，因此您不需要在此 layout 中加入這段程式碼。</p>
</li>
<li><p>在 <code>FlavorFragment</code> class 的 <code>onViewCreated()</code> 中，將 view model instance 與 layout model 中的共用 view model instance 綁定(bind)。在 <code>binding?.apply</code> 區塊中加入以下程式碼。</p>
</li>
</ol>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">binding?.apply &#123;</span><br><span class="line">    <span class="comment">// 設定 viewModel 為共用 view model</span></span><br><span class="line">    <span class="keyword">this</span>.viewModel = sharedViewModel</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="套用-scope-函式"><a href="#套用-scope-函式" class="headerlink" title="套用 scope 函式"></a>套用 scope 函式</h5><p>這可能是您首次在 Kotlin 中看到 <code>apply</code> 函式。<code>apply</code> 是 Kotlin 標準 library 中的 <a target="_blank" rel="noopener" href="https://kotlinlang.org/docs/scope-functions.html">scope function</a>。會在物件 context 內執行 code block。這樣可以建立<b>臨時範圍(temporary scope)</b>，而且您可以<u>在該<b>範圍(scope)</b>中即可存取物件而無需物件名稱</u>。<code>apply</code> 的常見用途是<u>設定物件</u>。這類呼叫可以解讀為「套用下列指派作業(assignments)至物件」。</p>
<p>範例：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">clark.apply &#123;</span><br><span class="line">    firstName = <span class="string">&quot;Clark&quot;</span></span><br><span class="line">    lastName = <span class="string">&quot;James&quot;</span></span><br><span class="line">    age = <span class="number">18</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 沒有套用 scope function 的程式碼如下所示。</span></span><br><span class="line">clark.firstName = <span class="string">&quot;Clark&quot;</span></span><br><span class="line">clark.lastName = <span class="string">&quot;James&quot;</span></span><br><span class="line">clark.age = <span class="number">18</span></span><br></pre></td></tr></table></figure>

<ol start="4">
<li>在 <code>PickupFragment</code> 和 <code>SummaryFragment</code> class 中，針對 <code>onViewCreated()</code> 方法重複上述步驟。</li>
</ol>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">binding?.apply &#123;</span><br><span class="line">    <span class="comment">// 設定 viewModel 為共用 view model</span></span><br><span class="line">    <span class="keyword">this</span>.viewModel = sharedViewModel</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="5">
<li>在 <code>fragment_flavor.xml</code> 中，使用新的 layout 變數 <code>viewModel</code>，根據 view model 的 flavor 值，設定 radio button 的 <code>checked</code> 屬性。如果 radio button 表示的 flavor 與儲存在 view model 中的 flavor 相同，則 radio button 顯示為已選取 (<code>checked = true</code>)。已選取「Vanilla」(香草) <code>RadioButton</code> 的 binding 運算式如下所示：</li>
</ol>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">@&#123;viewModel.flavor.equals(@string/vanilla)&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>基本上，您會使用 <code>equals</code> 函式來比較 <code>viewModel.flavor</code> 屬性與對應的字串資源，藉此判定已檢查狀態是 <code>True</code> 還是 <code>False</code>。</li>
</ul>
<div class="note no-icon success">
            <p><strong>注意：</strong> 請記得，binding 運算式以 <code>@</code> 符號開頭，並放在大括號 <code>{}</code> 內。</p>
          </div>

<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">RadioGroup</span></span></span><br><span class="line"><span class="tag">   <span class="attr">...</span>&gt;</span></span><br><span class="line"></span><br><span class="line">   <span class="tag">&lt;<span class="name">RadioButton</span></span></span><br><span class="line"><span class="tag">       <span class="attr">android:id</span>=<span class="string">&quot;@+id/vanilla&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">...</span></span></span><br><span class="line"><span class="tag">       <span class="attr">android:checked</span>=<span class="string">&quot;@&#123;viewModel.flavor.equals(@string/vanilla)&#125;&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">...</span>/&gt;</span></span><br><span class="line"></span><br><span class="line">   <span class="tag">&lt;<span class="name">RadioButton</span></span></span><br><span class="line"><span class="tag">       <span class="attr">android:id</span>=<span class="string">&quot;@+id/chocolate&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">...</span></span></span><br><span class="line"><span class="tag">       <span class="attr">android:checked</span>=<span class="string">&quot;@&#123;viewModel.flavor.equals(@string/chocolate)&#125;&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">...</span>/&gt;</span></span><br><span class="line"></span><br><span class="line">   <span class="tag">&lt;<span class="name">RadioButton</span></span></span><br><span class="line"><span class="tag">       <span class="attr">android:id</span>=<span class="string">&quot;@+id/red_velvet&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">...</span></span></span><br><span class="line"><span class="tag">       <span class="attr">android:checked</span>=<span class="string">&quot;@&#123;viewModel.flavor.equals(@string/red_velvet)&#125;&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">...</span>/&gt;</span></span><br><span class="line"></span><br><span class="line">   <span class="tag">&lt;<span class="name">RadioButton</span></span></span><br><span class="line"><span class="tag">       <span class="attr">android:id</span>=<span class="string">&quot;@+id/salted_caramel&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">...</span></span></span><br><span class="line"><span class="tag">       <span class="attr">android:checked</span>=<span class="string">&quot;@&#123;viewModel.flavor.equals(@string/salted_caramel)&#125;&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">...</span>/&gt;</span></span><br><span class="line"></span><br><span class="line">   <span class="tag">&lt;<span class="name">RadioButton</span></span></span><br><span class="line"><span class="tag">       <span class="attr">android:id</span>=<span class="string">&quot;@+id/coffee&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">...</span></span></span><br><span class="line"><span class="tag">       <span class="attr">android:checked</span>=<span class="string">&quot;@&#123;viewModel.flavor.equals(@string/coffee)&#125;&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">...</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">RadioGroup</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h4 id="Listener-bindings"><a href="#Listener-bindings" class="headerlink" title="Listener bindings"></a>Listener bindings</h4><p><strong>Listener bindings</strong> 是指在 event 發生 (例如 <code>onClick</code> event) 時執行的 <code>lambda</code> 運算式。做法類似於 method 引用 (例如 <code>textview.setOnClickListener(clickListener))</code>，但 listener bindings 可讓您執行任意 data binding 運算式。</p>
<ol>
<li>在 <code>fragment_flavor.xml</code> 中，使用 <strong>listener bindings</strong> 將 <strong>event listeners</strong> 新增至 <strong>radio buttons</strong>。使用不含參數的 <code>lambda</code> 運算式，並呼叫 <code>viewModel</code>。<code>setFlavor()</code> method 藉由傳入對應的 <u>flavor 字串資源(string resource)</u>。</li>
</ol>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">RadioGroup</span></span></span><br><span class="line"><span class="tag">   <span class="attr">...</span>&gt;</span></span><br><span class="line"></span><br><span class="line">   <span class="tag">&lt;<span class="name">RadioButton</span></span></span><br><span class="line"><span class="tag">       <span class="attr">android:id</span>=<span class="string">&quot;@+id/vanilla&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">...</span></span></span><br><span class="line"><span class="tag">       <span class="attr">android:onClick</span>=<span class="string">&quot;@&#123;() -&gt; viewModel.setFlavor(@string/vanilla)&#125;&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">...</span>/&gt;</span></span><br><span class="line"></span><br><span class="line">   <span class="tag">&lt;<span class="name">RadioButton</span></span></span><br><span class="line"><span class="tag">       <span class="attr">android:id</span>=<span class="string">&quot;@+id/chocolate&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">...</span></span></span><br><span class="line"><span class="tag">       <span class="attr">android:onClick</span>=<span class="string">&quot;@&#123;() -&gt; viewModel.setFlavor(@string/chocolate)&#125;&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">...</span>/&gt;</span></span><br><span class="line"></span><br><span class="line">   <span class="tag">&lt;<span class="name">RadioButton</span></span></span><br><span class="line"><span class="tag">       <span class="attr">android:id</span>=<span class="string">&quot;@+id/red_velvet&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">...</span></span></span><br><span class="line"><span class="tag">       <span class="attr">android:onClick</span>=<span class="string">&quot;@&#123;() -&gt; viewModel.setFlavor(@string/red_velvet)&#125;&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">...</span>/&gt;</span></span><br><span class="line"></span><br><span class="line">   <span class="tag">&lt;<span class="name">RadioButton</span></span></span><br><span class="line"><span class="tag">       <span class="attr">android:id</span>=<span class="string">&quot;@+id/salted_caramel&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">...</span></span></span><br><span class="line"><span class="tag">       <span class="attr">android:onClick</span>=<span class="string">&quot;@&#123;() -&gt; viewModel.setFlavor(@string/salted_caramel)&#125;&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">...</span>/&gt;</span></span><br><span class="line"></span><br><span class="line">   <span class="tag">&lt;<span class="name">RadioButton</span></span></span><br><span class="line"><span class="tag">       <span class="attr">android:id</span>=<span class="string">&quot;@+id/coffee&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">...</span></span></span><br><span class="line"><span class="tag">       <span class="attr">android:onClick</span>=<span class="string">&quot;@&#123;() -&gt; viewModel.setFlavor(@string/coffee)&#125;&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">...</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">RadioGroup</span>&gt;</span></span><br></pre></td></tr></table></figure>

<ol start="7">
<li>執行 app，並注意在 flavor fragment 中如何依據預設選取的「Vanilla」(香草) 選項。</li>
</ol>
<img src="https://developer.android.com/static/codelabs/basic-android-kotlin-training-shared-viewmodel/img/3095e824b4817b98_1920.png?hl=zh-tw" width="30%">

<p>漂亮！現在可以移到下一個 fragments。</p>
<hr>
<h3 id="更新-pickup-和-summary-fragment-以使用-view-model"><a href="#更新-pickup-和-summary-fragment-以使用-view-model" class="headerlink" title="更新 pickup 和 summary fragment 以使用 view model"></a>更新 pickup 和 summary fragment 以使用 view model</h3><p>Navigate 應用程式，並留意，在 pickup fragment 中的 radio button option labels 為空白。在這項工作中，會計算 4 個可用的<b>取貨日期(pickup dates)</b>，並顯示在 <b>pickup fragment</b> 中。有很多種顯示<b>格式化(formatted)日期</b>的方法，Android 提供多種實用的公用程式(utilities)來執行此動作。</p>
<h4 id="建立-pickup-options-list"><a href="#建立-pickup-options-list" class="headerlink" title="建立 pickup options list"></a>建立 pickup options list</h4><h5 id="Date-formatter"><a href="#Date-formatter" class="headerlink" title="Date formatter"></a>Date formatter</h5><p>Android 架構提供一個稱為 <code>SimpleDateFormat</code> 的 class，該 class 會以區分地區設定方式來格式化並剖析 date。這允許 date 進行<span class="label primary">格式化 (date → text)</span> 及<span class="label primary">剖析 (text → date)</span>。</p>
<p>您可以傳入<u>格式字串(pattern string)</u>和<u>地區設定(locale)</u>，以建立 <code>SimpleDateFormat</code> 的 instance：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SimpleDateFormat(<span class="string">&quot;E MMM d&quot;</span>, Locale.getDefault())</span><br></pre></td></tr></table></figure>

<p><code>&quot;E MMM d&quot;</code> 等格式字串(pattern string)表示 <code>Date</code> 和 <code>Time</code> 格式(formats)。從 <code>&#39;A&#39;</code> 到 <code>&#39;Z&#39;</code> 和 <code>&#39;a&#39;</code> 到 <code>&#39;z&#39;</code> 的字母都會視為 pattern letters，代表 date 或 time string 的元件(components)。例如，<code>d</code> 代表一個月中的日期(day in a month)、<code>y</code> 代表年份(year)，<code>M</code> 代表月份(month)。如果 date 是 2018 年 1 月 4 日，則 pattern string <code>&quot;EEE, MMM d&quot;</code> 會剖析為 <code>&quot;Wed, Jul 4&quot;</code>。若需完整的 pattern letters 清單，請參閱<a target="_blank" rel="noopener" href="https://developer.android.com/reference/java/text/SimpleDateFormat#date-and-time-patterns">說明文件</a>。</p>
<p><a target="_blank" rel="noopener" href="https://developer.android.com/reference/java/util/Locale">Locale</a> 物件代表特定的地理區域、政治或文化區域。代表語言&#x2F;國家&#x2F;地區&#x2F;變化版本(variant)組合。Locales 會根據當地慣例來改變資訊 (例如 numbers 或 dates) 的顯示方式。由於世界不同地區表達日期和時間的格式不同，因此日期和時間會依地區設定而有所不同。您將使用 <code>Locale.getDefault()</code> 方法擷取使用者裝置上設定的 locale 資訊，並傳遞至 <code>SimpleDateFormat</code> 建構函式(constructor)中。</p>
<p>Android 中的 Locale 是 language 和 country code 的組合。 language codes 是兩個小寫英文字母 ISO language codes，例如「en」表示英文。country codes 是由兩個大寫英文字母組成的 ISO country codes，例如美國為「US」。</p>
<p>現在使用 <code>SimpleDateFormat</code> 和 <code>Locale</code> 來判斷 Cupcake app 的可取貨日期(pickup date)。</p>
<ol>
<li>在 <code>OrderViewModel</code> class 中新增名為 <code>getPickupOptions()</code> 的函式，以便建立並回傳(return) pickup dates list。在方法中，建立一個名為 <code>options</code> 的 <code>val</code> 變數，然後初始化為 <code>mutableListOf&lt;String&gt;()</code>。</li>
</ol>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">fun</span> <span class="title">getPickupOptions</span><span class="params">()</span></span>: List&lt;String&gt; &#123;</span><br><span class="line">   <span class="keyword">val</span> options = mutableListOf&lt;String&gt;()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>使用 <code>SimpleDateFormat</code> 傳遞 pattern string <code>&quot;E MMM d&quot;</code> 和 locale 來建立 formatter string。在 pattern string 中，<code>E</code> 代表星期幾，且會剖析為「Tue Dec 10」。</li>
</ol>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> formatter = SimpleDateFormat(<span class="string">&quot;E MMM d&quot;</span>, Locale.getDefault())</span><br></pre></td></tr></table></figure>
<ul>
<li>當 Android Studio 出現提示時，import <code>java.text.SimpleDateFormat</code> 和 <code>java.util.Locale</code>。</li>
</ul>
<ol start="3">
<li>取得 <code>Calendar</code> instance 並 assign 給新的變數(variable)，將其設定為 <code>val</code>。此變數會包含目前的日期(date)和時間(time)。而且 import <code>java.util.Calendar</code>。</li>
</ol>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> calendar = Calendar.getInstance()</span><br></pre></td></tr></table></figure>

<ol start="4">
<li>建置當天日期(current date)加上後續三個日期(following three dates)的 <strong>date list</strong>。由於這需要 4 個 date options，請重複此程式碼區塊 4 次。此 <code>repeat</code> 區塊會格式化日期(format a date)，將其加到 date options list 中，然後將日曆(calendar)增加 1 天。</li>
</ol>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">repeat(<span class="number">4</span>) &#123;</span><br><span class="line">    options.add(formatter.format(calendar.time))</span><br><span class="line">    calendar.add(Calendar.DATE, <span class="number">1</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="5">
<li>在 method 的結尾 return 更新後的 <code>options</code>。以下是已完成的 method：</li>
</ol>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">fun</span> <span class="title">getPickupOptions</span><span class="params">()</span></span>: List&lt;String&gt; &#123;</span><br><span class="line">   <span class="keyword">val</span> options = mutableListOf&lt;String&gt;()</span><br><span class="line">   <span class="keyword">val</span> formatter = SimpleDateFormat(<span class="string">&quot;E MMM d&quot;</span>, Locale.getDefault())</span><br><span class="line">   <span class="keyword">val</span> calendar = Calendar.getInstance()</span><br><span class="line">   <span class="comment">// Create a list of dates starting with the current date and the following 3 dates</span></span><br><span class="line">   repeat(<span class="number">4</span>) &#123;</span><br><span class="line">       options.add(formatter.format(calendar.time))</span><br><span class="line">       calendar.add(Calendar.DATE, <span class="number">1</span>)</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">return</span> options</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="6">
<li>在 <code>OrderViewModel</code> class 中，新增名為 <code>val</code> 的 class 屬性 <code>dateOptions</code>。使用您剛剛建立的 <code>getPickupOptions()</code> 方法進行初始化。</li>
</ol>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> dateOptions = getPickupOptions()</span><br></pre></td></tr></table></figure>

<h4 id="更新-layout-以顯示-pickup-options"><a href="#更新-layout-以顯示-pickup-options" class="headerlink" title="更新 layout 以顯示 pickup options"></a>更新 layout 以顯示 pickup options</h4><p>現在 view model 中有四個可用的 pickup dates，更新 <code>fragment_pickup.xml</code> layout 以顯示這些日期。您還可以使用 data binding 來顯示每個 radio button 的已勾選(checked)狀態，並在選取不同 radio button 時更新 view model 的日期。實作方式類似於 flavor fragment 中的 data binding。</p>
<p>在 <code>fragment_pickup.xml</code> 中：</p>
<ul>
<li>在 <code>viewModel</code> 中，radio button <code>option0</code> 代表 <code>dateOptions[0]</code> (今天)</li>
<li>在 <code>viewModel</code> 中，radio button <code>option1</code> 代表 <code>dateOptions[1]</code> (明天)</li>
<li>在 <code>viewModel</code> 中，radio button <code>option2</code> 代表 <code>dateOptions[2]</code> (後天)</li>
<li>在 <code>viewModel</code> 中，radio button <code>option3</code> 代表 <code>dateOptions[3]</code> (大後天)</li>
</ul>
<ol>
<li>在 <code>fragment_pickup.xml</code> 中，針對 <code>option0</code> radio button 使用新的 layout 變數 <code>viewModel</code>，以便根據 view model 中的 <code>date</code> 值來設定 <code>checked</code> 屬性。比較 <code>viewModel.date</code> 屬性與 <code>dateOptions</code> list 中的第一個字串 (也就是當天日期)。使用 <code>equals</code> 函式進行比較，最終 binding 運算式如下所示：</li>
</ol>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">@&#123;viewModel.date.equals(viewModel.dateOptions[<span class="number">0</span>])&#125;</span><br></pre></td></tr></table></figure>

<ol start="2">
<li><p>針對相同的 radio button，使用 listener binding 新增 event listener 至 <code>onClick</code> 屬性。按一下此按鈕後，<code>viewModel</code> 就會呼叫 <code>setDate()</code>，傳入 <code>dateOptions[0]</code>。</p>
</li>
<li><p>如果是相同的 radio button，請將 <code>text</code> 屬性值設定為 <code>dateOptions</code> list 中的第一個字串。</p>
</li>
</ol>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">RadioButton</span></span></span><br><span class="line"><span class="tag">   <span class="attr">android:id</span>=<span class="string">&quot;@+id/option0&quot;</span></span></span><br><span class="line"><span class="tag">   <span class="attr">...</span></span></span><br><span class="line"><span class="tag">   <span class="attr">android:checked</span>=<span class="string">&quot;@&#123;viewModel.date.equals(viewModel.dateOptions[0])&#125;&quot;</span></span></span><br><span class="line"><span class="tag">   <span class="attr">android:onClick</span>=<span class="string">&quot;@&#123;() -&gt; viewModel.setDate(viewModel.dateOptions[0])&#125;&quot;</span></span></span><br><span class="line"><span class="tag">   <span class="attr">android:text</span>=<span class="string">&quot;@&#123;viewModel.dateOptions[0]&#125;&quot;</span></span></span><br><span class="line"><span class="tag">   <span class="attr">...</span></span></span><br><span class="line"><span class="tag">   /&gt;</span></span><br></pre></td></tr></table></figure>

<ol start="4">
<li>針對其他 radio button 重複上述步驟，並據此變更 <code>dateOptions</code> 的索引(index)。</li>
</ol>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">RadioButton</span></span></span><br><span class="line"><span class="tag">   <span class="attr">android:id</span>=<span class="string">&quot;@+id/option1&quot;</span></span></span><br><span class="line"><span class="tag">   <span class="attr">...</span></span></span><br><span class="line"><span class="tag">   <span class="attr">android:checked</span>=<span class="string">&quot;@&#123;viewModel.date.equals(viewModel.dateOptions[1])&#125;&quot;</span></span></span><br><span class="line"><span class="tag">   <span class="attr">android:onClick</span>=<span class="string">&quot;@&#123;() -&gt; viewModel.setDate(viewModel.dateOptions[1])&#125;&quot;</span></span></span><br><span class="line"><span class="tag">   <span class="attr">android:text</span>=<span class="string">&quot;@&#123;viewModel.dateOptions[1]&#125;&quot;</span></span></span><br><span class="line"><span class="tag">   <span class="attr">...</span> /&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">RadioButton</span></span></span><br><span class="line"><span class="tag">   <span class="attr">android:id</span>=<span class="string">&quot;@+id/option2&quot;</span></span></span><br><span class="line"><span class="tag">   <span class="attr">...</span></span></span><br><span class="line"><span class="tag">   <span class="attr">android:checked</span>=<span class="string">&quot;@&#123;viewModel.date.equals(viewModel.dateOptions[2])&#125;&quot;</span></span></span><br><span class="line"><span class="tag">   <span class="attr">android:onClick</span>=<span class="string">&quot;@&#123;() -&gt; viewModel.setDate(viewModel.dateOptions[2])&#125;&quot;</span></span></span><br><span class="line"><span class="tag">   <span class="attr">android:text</span>=<span class="string">&quot;@&#123;viewModel.dateOptions[2]&#125;&quot;</span></span></span><br><span class="line"><span class="tag">   <span class="attr">...</span> /&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">RadioButton</span></span></span><br><span class="line"><span class="tag">   <span class="attr">android:id</span>=<span class="string">&quot;@+id/option3&quot;</span></span></span><br><span class="line"><span class="tag">   <span class="attr">...</span></span></span><br><span class="line"><span class="tag">   <span class="attr">android:checked</span>=<span class="string">&quot;@&#123;viewModel.date.equals(viewModel.dateOptions[3])&#125;&quot;</span></span></span><br><span class="line"><span class="tag">   <span class="attr">android:onClick</span>=<span class="string">&quot;@&#123;() -&gt; viewModel.setDate(viewModel.dateOptions[3])&#125;&quot;</span></span></span><br><span class="line"><span class="tag">   <span class="attr">android:text</span>=<span class="string">&quot;@&#123;viewModel.dateOptions[3]&#125;&quot;</span></span></span><br><span class="line"><span class="tag">   <span class="attr">...</span> /&gt;</span></span><br></pre></td></tr></table></figure>

<ol start="5">
<li>執行應用程式後，當 pickup options 可用時就會看到未來幾天。螢幕截圖取決於您的目前日期而有所不同。請注意，依據預設不會選取任何選項。您將在下一個步驟中導入此動作。</li>
</ol>
<img src="https://developer.android.com/static/codelabs/basic-android-kotlin-training-shared-viewmodel/img/b55b3a36e2aa7be6_1920.png?hl=zh-tw" width="30%">

<ol start="6">
<li>在 <code>OrderViewModel</code> class 中，建立名為 <code>resetOrder()</code> 的函式，重設 view model 中的 <code>MutableLiveData</code> 屬性。將 <code>dateOptions</code> list 中的現在日期值(current date value)指派給 <code>_date.value</code>。</li>
</ol>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">resetOrder</span><span class="params">()</span></span> &#123;</span><br><span class="line">   _quantity.value = <span class="number">0</span></span><br><span class="line">   _flavor.value = <span class="string">&quot;&quot;</span></span><br><span class="line">   _date.value = dateOptions[<span class="number">0</span>]</span><br><span class="line">   _price.value = <span class="number">0.0</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="7">
<li>在 class 中新增 <code>init</code> 區塊，並呼叫新 method <code>resetOrder()</code>。</li>
</ol>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">init</span> &#123;</span><br><span class="line">   resetOrder()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="8">
<li>從 class 中的屬性宣告移除初始值(initial value)。現在，您可以在建立 <code>OrderViewModel</code> instance 時使用 <code>init</code> 區塊來初始化屬性。</li>
</ol>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">val</span> _quantity = MutableLiveData&lt;<span class="built_in">Int</span>&gt;()</span><br><span class="line"><span class="keyword">val</span> quantity: LiveData&lt;<span class="built_in">Int</span>&gt; = _quantity</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">val</span> _flavor = MutableLiveData&lt;String&gt;()</span><br><span class="line"><span class="keyword">val</span> flavor: LiveData&lt;String&gt; = _flavor</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">val</span> _date = MutableLiveData&lt;String&gt;()</span><br><span class="line"><span class="keyword">val</span> date: LiveData&lt;String&gt; = _date</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">val</span> _price = MutableLiveData&lt;<span class="built_in">Double</span>&gt;()</span><br><span class="line"><span class="keyword">val</span> price: LiveData&lt;<span class="built_in">Double</span>&gt; = _price</span><br></pre></td></tr></table></figure>

<ol start="9">
<li>再次執行應用程式。請注意，依據預設會選取今天的日期。</li>
</ol>
<img src="https://developer.android.com/static/codelabs/basic-android-kotlin-training-shared-viewmodel/img/bfe4f1b82977b4bc_1920.png?hl=zh-tw" width="30%">

<h4 id="更新-summary-fragment-以使用-view-model"><a href="#更新-summary-fragment-以使用-view-model" class="headerlink" title="更新 summary fragment 以使用 view model"></a>更新 summary fragment 以使用 view model</h4><p>現在介紹最後一個 fragment 。訂單 summary fragment 是用來顯示訂單詳細資料的摘要(summary)。在這項工作中，請妥善利用共用 view model 中的所有訂單資訊，並使用 data binding 來更新螢幕上的訂單詳細資料(order details)。</p>
<img src="https://developer.android.com/static/codelabs/basic-android-kotlin-training-shared-viewmodel/img/78f510e10d848dd2_1920.png?hl=zh-tw" width="30%">

<ol>
<li>請務必在 <code>fragment_summary.xml</code> 中宣告 view model data 變數 <code>viewModel</code>。</li>
</ol>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">layout</span> <span class="attr">...</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">data</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">variable</span></span></span><br><span class="line"><span class="tag">            <span class="attr">name</span>=<span class="string">&quot;viewModel&quot;</span></span></span><br><span class="line"><span class="tag">            <span class="attr">type</span>=<span class="string">&quot;com.example.cupcake.model.OrderViewModel&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">data</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">ScrollView</span> <span class="attr">...</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    ...</span><br></pre></td></tr></table></figure>

<ol start="2">
<li><p>在 <code>SummaryFragment</code> 中，在 <code>onViewCreated()</code> 中確認 <code>binding.viewModel</code> 已初始化。</p>
</li>
<li><p>在 <code>fragment_summary.xml</code> 中，從 view model 中讀取，以更新畫面中的 order summary 詳細資料(details)。新增下列 <code>text</code> 屬性來更新<b>數量(quantity)</b>、<b>口味(flavor)</b>和<b>日期(date)</b> TextViews。<b>quantity</b> 為 <code>Int</code> type，因此您必須將其轉換為 <code>String</code>。</p>
</li>
</ol>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">TextView</span></span></span><br><span class="line"><span class="tag">   <span class="attr">android:id</span>=<span class="string">&quot;@+id/quantity&quot;</span></span></span><br><span class="line"><span class="tag">   <span class="attr">...</span></span></span><br><span class="line"><span class="tag">   <span class="attr">android:text</span>=<span class="string">&quot;@&#123;viewModel.quantity.toString()&#125;&quot;</span></span></span><br><span class="line"><span class="tag">   <span class="attr">...</span> /&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">TextView</span></span></span><br><span class="line"><span class="tag">   <span class="attr">android:id</span>=<span class="string">&quot;@+id/flavor&quot;</span></span></span><br><span class="line"><span class="tag">   <span class="attr">...</span></span></span><br><span class="line"><span class="tag">   <span class="attr">android:text</span>=<span class="string">&quot;@&#123;viewModel.flavor&#125;&quot;</span></span></span><br><span class="line"><span class="tag">   <span class="attr">...</span> /&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">TextView</span></span></span><br><span class="line"><span class="tag">   <span class="attr">android:id</span>=<span class="string">&quot;@+id/date&quot;</span></span></span><br><span class="line"><span class="tag">   <span class="attr">...</span></span></span><br><span class="line"><span class="tag">   <span class="attr">android:text</span>=<span class="string">&quot;@&#123;viewModel.date&#125;&quot;</span></span></span><br><span class="line"><span class="tag">   <span class="attr">...</span> /&gt;</span></span><br></pre></td></tr></table></figure>

<ol start="4">
<li>執行並測試應用程式，確認您所選的訂單選項已顯示在訂單摘要中。</li>
</ol>
<img src="https://developer.android.com/static/codelabs/basic-android-kotlin-training-shared-viewmodel/img/7091453fa817b55_1920.png?hl=zh-tw" width="30%">

<hr>
<h3 id="根據-order-detail-計算-price"><a href="#根據-order-detail-計算-price" class="headerlink" title="根據 order detail 計算 price"></a>根據 order detail 計算 price</h3><p>查看本程式碼研究室的最終應用程式螢幕截圖時，您會注意到價格確實顯示在每個片段 (StartFragment 除外) 上，因此使用者在建立訂單時即可得知價格。</p>
<img src="https://developer.android.com/static/codelabs/basic-android-kotlin-training-shared-viewmodel/img/3b6a68cab0b9ee2_1920.png?hl=zh-tw">

<p>以下是我們的杯子蛋糕專賣店如何計算價格的規則。</p>
<ul>
<li>每個杯子蛋糕 $2.00 美元</li>
<li>對於當天取貨，訂單中會再增加 $3.00 美元</li>
</ul>
<p>因此，6 個杯子蛋糕訂單的價格為 6 個杯子蛋糕 x 每個 $2 美元 &#x3D; $12 美元。如果同一位使用者想要當天取貨，$3 美元的附加費用會讓訂單總價變成 $15 美元。</p>
<h4 id="更新-view-model-中的-price"><a href="#更新-view-model-中的-price" class="headerlink" title="更新 view model 中的 price"></a>更新 view model 中的 price</h4><p>若要在應用程式中支援這項功能，請先處理杯子蛋糕的價格(price)，並先忽略當天取貨費用。</p>
<ol>
<li>開啟 <code>OrderViewModel.kt</code>，然後將每杯子蛋糕的價格(price)儲存在變數中。在 class 定義之外 (但在 import 陳述式之後)，將此變數宣告在檔案頂端的 top-level <code>private</code> 常數。使用 <code>const</code> 修飾符，並使用 <code>val</code> 設定為唯讀。</li>
</ol>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> ...</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> ...</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">const</span> <span class="keyword">val</span> PRICE_PER_CUPCAKE = <span class="number">2.00</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">OrderViewModel</span> : <span class="type">ViewModel</span>() &#123;</span><br><span class="line">    ...</span><br></pre></td></tr></table></figure>
<ul>
<li>請記得，常數值 (在 Kotlin 中以 <code>const</code> 關鍵字標記) 不會變更，而且會在編譯期間知道該值。若要進一步瞭解常數，請參閱<a target="_blank" rel="noopener" href="https://kotlinlang.org/docs/properties.html#compile-time-constants">說明文件</a>。</li>
</ul>
<ol start="2">
<li>您已經定義了每杯子蛋糕的 price，請建立計算 price 的輔助方法。此方法可能是 <code>private</code>，因為只能在此 class 中使用。您會在下一個工作中變更 price 邏輯，以便納入當天取貨費用。</li>
</ol>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">fun</span> <span class="title">updatePrice</span><span class="params">()</span></span> &#123;</span><br><span class="line">    _price.value = (quantity.value ?: <span class="number">0</span>) * PRICE_PER_CUPCAKE</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<div class="note no-icon primary">
            <p><strong>補充：</strong> <code>A ?: B</code> 意思是「當 <code>A</code> 不為 <code>null</code> 時就返回 <code>A</code>，當 <code>A</code> 為 <code>null</code> 時就返回 <code>B</code>」</p>
          </div>

<p>這段程式碼會將每杯子蛋糕的 price 乘以所訂購的杯子蛋糕 quantity。關於括號中的程式碼，因為 <code>quantity.value</code> 的值可以是空值，所以使用 elvis 運算子 (<code>?:</code>)。elvis 運算子 (<code>?:</code>) 表示左側運算式不是空值時，則使用該運算子。如果左側運算式是空值，則使用 elvis 運算子右側的運算式 (本例中為 <code>0</code>)。</p>
<ol start="3">
<li>在相同 <code>OrderViewModel</code> class 中，在設定 quantity 時更新 price 變數。在 <code>setQuantity()</code> 函式中呼叫新函式。</li>
</ol>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">setQuantity</span><span class="params">(numberCupcakes: <span class="type">Int</span>)</span></span> &#123;</span><br><span class="line">    _quantity.value = numberCupcakes</span><br><span class="line">    updatePrice()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="將-price-屬性-bind-到-UI"><a href="#將-price-屬性-bind-到-UI" class="headerlink" title="將 price 屬性 bind 到 UI"></a>將 price 屬性 bind 到 UI</h4><ol>
<li>在 <code>fragment_flavor.xml</code>、<code>fragment_pickup.xml</code> 和 <code>fragment_summary.xml</code> 的 layouts 中，確認已定義 type 為 <code>com.example.cupcake.model.OrderViewModel</code> 的 data variable <code>viewModel</code>。</li>
</ol>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">layout</span> <span class="attr">...</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">data</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">variable</span></span></span><br><span class="line"><span class="tag">            <span class="attr">name</span>=<span class="string">&quot;viewModel&quot;</span></span></span><br><span class="line"><span class="tag">            <span class="attr">type</span>=<span class="string">&quot;com.example.cupcake.model.OrderViewModel&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">data</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">ScrollView</span> <span class="attr">...</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    ...</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>在每個 fragment class 的 <code>onViewCreated()</code> 方法中，請務必將 fragment 中的 view model 物件 instance bind 至 layout 中的 view model 資料變數(data variable)。</li>
</ol>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">binding?.apply &#123;</span><br><span class="line">    viewModel = sharedViewModel</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>在每個 fragment layout 中，如果在 layout 中有顯示 price，則使用 <code>viewModel</code> 變數來設定 price。以修改 <code>fragment_flavor.xml</code> 檔案開始。舉例而言，如果是 <code>subtotal</code> text view，請將 <code>android:text</code> 屬性的值設定為 <code>&quot;@&#123;@string/subtotal_price(viewModel.price)&#125;&quot;</code>。此 data binding layout 運算式使用字串資源 <code>@string/subtotal_price</code>，並傳入參數，亦即來自 view model 的 price，因此輸出會顯示「Subtotal 12.0」(小計 12.0)。</li>
</ol>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">TextView</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:id</span>=<span class="string">&quot;@+id/subtotal&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:text</span>=<span class="string">&quot;@&#123;@string/subtotal_price(viewModel.price)&#125;&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">...</span> /&gt;</span></span><br><span class="line"></span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>您正在使用 <code>strings.xml</code> 檔案所宣告的此字串資源：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">string</span> <span class="attr">name</span>=<span class="string">&quot;subtotal_price&quot;</span>&gt;</span>Subtotal %s<span class="tag">&lt;/<span class="name">string</span>&gt;</span></span><br></pre></td></tr></table></figure>

<ol start="4">
<li>執行應用程式。如果您在 start fragment 中選取「One cupcake」(一個杯子蛋糕)，flavor fragment 會顯示「Subtotal 2.0」(小計 2.0)。如果您選取「Six cupcake」(六個杯子蛋糕)，flavor fragment 會顯示「Subtotal 12.0」(小計 12.0)，以此類推。您稍後會將 price 格式化為適當的貨幣格式，因此此行為目前是正常現象。</li>
</ol>
<div style="display: flex;justify-content: center;">
    <div style="width:30%;float:left;margin-right:10px;">
        <img src="https://developer.android.com/static/codelabs/basic-android-kotlin-training-shared-viewmodel/img/13e316e13779d3c2_1920.png?hl=zh-tw">
    </div>
    <div style="width:30%;float:left;">
        <img src="https://developer.android.com/static/codelabs/basic-android-kotlin-training-shared-viewmodel/img/adb9342d3a0da64e_1920.png?hl=zh-tw">
    </div>
<div style="clear:both;"></div><!--這是用來清除上方的浮動效果-->
</div>

<ol start="5">
<li>現在針對 pickup 和 summary fragments 進行類似的變更。在 <code>fragment_pickup.xml</code> 和 <code>fragment_summary.xml</code> layouts 中，也修改 text views 以使用 <code>viewModel</code> <code>price</code> 屬性。</li>
</ol>
<p><code>fragment_pickup.xml</code></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">TextView</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:id</span>=<span class="string">&quot;@+id/subtotal&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">...</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:text</span>=<span class="string">&quot;@&#123;@string/subtotal_price(viewModel.price)&#125;&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">...</span> /&gt;</span></span><br><span class="line"></span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p><code>fragment_summary.xml</code></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">TextView</span></span></span><br><span class="line"><span class="tag">   <span class="attr">android:id</span>=<span class="string">&quot;@+id/total&quot;</span></span></span><br><span class="line"><span class="tag">   <span class="attr">...</span></span></span><br><span class="line"><span class="tag">   <span class="attr">android:text</span>=<span class="string">&quot;@&#123;@string/total_price(viewModel.price)&#125;&quot;</span></span></span><br><span class="line"><span class="tag">   <span class="attr">...</span> /&gt;</span></span><br></pre></td></tr></table></figure>

<ol start="6">
<li>執行應用程式。確認 order summary 中顯示的價格是按 order quantity 1、6 和 12 個杯子蛋糕正確計算所得。如前所述，預期此刻 price 格式不正確 ($2 會顯示為 2.0，$12 會顯示為 12.0)。</li>
</ol>
<div style="display: flex;justify-content: center;">
    <div style="width:30%;float:left;margin-right:10px;">
        <img src="https://developer.android.com/static/codelabs/basic-android-kotlin-training-shared-viewmodel/img/f53d06e5a3c12e96_1920.png?hl=zh-tw">
    </div>
    <div style="width:30%;float:left;">
        <img src="https://developer.android.com/static/codelabs/basic-android-kotlin-training-shared-viewmodel/img/f6eda1308338db23_1920.png?hl=zh-tw">
    </div>
<div style="clear:both;"></div><!--這是用來清除上方的浮動效果-->
</div>

<h4 id="當天取貨附加費"><a href="#當天取貨附加費" class="headerlink" title="當天取貨附加費"></a>當天取貨附加費</h4><p>在這項工作中，您將導入第二項規則，就是當天取貨會額外收取 $3.00 美元。</p>
<ol>
<li>在 <code>OrderViewModel</code> 類別中，針對當天取貨費用定義新 top-level private 常數。</li>
</ol>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">const</span> <span class="keyword">val</span> PRICE_FOR_SAME_DAY_PICKUP = <span class="number">3.00</span></span><br></pre></td></tr></table></figure>

<ol start="2">
<li>在 <code>updatePrice()</code> 中，檢查使用者是否選取了當天取貨。檢查 view model (<code>_date.value</code>) 中的日期是否與 <code>dateOptions</code> list 中的第一個項目相同 (current day)。</li>
</ol>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">fun</span> <span class="title">updatePrice</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="comment">// price = quantity * 每個杯子蛋糕的價錢</span></span><br><span class="line">    _price.value = (quantity.value ?: <span class="number">0</span>) * PRICE_PER_CUPCAKE</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 檢查使用者是否選取了當天取貨</span></span><br><span class="line">    <span class="keyword">if</span> (dateOptions[<span class="number">0</span>] == _date.value) &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>為了簡化這些計算，請引入 temporary 變數 <code>calculatedPrice</code>。計算更新的價格，然後將其重新指派給 <code>_price.value</code>。</li>
</ol>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">fun</span> <span class="title">updatePrice</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="comment">// price = quantity * 每個杯子蛋糕的價錢</span></span><br><span class="line">    <span class="keyword">var</span> calculatedPrice = (quantity.value ?: <span class="number">0</span>) * PRICE_PER_CUPCAKE</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 檢查使用者是否選取了當天取貨</span></span><br><span class="line">    <span class="keyword">if</span> (dateOptions[<span class="number">0</span>] == _date.value) &#123;</span><br><span class="line">        <span class="comment">// 將目前價格加上當天取貨費</span></span><br><span class="line">        calculatedPrice += PRICE_FOR_SAME_DAY_PICKUP</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 設 _price 的值為 calculatedPrice</span></span><br><span class="line">    _price.value = calculatedPrice</span><br><span class="line">&#125; </span><br></pre></td></tr></table></figure>

<ol start="4">
<li>從 <code>setDate()</code> method 呼叫 <code>updatePrice()</code> helper method，即可指定當天取貨費用。</li>
</ol>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">setDate</span><span class="params">(pickupDate: <span class="type">String</span>)</span></span> &#123;</span><br><span class="line">    _date.value = pickupDate</span><br><span class="line">    updatePrice()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="5">
<li>執行應用程式，navigate 應用程式。您會發現，變更取貨日期不會從 total price 中扣除當天取貨費用。這是因為在 view model 中 price 有所變更，但不會通知 binding layout。</li>
</ol>
<img src="https://developer.android.com/static/codelabs/basic-android-kotlin-training-shared-viewmodel/img/2ea8e000fb4e6ec8_1920.png?hl=zh-tw" width="30%">

<h4 id="設定-Lifecycle-owner-以觀察-LiveData"><a href="#設定-Lifecycle-owner-以觀察-LiveData" class="headerlink" title="設定 Lifecycle owner 以觀察 LiveData"></a>設定 Lifecycle owner 以觀察 LiveData</h4><p><a target="_blank" rel="noopener" href="https://developer.android.com/reference/androidx/lifecycle/LifecycleOwner"><code>LifecycleOwner</code></a> 是一個具有 Android lifecycle 的 class，例如 activity 或 fragment。唯有 lifecycle owner 處於 active 狀態 (<code>STARTED</code> 或 <code>RESUMED</code>)，<code>LiveData</code> observer 才會觀測 app data 的變更。</p>
<p>在 app 中，<code>LiveData</code> 物件或可觀察 data 是 view model 中的 <code>price</code> 屬性。lifecycle owners 是flavor、pickup 和 summary fragments。<code>LiveData</code> observers 是 layout 檔案中的 binding 運算式，當中包含可觀察 data，例如 price。透過 Data Binding，可觀察值(observable value)變更時，也會自動更新其 bind 的 UI elements。</p>
<p>binding 運算式範例：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">android:text=&quot;@&#123;@string/subtotal_price(viewModel.price)&#125;&quot;</span><br></pre></td></tr></table></figure>

<p>為了<span class="label primary">自動更新 UI elements</span>，您必須在 app 中<u>建立 <code>binding.lifecycleOwner</code> 與 <b>lifecycle owners</b> 的關聯</u>。</p>
<ol>
<li>在 <code>FlavorFragment</code>、<code>PickupFragment</code>、<code>SummaryFragment</code> class 的 <code>onViewCreated()</code> 方法中，在 <code>binding?.apply</code> 區塊中加入下列內容。這項操作會設定 binding 物件的 lifecycle owner。設定 lifecycle owner，app 將能觀察(observe) <code>LiveData</code> 物件。</li>
</ol>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">binding?.apply &#123;</span><br><span class="line">    lifecycleOwner = viewLifecycleOwner</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="2">
<li><p>再次執行應用程式。在 pickup 畫面中，變更取貨日期(pickup date)，並留意自動變更 price 方式的差異。且在 summary 畫面中正確反映取貨費用。</p>
</li>
<li><p>請注意，當您<u>選取當天取貨時，訂單價格會增加「$3.00 美元」</u>。<u>選取未來日期的價格應是「杯子蛋糕數量 x $2.00 美元」</u>。</p>
</li>
</ol>
<div style="display: flex;justify-content: center;">
    <div style="width:30%;float:left;margin-right:10px;">
        <img src="https://developer.android.com/static/codelabs/basic-android-kotlin-training-shared-viewmodel/img/905d8c8df1bfd5f2_1920.png?hl=zh-tw">
    </div>
    <div style="width:30%;float:left;">
        <img src="https://developer.android.com/static/codelabs/basic-android-kotlin-training-shared-viewmodel/img/7629d8a884304866_1920.png?hl=zh-tw">
    </div>
<div style="clear:both;"></div><!--這是用來清除上方的浮動效果-->
</div>

<ol start="4">
<li>使用不同杯子蛋糕 quantities、flavors 和 pickup dates 來測試不同情況。現在，您應該會在每個 fragment 上看到 view model 的更新 price。最棒的是，您不用撰寫額外的 Kotlin 程式碼，就能讓 UI 每次都更新 price。</li>
</ol>
<img src="https://developer.android.com/static/codelabs/basic-android-kotlin-training-shared-viewmodel/img/f4c0a3c5ea916d03_1920.png?hl=zh-tw" width="30%">

<p>如要完成 price 功能的導入，您必須將 price 格式設定為當地幣別。</p>
<h4 id="使用-LiveData-transformation-將-price-格式化"><a href="#使用-LiveData-transformation-將-price-格式化" class="headerlink" title="使用 LiveData transformation 將 price 格式化"></a>使用 LiveData transformation 將 price 格式化</h4><p><code>LiveData transformation</code> 方法可讓您針對 source <code>LiveData</code> 執行資料操縱，並傳回產生的 <code>LiveData</code> 物件。簡單來說，此會將 <code>LiveData</code> 的值轉換為其他值。除非 <code>observer</code> 觀測到 <code>LiveData</code> 物件，否則不會計算這些轉換。</p>
<p><a target="_blank" rel="noopener" href="https://developer.android.com/reference/androidx/lifecycle/Transformations.html#map(androidx.lifecycle.LiveData%3CX%3E,%20androidx.arch.core.util.Function%3CX,%20Y%3E)"><code>Transformations.map()</code></a> 其中一種是轉換函式，此方法採用 <code>LiveData</code> 和函式做為參數。函式會操控 source <code>LiveData</code>，並傳回可觀測的更新值。</p>
<p>以下列舉幾個可使用 LiveData transformation 的範例：</p>
<ul>
<li>設定 date、time strings 的顯示格式</li>
<li>排序 items 的 list</li>
<li>篩選 items 或將 items 分組</li>
<li>從 list 計算結果，例如所有 items 的加總、items 數目、傳回的最後一個 items 等等。</li>
</ul>
<p>在這項工作中，您必須使用 <code>Transformations.map()</code> 方法將設定 price 的格式為使用當地幣別。這會將原始價格從十進位(decimal)值 (<code>LiveData&lt;Double&gt;</code>) 轉換為字串(string)值 (<code>LiveData&lt;String&gt;</code>)。</p>
<ol>
<li>在 <code>OrderViewModel</code> class 中，將 backing property type 變更為 <code>LiveData&lt;String&gt;</code>，而不是 <code>LiveData&lt;Double&gt;</code>。price 的格式將為包含貨幣符號 (例如「<code>$</code>」) 的字串。您將在下一步驟修正初始化錯誤。</li>
</ol>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">val</span> _price = MutableLiveData&lt;<span class="built_in">Double</span>&gt;()</span><br><span class="line"><span class="keyword">val</span> price: LiveData&lt;String&gt;</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>使用 <code>Transformations.map()</code> 初始化新變數，並傳入 <code>_price</code> 和 <code>lambda</code> 函式。請在 <code>NumberFormat</code> class 中使用 <code>getCurrencyInstance()</code> 方法，以將 price 轉換成當地幣別格式(local currency format)。transformation code 看起來會像這樣。</li>
</ol>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">val</span> _price = MutableLiveData&lt;<span class="built_in">Double</span>&gt;()</span><br><span class="line"><span class="keyword">val</span> price: LiveData&lt;String&gt; = Transformations.map(_price) &#123;</span><br><span class="line">   NumberFormat.getCurrencyInstance().format(it)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>請 import <code>androidx.lifecycle.Transformations</code> 和 <code>java.text.NumberFormat</code>。</li>
</ul>
<ol start="3">
<li>執行應用程式。現在畫面上應會顯示 subtotal 及 total 的字串格式價格。更容易使用！</li>
</ol>
<img src="https://developer.android.com/static/codelabs/basic-android-kotlin-training-shared-viewmodel/img/1853bd13a07f1bc7_1920.png?hl=zh-tw">

<ol start="4">
<li>測試是否正常運作。測試範例：訂購一個杯子蛋糕、訂購六個杯子蛋糕、訂購 12 個杯子蛋糕。確認每個螢幕上的價格正確無誤。Flavor 和 Pickup fragments 中應顯示「Subtotal $2.00」，而 order summary 中應顯示「Total $2.00」。也請確認 order summary 顯示正確的 order details。</li>
</ol>
<hr>
<h3 id="使用-listener-binding-來設定-click-listeners"><a href="#使用-listener-binding-來設定-click-listeners" class="headerlink" title="使用 listener binding 來設定 click listeners"></a>使用 listener binding 來設定 click listeners</h3><p>在這項工作中，您將使用 <strong>listener binding</strong>  來將 <strong>fragment classes</strong> 中的 <strong>button click listeners</strong> bind 至 <strong>layout</strong>。</p>
<ol>
<li>在 layout 檔案 <code>fragment_start.xml</code> 中，新增名為 <code>startFragment</code> 且 type 為 <code>com.example.cupcake.StartFragment</code> 的 data variable。確認 fragment 的 package name 與應用程式的 package name 相符。</li>
</ol>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">layout</span> <span class="attr">...</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">data</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">variable</span></span></span><br><span class="line"><span class="tag">            <span class="attr">name</span>=<span class="string">&quot;startFragment&quot;</span></span></span><br><span class="line"><span class="tag">            <span class="attr">type</span>=<span class="string">&quot;com.example.cupcake.StartFragment&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">data</span>&gt;</span></span><br><span class="line">    ...</span><br><span class="line">    <span class="tag">&lt;<span class="name">ScrollView</span> <span class="attr">...</span>&gt;</span></span><br></pre></td></tr></table></figure>

<ol start="2">
<li>在 <code>StartFragment.kt</code> 的 <code>onViewCreated()</code> 方法中，將新的 <strong>data variable</strong> bind 至 <strong>fragment instance</strong>。您可以使用 <code>this</code> 關鍵字來存取 fragment 中的 fragment instance。移除 <code>binding?.apply</code> 區塊以及區塊內的程式碼。已完成的方法應如下所示。</li>
</ol>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onViewCreated</span><span class="params">(view: <span class="type">View</span>, savedInstanceState: <span class="type">Bundle</span>?)</span></span> &#123;</span><br><span class="line">    <span class="keyword">super</span>.onViewCreated(view, savedInstanceState)</span><br><span class="line">    binding?.startFragment = <span class="keyword">this</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>在 <code>fragment_start.xml</code> 中，使用 <strong>listener binding</strong> 新增 <strong>event listeners</strong> 到 <strong>button</strong> 的 <code>onClick</code> 屬性，在 <code>startFragment</code> 上呼叫 <code>orderCupcake()</code>，並傳遞杯子蛋糕的數量。</li>
</ol>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">Button</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:id</span>=<span class="string">&quot;@+id/order_one_cupcake&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:onClick</span>=<span class="string">&quot;@&#123;() -&gt; startFragment.orderCupcake(1)&#125;&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">...</span> /&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">Button</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:id</span>=<span class="string">&quot;@+id/order_six_cupcakes&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:onClick</span>=<span class="string">&quot;@&#123;() -&gt; startFragment.orderCupcake(6)&#125;&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">...</span> /&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">Button</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:id</span>=<span class="string">&quot;@+id/order_twelve_cupcakes&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:onClick</span>=<span class="string">&quot;@&#123;() -&gt; startFragment.orderCupcake(12)&#125;&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">...</span> /&gt;</span></span><br></pre></td></tr></table></figure>

<ol start="4">
<li><p>執行應用程式。請注意，start fragment 中的 button click handlers 運作正常。</p>
</li>
<li><p>同樣地，您也可以在其他 layouts 中加入上述 <strong>data variable</strong>，以便 bind <strong>fragment instance</strong> <code>fragment_flavor.xml</code>、<code>fragment_pickup.xml</code> 和 <code>fragment_summary.xml</code>。</p>
</li>
</ol>
<p>在 <code>fragment_flavor.xml</code> 中：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">layout</span> <span class="attr">...</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">data</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">variable</span></span></span><br><span class="line"><span class="tag">            <span class="attr">...</span> /&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">variable</span></span></span><br><span class="line"><span class="tag">            <span class="attr">name</span>=<span class="string">&quot;flavorFragment&quot;</span></span></span><br><span class="line"><span class="tag">            <span class="attr">type</span>=<span class="string">&quot;com.example.cupcake.FlavorFragment&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">data</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">ScrollView</span> <span class="attr">...</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>在 <code>fragment_pickup.xml</code> 中：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">layout</span> <span class="attr">...</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">data</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">variable</span></span></span><br><span class="line"><span class="tag">            <span class="attr">...</span> /&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">variable</span></span></span><br><span class="line"><span class="tag">            <span class="attr">name</span>=<span class="string">&quot;pickupFragment&quot;</span></span></span><br><span class="line"><span class="tag">            <span class="attr">type</span>=<span class="string">&quot;com.example.cupcake.PickupFragment&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">data</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">ScrollView</span> <span class="attr">...</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>在 <code>fragment_summary.xml</code> 中：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">layout</span> <span class="attr">...</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">data</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">variable</span></span></span><br><span class="line"><span class="tag">            <span class="attr">...</span> /&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">variable</span></span></span><br><span class="line"><span class="tag">            <span class="attr">name</span>=<span class="string">&quot;summaryFragment&quot;</span></span></span><br><span class="line"><span class="tag">            <span class="attr">type</span>=<span class="string">&quot;com.example.cupcake.SummaryFragment&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">data</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">ScrollView</span> <span class="attr">...</span>&gt;</span></span><br></pre></td></tr></table></figure>

<ol start="6">
<li><p>在其餘 fragment class 中的 <code>onViewCreated()</code> 中，刪除可手動設定 buttons 上 <strong>click listener</strong> 的程式碼。</p>
</li>
<li><p>在 <code>onViewCreated()</code> 方法中，會 bind <strong>fragment data variable</strong> 與 <strong>fragment instance</strong>。您必須在這裡以不同方式使用 <code>this</code> 關鍵字，因為在 <code>binding?.apply</code> 區塊中，關鍵字 <code>this</code> 是指 <strong>binding instance</strong>，而不是 <strong>fragment instance</strong>。使用 <code>@</code> 並明確指定 <strong>fragment class name</strong>，例如 <code>this@FlavorFragment</code>。已完成的 <code>onViewCreated()</code> 方法如下所示：</p>
</li>
</ol>
<p><code>FlavorFragment</code> class 中的 <code>onViewCreated()</code> method 應如下所示：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onViewCreated</span><span class="params">(view: <span class="type">View</span>, savedInstanceState: <span class="type">Bundle</span>?)</span></span> &#123;</span><br><span class="line">    <span class="keyword">super</span>.onViewCreated(view, savedInstanceState)</span><br><span class="line"></span><br><span class="line">    binding?.apply &#123;</span><br><span class="line">        lifecycleOwner = viewLifecycleOwner</span><br><span class="line">        viewModel = sharedViewModel</span><br><span class="line">        flavorFragment = <span class="keyword">this</span><span class="symbol">@FlavorFragment</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>PickupFragment</code> class 中的 <code>onViewCreated()</code> method 應如下所示：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onViewCreated</span><span class="params">(view: <span class="type">View</span>, savedInstanceState: <span class="type">Bundle</span>?)</span></span> &#123;</span><br><span class="line">   <span class="keyword">super</span>.onViewCreated(view, savedInstanceState)</span><br><span class="line"></span><br><span class="line">   binding?.apply &#123;</span><br><span class="line">       lifecycleOwner = viewLifecycleOwner</span><br><span class="line">       viewModel = sharedViewModel</span><br><span class="line">       pickupFragment = <span class="keyword">this</span><span class="symbol">@PickupFragment</span></span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在 <code>SummaryFragment</code> class method 中產生的 <code>onViewCreated()</code> method 應如下所示：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onViewCreated</span><span class="params">(view: <span class="type">View</span>, savedInstanceState: <span class="type">Bundle</span>?)</span></span> &#123;</span><br><span class="line">   <span class="keyword">super</span>.onViewCreated(view, savedInstanceState)</span><br><span class="line"></span><br><span class="line">   binding?.apply &#123;</span><br><span class="line">       lifecycleOwner = viewLifecycleOwner</span><br><span class="line">       viewModel = sharedViewModel</span><br><span class="line">       summaryFragment = <span class="keyword">this</span><span class="symbol">@SummaryFragment</span></span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="8">
<li>同樣地，在其他 layout 檔案中，新增 <strong>listener binding</strong> 運算式至 <strong>buttons</strong> 的 <code>onClick</code> 屬性。</li>
</ol>
<p>在 <code>fragment_flavor.xml</code> 中：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">Button</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:id</span>=<span class="string">&quot;@+id/next_button&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:onClick</span>=<span class="string">&quot;@&#123;() -&gt; flavorFragment.goToNextScreen()&#125;&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">...</span> /&gt;</span></span><br></pre></td></tr></table></figure>

<p>在 <code>fragment_pickup.xml</code> 中：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">Button</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:id</span>=<span class="string">&quot;@+id/next_button&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:onClick</span>=<span class="string">&quot;@&#123;() -&gt; pickupFragment.goToNextScreen()&#125;&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">...</span> /&gt;</span></span><br></pre></td></tr></table></figure>

<p>在 <code>fragment_summary.xml</code> 中：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">Button</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:id</span>=<span class="string">&quot;@+id/send_button&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:onClick</span>=<span class="string">&quot;@&#123;() -&gt; summaryFragment.sendOrder()&#125;&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">...</span>&gt;</span></span><br></pre></td></tr></table></figure>

<ol start="9">
<li>執行應用程式以驗證 <strong>buttons</strong> 是否正常運作。您應該不會發現行為變更，但已使用 <strong>listener bindings</strong> 設定 <strong>click listeners</strong>！</li>
</ol>
<p>恭喜您完成程式碼研究室，打造 Cupcake app！但是應用程式尚未處理完畢。在接下來的程式碼研究室中，您將新增 <b>Cancel</b> button 並修改<u>返回堆疊(backstack)</u>。您也會瞭解什麼是返回堆疊(backstack)和其他新主題。到時見！</p>
<hr>
<h3 id="總結"><a href="#總結" class="headerlink" title="總結"></a>總結</h3><ul>
<li><a target="_blank" rel="noopener" href="https://developer.android.com/topic/libraries/architecture/viewmodel?hl=zh-tw"><code>ViewModel</code></a> 是 <a target="_blank" rel="noopener" href="https://developer.android.com/topic/architecture">Android 架構元件</a> 的一部分，在設定變更期間會保留儲存在 <code>ViewModel</code> 中的應用程式資料。若要在應用程式中加入 <code>ViewModel</code>，請建立新 class，並從 <code>ViewModel</code> class extend 該 class。</li>
<li><a target="_blank" rel="noopener" href="https://developer.android.com/topic/libraries/architecture/viewmodel.html?hl=zh-tw#sharing">共用 <code>ViewModel</code></a> 會將應用程式的資料從多個 fragments 儲存在單一 <code>ViewModel</code> 中。應用程式中的多個 fragments 會使用其 activity 範圍(scope)來存取共用的 <code>ViewModel</code>。</li>
<li><a target="_blank" rel="noopener" href="https://developer.android.com/reference/androidx/lifecycle/LifecycleOwner"><code>LifecycleOwner</code></a> 是一個具有 Android 生命週期的 class，例如 activity 或 fragment。</li>
<li>唯有 lifecycle owner 處於 active 狀態 (<code>STARTED</code> 或 <code>RESUMED</code>)，<code>LiveData</code> observer 才會觀察應用程式 data 的變更。</li>
<li>Listener bindings 是指在事件發生時 (例如 <code>onClick</code> 事件) 執行的 lambda 運算式。做法類似於 method 引用 (例如 <code>textview.setOnClickListener(clickListener)</code>)，但 listener bindings 可讓您執行任意 data binding 運算式。</li>
<li><code>LiveData</code> transformation 方法可讓您針對 source <code>LiveData</code> 執行 data 操縱，並傳回產生的 <code>LiveData</code> 物件。</li>
<li>Android frameworks 提供了一個名為 <code>SimpleDateFormat</code> 的 class，該 class 會以區分地區設定方式來格式化(formatting)並剖析(parsing)日期。這允許進行 dates <u>格式化 (date → text)</u> 及<u>剖析 (text → date)</u>。</li>
</ul>

    </div>

    
    
    

      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/Android/" rel="tag"># Android</a>
              <a href="/tags/Kotlin/" rel="tag"># Kotlin</a>
              <a href="/tags/View-Binding/" rel="tag"># View Binding</a>
              <a href="/tags/UI-Controller/" rel="tag"># UI Controller</a>
              <a href="/tags/ViewModel/" rel="tag"># ViewModel</a>
              <a href="/tags/LiveData/" rel="tag"># LiveData</a>
              <a href="/tags/Observer/" rel="tag"># Observer</a>
              <a href="/tags/Data-Binding/" rel="tag"># Data Binding</a>
              <a href="/tags/MutableLiveData/" rel="tag"># MutableLiveData</a>
              <a href="/tags/Shared-ViewModel/" rel="tag"># Shared ViewModel</a>
              <a href="/tags/LifecycleOwner/" rel="tag"># LifecycleOwner</a>
              <a href="/tags/SimpleDateFormat/" rel="tag"># SimpleDateFormat</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2023/11/06/Android%E7%AD%86%E8%A8%98-27-%E6%90%AD%E9%85%8DViewModel%E4%BD%BF%E7%94%A8LiveData/" rel="prev" title="Android筆記(27)-搭配ViewModel使用LiveData">
      <i class="fa fa-chevron-left"></i> Android筆記(27)-搭配ViewModel使用LiveData
    </a></div>
      <div class="post-nav-item">
    <a href="/2023/11/14/Android%E7%AD%86%E8%A8%98-29-Navigation%E5%92%8Cback-stack/" rel="next" title="Android筆記(29)-Navigation和back stack">
      Android筆記(29)-Navigation和back stack <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%AF%84%E4%BE%8B%E6%87%89%E7%94%A8%E7%A8%8B%E5%BC%8F%E7%B8%BD%E8%A6%BD"><span class="nav-number">1.</span> <span class="nav-text">範例應用程式總覽</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%9D%AF%E5%AD%90%E8%9B%8B%E7%B3%95%E6%87%89%E7%94%A8%E7%A8%8B%E5%BC%8F%E7%B8%BD%E8%A6%BD"><span class="nav-number">1.1.</span> <span class="nav-text">杯子蛋糕應用程式總覽</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%B8%8B%E8%BC%89%E6%9C%AC%E7%A8%8B%E5%BC%8F%E7%A2%BC%E7%A0%94%E7%A9%B6%E5%AE%A4%E7%9A%84%E7%AF%84%E4%BE%8B%E7%A8%8B%E5%BC%8F%E7%A2%BC"><span class="nav-number">1.2.</span> <span class="nav-text">下載本程式碼研究室的範例程式碼</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%AF%84%E4%BE%8B%E7%A8%8B%E5%BC%8F%E7%A2%BC%E9%80%90%E6%AD%A5%E6%93%8D%E4%BD%9C%E8%AA%AA%E6%98%8E"><span class="nav-number">1.3.</span> <span class="nav-text">範例程式碼逐步操作說明</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AE%8C%E6%88%90%E5%B0%8E%E8%A6%BD%E5%9C%96-Navigation-Graph"><span class="nav-number">2.</span> <span class="nav-text">完成導覽圖(Navigation Graph)</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%9C%A8-navigation-graph-%E4%B8%AD%E9%80%A3%E6%8E%A5%E7%9B%AE%E7%9A%84%E5%9C%B0-destinations"><span class="nav-number">2.1.</span> <span class="nav-text">在 navigation graph 中連接目的地(destinations)</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%BE%9E-start-fragment-%E5%89%8D%E5%BE%80-flavor-fragment"><span class="nav-number">2.2.</span> <span class="nav-text">從 start fragment 前往 flavor fragment</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%9C%A8-flavor-%E5%92%8C-pickup-fragments-%E4%B8%AD%E6%96%B0%E5%A2%9E-Navigation"><span class="nav-number">2.3.</span> <span class="nav-text">在 flavor 和 pickup fragments 中新增 Navigation</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%9B%B4%E6%96%B0-app-bar-%E4%B8%AD%E7%9A%84%E6%A8%99%E9%A1%8C"><span class="nav-number">2.4.</span> <span class="nav-text">更新 app bar 中的標題</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%BB%BA%E7%AB%8B%E5%85%B1%E7%94%A8-ViewModel"><span class="nav-number">3.</span> <span class="nav-text">建立共用 ViewModel</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%BB%BA%E7%AB%8B-OrderViewModel"><span class="nav-number">3.1.</span> <span class="nav-text">建立 OrderViewModel</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E6%8E%A1%E7%94%A8-ViewModel-%E6%9C%80%E4%BD%B3%E5%81%9A%E6%B3%95"><span class="nav-number">3.1.1.</span> <span class="nav-text">採用 ViewModel 最佳做法</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8-ViewModel-%E6%9B%B4%E6%96%B0-UI"><span class="nav-number">4.</span> <span class="nav-text">使用 ViewModel 更新 UI</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E2%98%85%E6%9B%B4%E6%96%B0-StartFragment-%E5%8D%B3%E5%8F%AF%E4%BD%BF%E7%94%A8-view-model"><span class="nav-number">4.1.</span> <span class="nav-text">★更新 StartFragment 即可使用 view model</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8-Kotlin-property-delegate"><span class="nav-number">4.1.1.</span> <span class="nav-text">使用 Kotlin property delegate</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%90%AD%E9%85%8D%E4%BD%BF%E7%94%A8-ViewModel-%E8%88%87-data-binding"><span class="nav-number">5.</span> <span class="nav-text">搭配使用 ViewModel 與 data binding</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%94%A8%E4%BD%BF%E7%94%A8%E8%80%85%E7%9A%84%E9%81%B8%E6%93%87%E4%BE%86%E6%9B%B4%E6%96%B0-flavor"><span class="nav-number">5.1.</span> <span class="nav-text">用使用者的選擇來更新 flavor</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%A5%97%E7%94%A8-scope-%E5%87%BD%E5%BC%8F"><span class="nav-number">5.1.1.</span> <span class="nav-text">套用 scope 函式</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Listener-bindings"><span class="nav-number">5.2.</span> <span class="nav-text">Listener bindings</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%9B%B4%E6%96%B0-pickup-%E5%92%8C-summary-fragment-%E4%BB%A5%E4%BD%BF%E7%94%A8-view-model"><span class="nav-number">6.</span> <span class="nav-text">更新 pickup 和 summary fragment 以使用 view model</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%BB%BA%E7%AB%8B-pickup-options-list"><span class="nav-number">6.1.</span> <span class="nav-text">建立 pickup options list</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#Date-formatter"><span class="nav-number">6.1.1.</span> <span class="nav-text">Date formatter</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%9B%B4%E6%96%B0-layout-%E4%BB%A5%E9%A1%AF%E7%A4%BA-pickup-options"><span class="nav-number">6.2.</span> <span class="nav-text">更新 layout 以顯示 pickup options</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%9B%B4%E6%96%B0-summary-fragment-%E4%BB%A5%E4%BD%BF%E7%94%A8-view-model"><span class="nav-number">6.3.</span> <span class="nav-text">更新 summary fragment 以使用 view model</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%A0%B9%E6%93%9A-order-detail-%E8%A8%88%E7%AE%97-price"><span class="nav-number">7.</span> <span class="nav-text">根據 order detail 計算 price</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%9B%B4%E6%96%B0-view-model-%E4%B8%AD%E7%9A%84-price"><span class="nav-number">7.1.</span> <span class="nav-text">更新 view model 中的 price</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%B0%87-price-%E5%B1%AC%E6%80%A7-bind-%E5%88%B0-UI"><span class="nav-number">7.2.</span> <span class="nav-text">將 price 屬性 bind 到 UI</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%95%B6%E5%A4%A9%E5%8F%96%E8%B2%A8%E9%99%84%E5%8A%A0%E8%B2%BB"><span class="nav-number">7.3.</span> <span class="nav-text">當天取貨附加費</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%A8%AD%E5%AE%9A-Lifecycle-owner-%E4%BB%A5%E8%A7%80%E5%AF%9F-LiveData"><span class="nav-number">7.4.</span> <span class="nav-text">設定 Lifecycle owner 以觀察 LiveData</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8-LiveData-transformation-%E5%B0%87-price-%E6%A0%BC%E5%BC%8F%E5%8C%96"><span class="nav-number">7.5.</span> <span class="nav-text">使用 LiveData transformation 將 price 格式化</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8-listener-binding-%E4%BE%86%E8%A8%AD%E5%AE%9A-click-listeners"><span class="nav-number">8.</span> <span class="nav-text">使用 listener binding 來設定 click listeners</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%B8%BD%E7%B5%90"><span class="nav-number">9.</span> <span class="nav-text">總結</span></a></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Tina Tang"
      src="/images/blog_photo.png">
  <p class="site-author-name" itemprop="name">Tina Tang</p>
  <div class="site-description" itemprop="description">^(-o-)></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">37</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">7</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">87</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/linglingdr00" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;linglingdr00" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:tinatang0424@gmail.com" title="E-Mail → mailto:tinatang0424@gmail.com" rel="noopener" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2023</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Tina Tang</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://pisces.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Pisces</a>
  </div><script color="0,0,255" opacity="0.5" zIndex="-1" count="99" src="https://cdn.jsdelivr.net/npm/canvas-nest.js@1/dist/canvas-nest.js"></script>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="//cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script>
  <script src="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  




  
<script src="/js/local-search.js"></script>













  

  

</body>
</html>
